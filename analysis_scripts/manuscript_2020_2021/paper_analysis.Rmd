---
title: "manuscript_analysis"
author: "Jojo Hu"
date: "12/03/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Manuscript Analysis 2020 Behavioral Analysis (12/03/2020)


``` {r}
setwd("my_path/bucld_2019_followup")

drive_checklist <-
  read.csv("my_path/bucld_2019_followup/drive_checklist.csv") 
```

# To Do: automate calculation for web-based age 


#Clean Data
```{r,echo=FALSE}
#Read in demographic data
demo_all <- read.csv("my_path/bucld_2019_followup/online_demo_all.csv")
#Read in adult demographic data
demo_adult <- read.csv("my_path/bucld_2019_followup/adult_demo.csv")
#Read in GJT data 
gjt <- read.csv("my_path/bucld_2019_followup/gjt_score.csv")
#Read in analyzed behavioral data
bucld_blast_data_list <- 
  list.files(path = "my_path/bucld_2019_followup",
             pattern = "*blast_all.csv", full.names = T)

bucld_spoli_data_list <-
  list.files(path = "my_path/bucld_2019_followup",
             pattern = "*spoli_all.csv", full.names = T)

adult_data_list <-
  list.files(path = "my_path/bucld_2019_followup",
             pattern = "*adult.csv", full.names = T)

bucld_blast_data <- lapply(bucld_blast_data_list, read.csv)

bucld_spoli_data <- lapply(bucld_spoli_data_list, read.csv)

adult_data <- lapply(adult_data_list, read.csv)

#Seperate mean rt and rt slope data into two dataframes
bucld_blast_data[[4]] <- bucld_blast_data[[3]][,c("X", "par_id", "mean_rt", "task")]
bucld_blast_data[[5]] <- bucld_blast_data[[3]][,c("X", "par_id", "scaled_rt_slope", "task")]

bucld_spoli_data[[4]] <- bucld_spoli_data[[3]][,c("X", "par_id", "mean_rt", "task")]
bucld_spoli_data[[5]] <- bucld_spoli_data[[3]][,c("X", "par_id", "scaled_rt_slope", "task")]

adult_data[[4]] <- adult_data[[3]][,c("X", "par_id", "mean_rt", "task")]
adult_data[[5]] <- adult_data[[3]][,c("X", "par_id", "scaled_rt_slope", "task")]

#Rbind Blast and Spoli data for each measure------------------------------------------------------------------------------
blast_spoli_data <- list()

for (i in 1:length(bucld_blast_data)) {
blast_spoli_data[[i]] <- 
 rbind(bucld_blast_data[[i]], bucld_spoli_data[[i]], adult_data[[i]])
}
#Select only Accuracy data, reformat column names and add in which measure it is into a new column
blast_spoli_acc <- blast_spoli_data[[1]][,c("X", "acc_id", "subj_corr", "task")]
blast_spoli_acc$measure <- "accuracy"
colnames(blast_spoli_acc)[colnames(blast_spoli_acc) == "subj_corr"] <- "value"
colnames(blast_spoli_acc)[colnames(blast_spoli_acc) == "acc_id"] <- "part_id"

#Select only Entropy data, reformat column names and add in which measure it is into a new column
blast_spoli_entropy <- blast_spoli_data[[2]][,c("X", "part_id", "mean_entropy", "task")]
blast_spoli_entropy$measure <- "entropy"
colnames(blast_spoli_entropy)[colnames(blast_spoli_entropy) == "mean_entropy"] <- "value"

#Select only Mean RT data, reformat column names and add in which measure it is into a new column
library("stringr")

blast_spoli_rt <- blast_spoli_data[[4]][,c("X", "par_id", "mean_rt", "task")]
blast_spoli_rt$measure <- "rt"

blast_spoli_rt$par_id <- as.character(blast_spoli_rt$par_id)

blast_spoli_rt[which(str_detect(blast_spoli_rt$task, "children_lsl_indiv_rts|adult_lsl_indiv_rts")), "par_id"] <-
  str_extract(blast_spoli_rt[which(str_detect(
    blast_spoli_rt$task, "children_lsl_indiv_rts|adult_lsl_indiv_rts")), "par_id"], "\\S+(?=_lsl)")
  
colnames(blast_spoli_rt)[colnames(blast_spoli_rt) == "mean_rt"] <- "value"
colnames(blast_spoli_rt)[colnames(blast_spoli_rt) == "par_id"] <- "part_id"

#Select only RT Slope data, reformat column names and add in which measure it is into a new column
blast_spoli_slope <- blast_spoli_data[[5]][,c("X", "par_id", "scaled_rt_slope", "task")]
blast_spoli_slope$measure <- "slope"

blast_spoli_slope$par_id <- as.character(blast_spoli_slope$par_id)

blast_spoli_slope[which(
  str_detect(blast_spoli_slope$task, "children_lsl_indiv_rts|adult_lsl_indiv_rts")), "par_id"] <-
  str_extract(blast_spoli_slope[which(str_detect(blast_spoli_slope$task, "children_lsl_indiv_rts|adult_lsl_indiv_rts")), "par_id"], "\\S+(?=_lsl)")

blast_spoli_slope$task <- paste0(blast_spoli_slope$task, "_slope")

colnames(blast_spoli_slope)[colnames(blast_spoli_slope) == "scaled_rt_slope"] <- "value"
colnames(blast_spoli_slope)[colnames(blast_spoli_slope) == "par_id"] <- "part_id"

#Format GJT data
gjt$measure <- "gjt_std_score"
gjt$task <- "gjt_web"
gjt$X <- seq(from = 1, to = length(gjt$part_id), by = 1)
colnames(gjt)[colnames(gjt) == "standard_score"] <- "value"

blast_spoli_gjt <- gjt[,c("X", "part_id", "value", "task", "measure")]

#Rbind all measures into long form
blast_spoli_data_long <- rbind(blast_spoli_acc, blast_spoli_entropy, blast_spoli_rt, blast_spoli_slope, blast_spoli_gjt)

blast_spoli_data_long$value <- as.numeric(as.character(blast_spoli_data_long$value))
```

## All behavioral data prep

## Create a wide format of the concatenated data
```{r}
#Make all measures into wide form by participant and measure
library("reshape")
library("data.table")
library("dplyr")

blast_adult_long <- blast_spoli_data_long[which(str_detect(blast_spoli_data_long$part_id, "blast_a")),]

blast_adult_wide <- cast(blast_adult_long, part_id~measure+task)

blast_spoli_child_long <- blast_spoli_data_long[which(str_detect(blast_spoli_data_long$part_id,
                                                                 "blast_c|spoli_c")),]

blast_spoli_data_wide <- cast(blast_spoli_child_long, part_id~measure+task)

# qp_subj <- read.csv("qp_subj.csv")
# 
# blast_spoli_data_wide <- blast_spoli_data_wide[which(blast_spoli_data_wide$part_id %in% qp_subj$part_id),]

# Remove blast_c_081 (consented, excluded, nonverbal)
if(length(which(blast_spoli_data_wide$part_id %in% "blast_c_081")) != 0) {
blast_spoli_data_wide <-
  blast_spoli_data_wide[-which(
    blast_spoli_data_wide$part_id %in% "blast_c_081"),] 
}

```

# Merge demographic data for children
```{r, include = F}

#Extract relevant demo information
gender_group_info <- demo_all[,c("part_id", "group", "gender", "age_at_web_month", "age_at_web_year")]
#Merge all demo data with sl measures
blast_spoli_data_wide <-
  merge(gender_group_info, blast_spoli_data_wide,
      by.x = "part_id", by.y = "part_id",
      all.y = TRUE)
 

blast_spoli_data_wide$accuracy_children_lsl_random_2afc_accuracies <-
as.numeric(as.character(blast_spoli_data_wide$accuracy_children_lsl_random_2afc_accuracies))

blast_spoli_data_wide$accuracy_lsl_predictable_2afc_accuracies <-
as.numeric(as.character(blast_spoli_data_wide$accuracy_lsl_predictable_2afc_accuracies))

blast_spoli_data_wide$entropy_children_lsl_predictable_entropy <-
as.numeric(as.character(blast_spoli_data_wide$entropy_children_lsl_predictable_entropy))

blast_spoli_data_wide$entropy_children_lsl_randomized_entropy <-
as.numeric(as.character(blast_spoli_data_wide$entropy_children_lsl_randomized_entropy))


blast_spoli_data_wide$accuracy_children_lsl_accuracies <-
  coalesce(blast_spoli_data_wide$accuracy_children_lsl_random_2afc_accuracies,
           blast_spoli_data_wide$accuracy_lsl_predictable_2afc_accuracies)


blast_spoli_data_wide$entropy_children_lsl_entropy <-
  coalesce(blast_spoli_data_wide$entropy_children_lsl_predictable_entropy,
           blast_spoli_data_wide$entropy_children_lsl_randomized_entropy)

ineligible_part_spoli <- blast_spoli_data_wide[which(blast_spoli_data_wide$age_at_web_year > 13 | blast_spoli_data_wide$age_at_web_year <5.5),] 
blast_spoli_data_wide <- blast_spoli_data_wide[-which(blast_spoli_data_wide$age_at_web_year > 13 | blast_spoli_data_wide$age_at_web_year <5.5),] 


print(ineligible_part_spoli[,c("part_id", "group", "age_at_web_year")])
```
**Above are ineligible participants.**

# Merge demographic data and assessment data for adults 
(Adult ages were calculated from EEG data collection date as EEG was collected almost simultaneously as web SL data)
(SCQ not collected for adults)
```{r, include = F}
demo_adult <- read.csv("my_path/bucld_2019_followup/adult_demo.csv")

demo_adult <- demo_adult[,c("Participant.ID", "Group", "Gender", "Age", "date.of.birth", "date_eeg_collection", 
                            "kbit_matrices_raw", "kbit_matrices_std")]

colnames(demo_adult) <- c("part_id", "group", "gender", "age_at_web_month", "dob", "date_eeg_collection",
                          "kbit_matrices_raw", "kbit_matrices_std")

demo_adult$age_at_web_year <- demo_adult$age_at_web_month/12

blast_adult_wide <-
  merge(demo_adult, blast_adult_wide,
      by.x = "part_id", by.y = "part_id",
      all.y = TRUE)


blast_adult_wide[,which(str_detect(colnames(blast_adult_wide), 
                                            "accuracy|slope|entropy|indiv_rts|age|kbit"))] <- 
  lapply(blast_adult_wide[,which(str_detect(colnames(blast_adult_wide), 
                                            "accuracy|slope|entropy|indiv_rts|age|kbit"))], 
         function(x) {
           if (is.factor(x))
             as.numeric(as.character(x))
           else 
             x
           })

blast_adult_wide$accuracy_adult_lsl_accuracies <-
  coalesce(blast_adult_wide$accuracy_adult_lsl_predictable_2afc_accuracies,
           blast_adult_wide$accuracy_adult_lsl_random_2afc_accuracies)


blast_adult_wide$entropy_adult_lsl_entropy <-
  coalesce(blast_adult_wide$entropy_adult_lsl_predictable_entropy,
           blast_adult_wide$entropy_adult_lsl_randomized_entropy)
```

# Merge assessment data for children (more data prep for children)
```{r, include = FALSE}
#Extract participants that have SOME SL task completed
bucld_all_completed <- 
  blast_spoli_data_wide[which( 
         blast_spoli_data_wide$accuracy_children_tsl_accuracies != "" |
         blast_spoli_data_wide$accuracy_children_ssl_accuracies != "" |
         blast_spoli_data_wide$accuracy_children_vsl_accuracies != "" |
         blast_spoli_data_wide$accuracy_children_lsl_accuracies != ""),]

#Remove blast_c_011 who has not given consent, cannot analyze. 198 has no demo info and has only one SL task completed
# bucld_all_completed <- bucld_all_completed[-which(bucld_all_completed$part_id == "blast_c_011"),]

bucld_all_completed <-
  bucld_all_completed[-which(bucld_all_completed$part_id == "blast_c_198"), ]

# Add group info for blast_c_224, redcap is not updated. Only TD with this ID has data.
bucld_all_completed[which(bucld_all_completed$part_id == "blast_c_224"), "group"] <- "TD"

# bucld_all_completed <-
#   merge(bucld_all_completed, bucld_scq_web,
#       by.x = "part_id", by.y = "part_id",
#       all.x = TRUE)


in_lab_assessment <-
  drive_checklist[,c("Participant.ID", "kbit_matrices_raw", "kbit_matrices_std", "scq_total")]


bucld_all_completed <-
  merge(bucld_all_completed, in_lab_assessment,
      by.x = "part_id", by.y = "Participant.ID",
      all.x = TRUE)

gjt_original_file <- read.csv("my_path/bucld_2019_followup/gjt_score.csv")

bucld_all_completed <-
  merge(bucld_all_completed, gjt_original_file[,c("part_id", "a_prime")],
      by.x = "part_id", by.y = "part_id",
      all.x = TRUE)


bucld_all_completed <-
  merge(bucld_all_completed, demo_all[,c("part_id", "scq_web", "scq_web_age")],
      by.x = "part_id", by.y = "part_id",
      all.x = TRUE)


bucld_all_completed[,which(str_detect(colnames(bucld_all_completed), 
                                            "accuracy|slope|entropy|indiv_rts|age|kbit|scq"))] <- 
  lapply(bucld_all_completed[,which(str_detect(colnames(bucld_all_completed), 
                                            "accuracy|slope|entropy|indiv_rts|age|kbit|scq"))], 
         function(x) {
           if (is.factor(x))
             as.numeric(as.character(x))
           else 
             x
           })
```

# RSR Clean
```{r}
rsrh <- read.csv("rsr_home.csv")
rsrlab <- read.csv("rsr_lab.csv")
  
rsrh[,c(3:4)] <- 
  lapply(rsrh[,c(3:4)], function(x) {
  if (is.factor(x))
    as.numeric(as.character(x))
  else
    x
})

colnames(rsrh)[3:4] <- c("rsr_home_raw", "rsr_home_standard")

rsrlab[,c(3:4)] <- 
  lapply(rsrlab[,c(3:4)], function(x) {
  if (is.factor(x))
    as.numeric(as.character(x))
  else
    x
})

colnames(rsrlab)[3:4] <- c("rsr_lab_raw", "rsr_lab_standard")

rsr <- merge(rsrh[,c(1,3,4)], rsrlab[,c(1,3,4)], all = T)

# Merge RSR scores from the drive checklist
drive_rsr <- drive_checklist[,c("Participant.ID", "rsr_home_raw", "rsr_home_standard", "rsr_lab_raw", "rsr_lab_standard")]

drive_rsr[,c(2:5)] <- 
  lapply(drive_rsr[,c(2:5)], function(x) {
  if (is.factor(x))
    as.numeric(as.character(x))
  else
    x
})


colnames(drive_rsr)[which(colnames(drive_rsr) == "Participant.ID")] <- "participant.id"

# # write.csv(drive_rsr, "RA_check_RSR_entry_drive.csv")

# Check whether the drive entries for RSR are correct. Some do not seem to be accurate. If correct, will use merge instead of manual adding below.
rd <- drive_rsr[which(drive_rsr$participant.id %in% 
                        setdiff(drive_rsr$participant.id, rsr$participant.id)),]

rsr <-rbind(rsr, rd)

rsr <- 
  rsr[-which( 
         is.na(rsr$rsr_home_raw)  &
         is.na(rsr$rsr_home_standard) &
         is.na(rsr$rsr_lab_raw) &
         is.na(rsr$rsr_lab_standard)),]

# How many RSR in total?
rsr_total <- nrow(rsr)

# write.csv(rsr, "my_path/bucld_2019_followup/rsr_all.csv")

bucld_all_completed <- 
  merge(bucld_all_completed, rsr, by.x = "part_id", by.y = "participant.id", all.x = TRUE)

# How many people have RSR
bucld_all_completed$rsr_raw <- coalesce(bucld_all_completed$rsr_home_raw, bucld_all_completed$rsr_lab_raw)
bucld_all_completed$rsr_std <- coalesce(bucld_all_completed$rsr_home_standard, bucld_all_completed$rsr_lab_standard)
# When there are 2 scores from both home and lab, home is prioritized as more people have rsr from home

rsr_td_count <-
  length(which(!is.na(bucld_all_completed$rsr_raw) & bucld_all_completed$group == "TD"))

rsr_asd_count <-
  length(which(!is.na(bucld_all_completed$rsr_raw) & bucld_all_completed$group == "ASD"))

# How many people have RSR from Home
rsrh_td <-
  length(which(!is.na(bucld_all_completed$rsr_home_raw) & bucld_all_completed$group == "TD"))

rsrh_asd <-
  length(which(!is.na(bucld_all_completed$rsr_home_raw) & bucld_all_completed$group == "ASD"))

gjt_total <- read.csv("gjt_score.csv")
gjt_total <- length(which(!is.na(gjt_total$a_prime)))
gjt_td_count <- length(which(!is.na(bucld_all_completed$a_prime) & bucld_all_completed$group == "TD"))
gjt_asd_count <- length(which(!is.na(bucld_all_completed$a_prime) & bucld_all_completed$group == "ASD"))
```
Total number of scored RSR: `r rsr_total`

All Usable RSR (home + lab) count (SL also completed): ASD: `r rsr_asd_count`; TD: `r rsr_td_count`

Usable RSR done at home count: TD: `r rsrh_td`

Usable RSR done at home count: ASD: `r rsrh_asd`

Total number of completed GJT: `r gjt_total`

Usable GJT count (SL also completed): ASD: `r gjt_asd_count`; TD: `r gjt_td_count`

# Children Gender Chi-square
```{r}
bucld_all_completed_gender_wide <- bucld_all_completed[,c("part_id", "group", "gender")]

nrow(bucld_all_completed_gender_wide)

bucld_all_completed_gender_long <- melt(bucld_all_completed_gender_wide, id.vars = c("part_id", "group"))

gender_wide <- cast(bucld_all_completed_gender_long, group~value, length)

# Chi-square on gender
# p<0.05 tells us that they are not matched for gender between group
print(gender_wide)

print(chisq.test(gender_wide))

bucld_all_completed[,c("part_id", "group")]
```
Gender is NOT matched between group.

# Adult Gender Chi-square
```{r}
adult_gender <- blast_adult_wide[,c("part_id", "group", "gender")]

adult_gender <- melt(adult_gender, id.vars = c("part_id", "group"))

gender_wide_adult <- cast(adult_gender, group~value, length)

# Chi-square on gender
# p<0.05 tells us that they are not matched for gender between group
print(gender_wide_adult)

print(chisq.test(gender_wide_adult))

blast_adult_wide[,c("part_id", "group")]
```


# Gender matched between groups in children, all analysis below changes
```{r}
# Pull out participants with more tasks
task_count <-
apply(bucld_all_completed[c("accuracy_children_tsl_accuracies",
                            "accuracy_children_ssl_accuracies",
                            "accuracy_children_vsl_accuracies",
                            "accuracy_children_lsl_accuracies" 
                            # "rsr_raw", "a_prime"
                            )], 1, function(x) {
                              sum(!is.na(x)) })

bucld_all_completed <- cbind(bucld_all_completed, task_count)

bucld_all_completed <- 
  bucld_all_completed[-which(bucld_all_completed$task_count < 3),]

bucld_all_completed <- 
  bucld_all_completed[ , !(names(bucld_all_completed) %in% "task_count")]

#get pair match with minimized mean paired distance, with non-overlapping pairs. Unmatch-able pts will be removed.
library(optmatch)
library(RItools)
library(plyr)


bucld_all_completed$genderN <- 
  plyr::mapvalues(bucld_all_completed$gender, from=c("M", "F"), to=c(0, 1))

bucld_all_completed$groupN <- 
  plyr::mapvalues(bucld_all_completed$group, from=c("ASD", "TD"), to=c(0, 1))




bucld_all_completed[,c("age_at_web_year", "groupN", "genderN")] <- 
  lapply(bucld_all_completed[,c("age_at_web_year", "groupN", "genderN")], 
         function(x) {
  if (is.factor(x))
    as.numeric(as.character(x))
  else
    x
})


table(bucld_all_completed$groupN) #0: ASD; 1: TD 
table(bucld_all_completed$genderN) #0: F; 1: M 

bucld_all_completed$genderN <- as.numeric(as.character(bucld_all_completed$genderN))

library(MatchIt)

matchit <-
  matchit(groupN ~  age_at_web_year + genderN,
         data = bucld_all_completed, method="nearest",
          caliper = c(0.94),
          caliper.std = c(FALSE, FALSE),
          mahvars = ~  age_at_web_year + genderN)


        
m.data1 <- match.data(matchit, data = bucld_all_completed, distance = "prop.score")

m.data2 <- m.data1[,c("part_id", "group", "gender", "age_at_web_year", "groupN", "genderN")]

m.data2ASD <- subset(m.data2, group == "ASD")
m.data2TD <- subset(m.data2, group == "TD")

t.test(m.data2ASD$age_at_web_year, m.data2TD$age_at_web_year)

m.data2L <- melt(m.data2[,c("part_id", "group", "gender")], id.vars = c("part_id", "group"))
m.data2W <- cast(m.data2L, group~value)

chisq.test(m.data2W)

bucld_all_completed <- bucld_all_completed[,-which(colnames(bucld_all_completed) %in% "groupN")]
bucld_all_completed <- bucld_all_completed[,-which(colnames(bucld_all_completed) %in% "genderN")]

bucld_all_completed <-
  bucld_all_completed[which(bucld_all_completed$part_id %in% m.data2$part_id),]
```

# Gender chi.square in matched dataset
```{r}
bucld_all_completed_gender_wide <- bucld_all_completed[,c("part_id", "group", "gender")]

bucld_all_completed_gender_long <- melt(bucld_all_completed_gender_wide, id.vars = c("part_id", "group"))

gender_wide <- cast(bucld_all_completed_gender_long, group~value, length)


# Chi-square on gender
# p<0.05 tells us that they are not matched for gender between group
print(gender_wide)

print(chisq.test(gender_wide))
```

**Gender is NOT matched between group**

## Age difference between group
```{r}
td_age <- 
  bucld_all_completed[which(bucld_all_completed$group == "TD"), 
                       c("part_id", "group", "age_at_web_year")]


asd_age <- 
  bucld_all_completed[which(bucld_all_completed$group == "ASD"), 
                       c("part_id", "group", "age_at_web_year")]


library("pastecs")
td_age_descrip_stat <- stat.desc(td_age)
td_age_descrip_stat <- td_age_descrip_stat[c("nbr.val","mean", "std.dev", "max", "min"),"age_at_web_year"]
td_age_descrip_stat <- data.frame(td_age_descrip_stat)
td_age_descrip_stat <- cbind(c("n","mean", "std.dev", "max", "min"), td_age_descrip_stat)
td_age_descrip_stat <- t(td_age_descrip_stat)

asd_age_descrip_stat <- stat.desc(asd_age)
asd_age_descrip_stat <- asd_age_descrip_stat[c("nbr.val","mean", "std.dev", "max", "min"),"age_at_web_year"]
asd_age_descrip_stat <- data.frame(asd_age_descrip_stat)
asd_age_descrip_stat <- cbind(c("n","mean", "std.dev", "max", "min"), asd_age_descrip_stat)
asd_age_descrip_stat <- t(asd_age_descrip_stat)

age_descrip_stat <- rbind(td_age_descrip_stat, asd_age_descrip_stat)

#Test age difference between group, p <0.05 means age is significantly different between group
print(t.test(td_age$age_at_web_year, asd_age$age_at_web_year))

age_pvalue <- t.test(td_age$age_at_web_year, asd_age$age_at_web_year)

age_descrip_stat <- rbind(age_descrip_stat, age_pvalue$p.value)

age_descrip_stat[c(2,4),] <- round(as.numeric(as.character(age_descrip_stat[c(2,4),])),2)


# write.csv(age_descrip_stat, "paper_analysis_matched/age_descrip_stat.csv")
```

**Note that in this version the age of blast_c_267 is 121 months instead of 120 months; and thus the mean age of TD will be slightly different from the next versions**

```{r}
# check_age <- read.csv("my_path/bucld_2019_followup/online_demo_all_deidentified_12_03_2020.csv")
# 
# new_age <- check_age[which(check_age$part_id %in% bucld_all_completed$part_id),]
# 
# new_age$part_id <- as.character(new_age$part_id)
# 
# new_age <- new_age[order(new_age$part_id),]
# 
# which(new_age$part_id != bucld_all_completed$part_id)
# new_age[which(new_age$age_at_web_month != bucld_all_completed$age_at_web_month),"part_id"]
# bucld_all_completed[which(new_age$age_at_web_month != bucld_all_completed$age_at_web_month),"part_id"]
```

# Remove outliers for accuracy (no outlier is removed, criteria < 0 accuracy)
```{r, include = F}
#Remove outliners for accuracy data
ssl_accurarcy_outlier <-
bucld_all_completed[which(bucld_all_completed$accuracy_children_ssl_accuracies < 0), "part_id"]

tsl_accurarcy_outlier <-
bucld_all_completed[which(bucld_all_completed$accuracy_children_tsl_accuracies < 0), "part_id"]

vsl_accurarcy_outlier <-
bucld_all_completed[which(bucld_all_completed$accuracy_children_vsl_accuracies < 0), "part_id"]

lsl_accurarcy_outlier <-
bucld_all_completed[which(bucld_all_completed$accuracy_children_lsl_accuracies < 0), "part_id"]

if(length(ssl_accurarcy_outlier) != 0) {
  bucld_all_completed[which(
    bucld_all_completed$part_id %in% ssl_accurarcy_outlier),
  c("accuracy_children_ssl_accuracies")] <- NA
}


if(length(tsl_accurarcy_outlier) != 0) {
  bucld_all_completed[which(
    bucld_all_completed$part_id %in% tsl_accurarcy_outlier),
  c("accuracy_children_tsl_accuracies")] <- NA
}


if(length(vsl_accurarcy_outlier) != 0) {
  bucld_all_completed[which(
    bucld_all_completed$part_id %in% vsl_accurarcy_outlier),
  c("accuracy_children_vsl_accuracies")] <- NA
}


if(length(lsl_accurarcy_outlier) != 0) {
  bucld_all_completed[which(
    bucld_all_completed$part_id %in% lsl_accurarcy_outlier),
  c("accuracy_children_lsl_accuracies")] <- NA
}
```



# Remove outliers for RT and RT slope 
```{r, include = F}
ssl_rt_hit_count <- read.csv("ssl_rt_hit_trial_count.csv")
tsl_rt_hit_count <- read.csv("tsl_rt_hit_trial_count.csv")
vsl_rt_hit_count <- read.csv("vsl_rt_hit_trial_count.csv")
lsl_rt_hit_count <- read.csv("lsl_rt_hit_trial_count.csv")


ssl_rt_hit_count$task <- "ssl"
tsl_rt_hit_count$task <- "tsl"
vsl_rt_hit_count$task <- "vsl"
lsl_rt_hit_count$task <- "lsl"

all_rt_hit_count <- 
  rbind(ssl_rt_hit_count,
      tsl_rt_hit_count,
      vsl_rt_hit_count,
      lsl_rt_hit_count)

rt_hit_count_adult <- all_rt_hit_count[which(str_detect(all_rt_hit_count$part_id, "blast_a_")),]

rt_hit_count_child <- all_rt_hit_count[which(str_detect(
  all_rt_hit_count$part_id, "blast_c_|spoli_c")),]

rt_hit_count_child <- rt_hit_count_child[which(rt_hit_count_child$part_id %in%
                                                 bucld_all_completed$part_id),]

adult_rt_outlier <- rt_hit_count_adult[which(rt_hit_count_adult$hit_trial_number < 6), 
                   c("part_id", "task")]

child_rt_outlier <- rt_hit_count_child[which(rt_hit_count_child$hit_trial_number < 6), 
                   c("part_id", "task")]
```

```{r}
rt_hit_count_adult[which(rt_hit_count_adult$hit_trial_number < 6), 
                   c("part_id", "task", "hit_trial_number")]
```
**Table above are RT outliers in adults with less than 6 hit trials in the exposure phase**


```{r}
rt_hit_count_child[which(rt_hit_count_child$hit_trial_number < 6), 
                   c("part_id", "task", "hit_trial_number")]
```
**Table above are RT outliers in children with less than 6 hit trials in the exposure phase**


```{r, include = F}
outlier_extract <-
  function(DF, task) {
    part_id <- DF[which(DF$task == task), "part_id"]
    return(part_id)
  }

ssl_rt_outlierA <- outlier_extract(adult_rt_outlier, "ssl")
tsl_rt_outlierA <- outlier_extract(adult_rt_outlier, "tsl")
vsl_rt_outlierA <- outlier_extract(adult_rt_outlier, "vsl")
lsl_rt_outlierA <- outlier_extract(adult_rt_outlier, "lsl")

if(length(ssl_rt_outlierA) != 0) {
  blast_adult_wide[which(
    blast_adult_wide$part_id %in% ssl_rt_outlierA),
    c("slope_adult_ssl_indiv_rts_slope",
      "rt_adult_ssl_indiv_rts")] <- NA
}

if(length(tsl_rt_outlierA) != 0) {
  blast_adult_wide[which(
    blast_adult_wide$part_id %in% tsl_rt_outlierA),
    c("slope_adult_tsl_indiv_rts_slope",
      "rt_adult_tsl_indiv_rts")] <- NA
}

if(length(vsl_rt_outlierA) != 0) {
  blast_adult_wide[which(
    blast_adult_wide$part_id %in% vsl_rt_outlierA),
    c("slope_adult_vsl_indiv_rts_slope",
      "rt_adult_vsl_indiv_rts")] <- NA
}

if(length(lsl_rt_outlierA) != 0) {
  blast_adult_wide[which(
    blast_adult_wide$part_id %in% lsl_rt_outlierA),
    c("slope_adult_lsl_indiv_rts_slope",
      "rt_adult_lsl_indiv_rts")] <- NA
}
```

# To Do: simplify script for the removal of outliers in the children group
```{r, include = F}

ssl_rt_hit_count <- 
  ssl_rt_hit_count[which(ssl_rt_hit_count$part_id %in% bucld_all_completed$part_id),]
tsl_rt_hit_count <- 
  tsl_rt_hit_count[which(tsl_rt_hit_count$part_id %in% bucld_all_completed$part_id),]
vsl_rt_hit_count <- 
  vsl_rt_hit_count[which(vsl_rt_hit_count$part_id %in% bucld_all_completed$part_id),]
lsl_rt_hit_count <- 
  lsl_rt_hit_count[which(lsl_rt_hit_count$part_id %in% bucld_all_completed$part_id),]

ssl_rt_outlier <- ssl_rt_hit_count[which(ssl_rt_hit_count$hit_trial_number < 6), "part_id"]
tsl_rt_outlier <- tsl_rt_hit_count[which(tsl_rt_hit_count$hit_trial_number < 6), "part_id"]
vsl_rt_outlier <- vsl_rt_hit_count[which(vsl_rt_hit_count$hit_trial_number < 6), "part_id"]
lsl_rt_outlier <- lsl_rt_hit_count[which(lsl_rt_hit_count$hit_trial_number < 6), "part_id"]


if(length(ssl_rt_outlier) != 0) {
  bucld_all_completed[which(
    bucld_all_completed$part_id %in% ssl_rt_outlier),
  c("rt_children_ssl_indiv_rts",
    "slope_children_ssl_indiv_rts_slope")] <- NA
}


if(length(tsl_rt_outlier) != 0) {
  bucld_all_completed[which(
    bucld_all_completed$part_id %in% tsl_rt_outlier),
  c("rt_children_tsl_indiv_rts",
    "slope_children_tsl_indiv_rts_slope")] <- NA
}


if(length(vsl_rt_outlier) != 0) {
  bucld_all_completed[which(
    bucld_all_completed$part_id %in% vsl_rt_outlier),
    c("rt_children_vsl_indiv_rts",
      "slope_children_vsl_indiv_rts_slope")] <- NA
}


if(length(lsl_rt_outlier) != 0) {
  bucld_all_completed[which(
    bucld_all_completed$part_id %in% lsl_rt_outlier),
    c("rt_children_lsl_indiv_rts",
      "slope_children_lsl_indiv_rts_slope")] <- NA
}

# To Do: Remove outliers for Spoli.
# spoli_c_125 outlier for SSL (based on eyeballing)
  # bucld_sl_bar_all[which(
  #   bucld_sl_bar_all$part_id %in% "spoli_c_125"),
  #   c("slope_children_ssl_indiv_rts_slope")] <- NA
  # 
  # 
  # bucld_all_completed[which(
  #   bucld_all_completed$part_id %in% "spoli_c_125"),
  #   c("slope_children_ssl_indiv_rts_slope")] <- NA
  
# Spoli_c_097 has invalid key press (error due to jspsych during the experiment adminstartion)
if(length(which(bucld_all_completed$part_id %in% "spoli_c_097")) != 0) {
  bucld_all_completed[which(
    bucld_all_completed$part_id %in% "spoli_c_097"),
    c("rt_children_ssl_indiv_rts",
      "slope_children_ssl_indiv_rts_slope")] <- NA
}

```

These are removed outliers in the children group: 

SSL RT and Slope < 6 hits: `r ssl_rt_outlier` + 1 ASD spoli_c_097 (jsPsyc technical error in SSL RT) 

TSL RT and Slope < 6 hits: `r tsl_rt_outlier` 

VSL RT and Slope < 6 hits: `r vsl_rt_outlier` 

LSL RT and Slope < 6 hits: `r lsl_rt_outlier` 

SSL Accuracy: `r ssl_accurarcy_outlier`

TSL Accuracy: `r tsl_accurarcy_outlier`

VSL Accuracy: `r vsl_accurarcy_outlier`

LSL Accuracy: `r lsl_accurarcy_outlier`


# Extract data for each measure (accuracy, slope, rt, entropy)
```{r, include = F}
extract_measure_child <-
function(df, taskCol) {
  df <- 
    bucld_all_completed[,which(str_detect(
      colnames(bucld_all_completed), paste0("part_id|group|age_at_web_year|", taskCol)))]
  
  df <- melt(df, id.vars = c("part_id", "group", "age_at_web_year"))
  
  colnames(df)[colnames(df) == "variable"] <- "task"
  colnames(df)[colnames(df) == "value"] <- taskCol
  
  return(df)
}

bucld_all_completed_acc <- extract_measure_child(bucld_all_completed_acc, "accuracy")
bucld_all_completed_slope <- extract_measure_child(bucld_all_completed_slope, "slope")
bucld_all_completed_rt <- extract_measure_child(bucld_all_completed_rt, "rt_children")
bucld_all_completed_entropy <- extract_measure_child(bucld_all_completed_entropy, "entropy")

setdiff(unique(bucld_all_completed_acc$part_id), unique(bucld_all_completed$part_id))

colnames(bucld_all_completed_rt)[colnames(bucld_all_completed_rt) == "rt_children"] <- "mean_rt"
colnames(bucld_all_completed_slope)[colnames(bucld_all_completed_slope) == "slope"] <- "rt_slope"

bucld_all_completed_acc <-
  bucld_all_completed_acc[-which(str_detect(bucld_all_completed_acc$task, "random|predictable")),]
    
bucld_all_completed_entropy <-
  bucld_all_completed_entropy[-which(str_detect(bucld_all_completed_entropy$task, "random|predictable")),]
```

```{r}
extract_measure <-
function(df, taskCol) {
  df <- 
    blast_adult_wide[,which(str_detect(
      colnames(blast_adult_wide), paste0("part_id|group|age_at_web_year|", taskCol)))]
  
  df <- melt(df, id.vars = c("part_id", "group", "age_at_web_year"))
  
  colnames(df)[colnames(df) == "variable"] <- "task"
  colnames(df)[colnames(df) == "value"] <- taskCol
  
  return(df)
}

blast_adult_wide_acc <- extract_measure(blast_adult_wide_acc, "accuracy")
blast_adult_wide_slope <- extract_measure(blast_adult_wide_slope, "slope")
blast_adult_wide_rt <- extract_measure(blast_adult_wide_rt, "rt_adult")
blast_adult_wide_entropy <- extract_measure(blast_adult_wide_entropy, "entropy")

colnames(blast_adult_wide_rt)[colnames(blast_adult_wide_rt) == "rt_adult"] <- "mean_rt"
colnames(blast_adult_wide_slope)[colnames(blast_adult_wide_slope) == "slope"] <- "rt_slope"

blast_adult_wide_acc <-
  blast_adult_wide_acc[-which(str_detect(blast_adult_wide_acc$task, "random|predictable")),]
    
blast_adult_wide_entropy <-
  blast_adult_wide_entropy[-which(str_detect(blast_adult_wide_entropy$task, "random|predictable")),]

```
  


# Count the number of completed participants for each task
```{r}
bucld_all_completed$scq_web <- as.numeric(as.character(bucld_all_completed$scq_web))

# bucld_all_completed$scq <- coalesce(bucld_all_completed$scq_total, bucld_all_completed$scq_web)

taskcomp_td <-
sapply(bucld_all_completed[which(bucld_all_completed$group == "TD"),
                           c("scq_total",
                             "kbit_matrices_raw",
                           "rsr_raw", 
                           "a_prime",
                            "accuracy_children_vsl_accuracies", 
                           "accuracy_children_lsl_accuracies",
                           "accuracy_children_tsl_accuracies", 
                           "accuracy_children_ssl_accuracies",
                           "accuracy_lsl_predictable_2afc_accuracies")],
       function(x)sum(!is.na(x)))


taskcomp_asd <-
  sapply(bucld_all_completed[which(bucld_all_completed$group == "ASD"),
                           c("scq_web",
                             "kbit_matrices_raw",
                           "rsr_raw", 
                           "a_prime",
                            "accuracy_children_vsl_accuracies", 
                           "accuracy_children_lsl_accuracies",
                           "accuracy_children_tsl_accuracies", 
                           "accuracy_children_ssl_accuracies",
                           "accuracy_lsl_predictable_2afc_accuracies")],
       function(x)sum(!is.na(x)))

taskcomp_count<- rbind(taskcomp_td, taskcomp_asd)

taskcomp_count <- data.frame(taskcomp_count)

colnames(taskcomp_count) <- c("SCQ", "KBIT", "Sentence Recall", "Grammaticality Judgement", "Image", "Letter", "Tone", "Syllable", "Letter Predictable")

print(taskcomp_count)

missing_scq_web <- bucld_all_completed[which(is.na(bucld_all_completed$scq_web) & bucld_all_completed$group == "ASD"), "part_id"]

# write.csv(missing_scq_web, "missing_scq_web.csv")

# # write.csv(taskcomp_count, "srcd_figure/task_comp_count.csv")


# qp_subj <- bucld_all_completed[,c("part_id", "group",
#                              "kbit_matrices_raw",
#                            "rsr_raw", 
#                            "a_prime",
#                             "accuracy_children_vsl_accuracies", 
#                            "accuracy_children_lsl_accuracies",
#                            "accuracy_children_tsl_accuracies", 
#                            "accuracy_children_ssl_accuracies")]
# # write.csv(qp_subj, "qp_subj.csv")
```



# Group SL analysis & KBIT, SCQ Descriptive Stat
```{r}
td_sl <- 
  bucld_all_completed[which(bucld_all_completed$group == "TD"),]


asd_sl <- 
  bucld_all_completed[which(bucld_all_completed$group == "ASD"),]


library("pastecs")
td_sl$scq_web <- as.numeric(as.character(td_sl$scq_web))

td_kbit_scq_descrip_stat <-
  stat.desc(td_sl[, c(
    "kbit_matrices_raw",
    "kbit_matrices_std",
    "scq_total",
    "rsr_raw",
    "rsr_std",
    "a_prime",
    "gjt_std_score_gjt_web"
  )])

td_kbit_scq_descrip_stat <-
  td_kbit_scq_descrip_stat[c("nbr.val", "mean", "std.dev"),
                           c("kbit_matrices_raw",
                             "kbit_matrices_std",
                             "scq_total",
                             "rsr_raw",
                             "rsr_std",
                             "a_prime",
                             "gjt_std_score_gjt_web"
                           )]

td_kbit_scq_descrip_stat[nrow(td_kbit_scq_descrip_stat) + 1,] <- "TD"
print(td_kbit_scq_descrip_stat)

asd_kbit_scq_descrip_stat <-
  stat.desc(asd_sl[, c(
    "kbit_matrices_raw",
    "kbit_matrices_std",
    "scq_total" ,
    "scq_web",
    "rsr_raw",
    "rsr_std",
    "a_prime",
    "gjt_std_score_gjt_web"
  )])

asd_kbit_scq_descrip_stat <-
  asd_kbit_scq_descrip_stat[c("nbr.val", "mean", "std.dev"),
                            c("kbit_matrices_raw",
                              "kbit_matrices_std",
                              "scq_total" ,
                              "scq_web",
                              "rsr_raw",
                              "rsr_std",
                              "a_prime",
                              "gjt_std_score_gjt_web"
                            )]

asd_kbit_scq_descrip_stat[nrow(asd_kbit_scq_descrip_stat) + 1,] <- "ASD"
print(asd_kbit_scq_descrip_stat)

kbit_scq_descrip_stat <- cbind(td_kbit_scq_descrip_stat, asd_kbit_scq_descrip_stat)
print(kbit_scq_descrip_stat)
```


# T-test TD vs. ASD
```{r}
t_test_multi_pair <- 
  function(x,y){
  test <- t.test(x,y, alternative = "less")

  data.frame(p_value = test$p.value,
             df = test$parameter,
             t_stat = test$statistic)
  }


#Results withOUT outliers
# T test for SL
sapply(intersect(colnames(td_sl),colnames(asd_sl))[c(7:9, 25)], 
                 function(x) t_test_multi_pair(td_sl[,x], asd_sl[,x]))

sapply(intersect(colnames(td_sl),colnames(asd_sl))[c(13:15, 26)], 
                 function(x) t_test_multi_pair(td_sl[,x], asd_sl[,x]))

sapply(intersect(colnames(td_sl),colnames(asd_sl))[c(17:20)], 
                 function(x) t_test_multi_pair(td_sl[,x], asd_sl[,x]))

sapply(intersect(colnames(td_sl),colnames(asd_sl))[c(21:24)], 
                 function(x) t_test_multi_pair(td_sl[,x], asd_sl[,x]))
# Still in lab sample comparison for Kbit and SCQ:in the lab 
sapply(intersect(colnames(td_sl),colnames(asd_sl))[c(27:28, 29)], 
                 function(x) t_test_multi_pair(td_sl[,x], asd_sl[,x]))




# SCQ comparison between online ASD and in lab TD
t.test(td_sl$scq_total, asd_sl$scq_web)

t.test(td_sl$rsr_raw, asd_sl$rsr_raw)

t.test(td_sl$a_prime, asd_sl$a_prime)

t.test(td_sl$rsr_std, asd_sl$rsr_std)

t.test(td_sl$gjt_std_score_gjt_web, asd_sl$gjt_std_score_gjt_web)


t.test(blast_adult_wide$slope_adult_vsl_indiv_rts_slope,
       td_sl$slope_children_vsl_indiv_rts_slope,
       alternative = c("less"))

t.test(blast_adult_wide$slope_adult_ssl_indiv_rts_slope,
       td_sl$slope_children_ssl_indiv_rts_slope,
       alternative = c("greater"))
```

# T-test TD vs. Adult
```{r}
slopeAdultW <- blast_adult_wide[,which(str_detect(colnames(blast_adult_wide), "indiv_rts_slope"))]
colnames(slopeAdultW) <- str_extract(colnames(slopeAdultW), "\\S{3}(_indiv_rts_slope)")

slopeTDW <- td_sl[,which(str_detect(colnames(td_sl), "indiv_rts_slope"))]
colnames(slopeTDW) <- str_extract(colnames(slopeTDW), "\\S{3}(_indiv_rts_slope)")

accAdultW <- blast_adult_wide[,which(str_detect(colnames(blast_adult_wide), "l_accuracies"))]
colnames(accAdultW) <- str_extract(colnames(accAdultW), "\\S{3}(_accuracies)")

accTDW <- td_sl[,which(str_detect(colnames(td_sl), "l_accuracies"))]
colnames(accTDW) <- str_extract(colnames(accTDW), "\\S{3}(_accuracies)")

sapply(intersect(colnames(accAdultW),colnames(accTDW)), 
                 function(x) t_test_multi_pair(accAdultW[,x], accTDW[,x]))

sapply(intersect(colnames(slopeAdultW),colnames(slopeTDW)), 
                 function(x) t_test_multi_pair(slopeAdultW[,x], slopeTDW[,x]))
```


# Accuracy against chance for TD and ASD
```{r}
t_test_against_chance <- 
  function(x){
  test <- t.test(x, mu=0.5, alternative= "greater")
  data.frame(p_value = test$p.value,
             df = test$parameter,
             t_stat = test$statistic)
  }

#TD without outliers
sapply(colnames(td_sl)[c(7:9, 25)], 
       function(x) t_test_against_chance(td_sl[,x]))

#ASD without outliers
sapply(colnames(asd_sl)[c(7:9, 25)], 
       function(x) t_test_against_chance(asd_sl[,x]))

sapply(colnames(blast_adult_wide)[which(str_detect(colnames(blast_adult_wide), "accuracy"))], 
       function(x) t_test_against_chance(blast_adult_wide[,x]))


# t.test(asd_sl$accuracy_children_lsl_accuracies, mu = 0.5, alternative = "greater")

# # write.csv(bucld_all_completed, "srcd_figure/bucld_all_completed_sslSignDiff_dataset.csv")


t_test_against_zero <- 
  function(x){
  test <- t.test(x, mu=0, alternative= "less")
  data.frame(p_value = test$p.value,
             df = test$parameter,
             t_stat = test$statistic)
  }


sapply(colnames(td_sl)[c(21:24)], 
       function(x) t_test_against_zero(td_sl[,x]))

sapply(colnames(asd_sl)[c(21:24)], 
       function(x) t_test_against_zero(asd_sl[,x]))

sapply(colnames(blast_adult_wide)[which(str_detect(colnames(blast_adult_wide), "slope"))], 
       function(x) t_test_against_zero(blast_adult_wide[,x]))

confInterval_lsl <- t.test(td_sl$slope_children_lsl_indiv_rts_slope, mu= 0, alternative = "less")
confInterval_ssl <- t.test(td_sl$slope_children_ssl_indiv_rts_slope, mu= 0, alternative = "less")

# The confidence interval of t.test() is already mean + CI/ mean - CI
confInterval_lsl <- confInterval_lsl$conf.int[2]
confInterval_ssl <- confInterval_ssl$conf.int[2]

aboveConfInterval_lsl <- length(which(na.omit(asd_sl$slope_children_lsl_indiv_rts_slope) > confInterval_lsl))
aboveConfInterval_ssl <- length(which(na.omit(asd_sl$slope_children_ssl_indiv_rts_slope) > confInterval_ssl))

# sdSSL_td <- sd(bucld_all_completed[bucld_all_completed$group == "TD","slope_children_lsl_indiv_rts_slope"], na.rm = T)
# naOmitSSL <- length(na.omit(bucld_all_completed[bucld_all_completed$group == "TD","slope_children_lsl_indiv_rts_slope"], 
#                             na.rm = T))
# seSSL_td <- sdSSL_td/ sqrt(naOmitSSL)
#   
# alpha=0.05
# t=qt((1-alpha)/2 + .5, naOmitSSL-1)
# CI=t*seSSL_td
```

# Accuracy: Number of ASD < 1.5 SD TD 
```{r}
belowSD_acc <- function(slTask) {
  sd1.5TD <- mean(bucld_all_completed[bucld_all_completed$group == "TD",slTask], na.rm = T) - 1.5*sd(bucld_all_completed[bucld_all_completed$group == "TD",slTask], na.rm = T)
  
  asd_below_sd1.5TD <- nrow(bucld_all_completed[which(bucld_all_completed$group == "ASD" & 
                           bucld_all_completed[,slTask] < sd1.5TD),])
  return(asd_below_sd1.5TD)
}

belowSD_slope <- function(slTask) {
  sd1.5TD <- mean(bucld_all_completed[bucld_all_completed$group == "TD",slTask], na.rm = T) + 1.5*sd(bucld_all_completed[bucld_all_completed$group == "TD",slTask], na.rm = T)
  
  asd_below_sd1.5TD <- nrow(bucld_all_completed[which(bucld_all_completed$group == "ASD" & 
                           bucld_all_completed[,slTask] > sd1.5TD),])
  return(asd_below_sd1.5TD)
}

belowSD_acc("accuracy_children_ssl_accuracies")
belowSD_acc("accuracy_children_lsl_accuracies")
belowSD_slope("slope_children_ssl_indiv_rts_slope")
belowSD_slope("slope_children_lsl_indiv_rts_slope")

ssl1.5SD_acc <- 1.5*sd(bucld_all_completed[bucld_all_completed$group == "TD","accuracy_children_ssl_accuracies"], na.rm = T)
lsl1.5SD_acc <- 1.5*sd(bucld_all_completed[bucld_all_completed$group == "TD","accuracy_children_lsl_accuracies"], na.rm = T)
ssl1.5SD_slope <- 1.5*sd(bucld_all_completed[bucld_all_completed$group == "TD","slope_children_ssl_indiv_rts_slope"], na.rm = T)
lsl1.5SD_slope <- 1.5*sd(bucld_all_completed[bucld_all_completed$group == "TD","slope_children_lsl_indiv_rts_slope"], na.rm = T)
ssl1.5SD_slope <- 
  mean(bucld_all_completed[bucld_all_completed$group == "TD","slope_children_ssl_indiv_rts_slope"], na.rm = T) + ssl1.5SD_slope
lsl1.5SD_slope <- 
  mean(bucld_all_completed[bucld_all_completed$group == "TD","slope_children_lsl_indiv_rts_slope"], na.rm = T) + lsl1.5SD_slope
```

Number of ASD below 1.5 SD of mean SSL accuracy in TD: `asd_below_sd1.5TD`


# Data Prep for LMER

# Add modality and domain category to long-format data
```{r, include = F}
library("stringr")
add_dom_mod_func <- 
function(df) {
df[which(str_detect(df$task, "ssl")), "domain"] <- "ling"
df[which(str_detect(df$task, "lsl")), "domain"] <- "ling"
df[which(str_detect(df$task, "vsl")), "domain"] <- "nonling"
df[which(str_detect(df$task, "tsl")), "domain"] <- "nonling"
df[which(str_detect(df$task, "ssl")), "modality"] <- "auditory"
df[which(str_detect(df$task, "tsl")), "modality"] <- "auditory"
df[which(str_detect(df$task, "vsl")), "modality"] <- "visual"
df[which(str_detect(df$task, "lsl")), "modality"] <- "visual"
return (df)
}

bucld_all_completed_acc <- add_dom_mod_func(bucld_all_completed_acc)
bucld_all_completed_entropy <- add_dom_mod_func(bucld_all_completed_entropy)
bucld_all_completed_rt <- add_dom_mod_func(bucld_all_completed_rt)
bucld_all_completed_slope <- add_dom_mod_func(bucld_all_completed_slope)


blast_adult_wide_acc <- add_dom_mod_func(blast_adult_wide_acc)
blast_adult_wide_entropy <- add_dom_mod_func(blast_adult_wide_entropy)
blast_adult_wide_rt <- add_dom_mod_func(blast_adult_wide_rt)
blast_adult_wide_slope <- add_dom_mod_func(blast_adult_wide_slope)
```

# Mixed level modeling

# Data Prep for LMER (scale percentage accuracy and slope across groups by each task)
This may not be necessary at all, as glmer and by trial RT data will be used for GLMER and LMER models.
```{r, include = F}
scale_func <-
function(df) {
  scaled_df <- cast(df[,c(1:5)], part_id+group+age_at_web_year~task)
  
  scaled_df[, c(which(str_detect(colnames(scaled_df), "ssl|lsl|vsl|tsl")))] <-
    lapply(scaled_df[, c(which(str_detect(colnames(scaled_df), "ssl|lsl|vsl|tsl")))],
           function(x) {
             scale(x)
           })
  
  scaled_df <- melt(scaled_df, id.vars = c("part_id", "group", "age_at_web_year"))
  row.names(scaled_df) <- seq(1:nrow(scaled_df))
  
  return(scaled_df)
}

crossed_random_effect_acc_long <- scale_func(bucld_all_completed_acc)
crossed_random_effect_slope_long <- scale_func(bucld_all_completed_slope)
crossed_random_effect_entropy_long <- scale_func(bucld_all_completed_entropy)  
crossed_random_effect_rt_long <- scale_func(bucld_all_completed_rt)  

all_acc <- rbind(blast_adult_wide_acc, bucld_all_completed_acc)
all_slope <- rbind(blast_adult_wide_slope, bucld_all_completed_slope)
all_entropy <- rbind(blast_adult_wide_entropy, bucld_all_completed_entropy)
all_rt <- rbind(blast_adult_wide_rt, bucld_all_completed_rt)

all_acc$task <- str_extract(all_acc$task, "\\S{3}(_accuracies)")
all_slope$task <- str_extract(all_slope$task, "\\S{3}(_indiv_rts_slope)")
all_entropy$task <- str_extract(all_entropy$task, "\\S{3}(_entropy)")
all_rt$task <- str_extract(all_rt$task, "\\S{3}(_indiv_rts)")


scaled_all_acc <- scale_func(all_acc)
scaled_all_slope <- scale_func(all_slope)
scaled_all_entropy <- scale_func(all_entropy)  
scaled_all_rt <- scale_func(all_rt)  
```



# Run LMER for accuracy
```{r, include = F}
# Order matters, task factor order matters in LMER
# https://stats.stackexchange.com/questions/14522/variable-order-and-accounted-variability-in-linear-mixed-effects-modeling
library(lmerTest)

crossed_random_effect_acc_long$task <- 
  factor(crossed_random_effect_acc_long$task,levels = c("accuracy_children_lsl_accuracies", 
                                              "accuracy_children_ssl_accuracies", 
                                              "accuracy_children_vsl_accuracies", 
                                              "accuracy_children_tsl_accuracies"))

crossed_random_effect_acc_long <-
  crossed_random_effect_acc_long[order(crossed_random_effect_acc_long$task), ]

library("stringr")

crossed_random_effect_acc_long$task <- str_extract(crossed_random_effect_acc_long$task, "(?<=children_)\\S{3}")

crossed_random_effect_acc_long$task <- as.factor(crossed_random_effect_acc_long$task)



m1_acc = lmer(value~group*task + (1+task|part_id),
          data=crossed_random_effect_acc_long,
          control=lmerControl(optimizer = "bobyqa",
                              check.nobs.vs.nRE="ignore"))
summary(m1_acc)
m1_acc_sum <- summary(m1_acc)
# write.csv(m1_acc_sum$coefficients, "lmer_acc.csv")

scaled_all_acc$task <- 
  factor(scaled_all_acc$task,levels = c("lsl_accuracies",
                                        "ssl_accuracies", 
                                        "vsl_accuracies", 
                                        "tsl_accuracies"))

scaled_all_acc$group <- 
  factor(scaled_all_acc$group,levels = c("adult",
                                        "TD", 
                                        "ASD"))

mat <- rbind(c(1, -0.5, -0.5),     # a vs. (b + c) / 2
             c(0, 1, -1))    

library(MASS)
cMat <- ginv(mat)

m1_acc_adult = lmer(value~group*task + (1+task|part_id),
                    data=scaled_all_acc,
                    control=lmerControl(optimizer = "bobyqa",
                              check.nobs.vs.nRE="ignore"),
                    contrasts = list(group = cMat))
summary(m1_acc_adult)

m2_acc_adult = lmer(value~group + task + (1+task|part_id),
                    data=scaled_all_acc,
                    control=lmerControl(optimizer = "bobyqa",
                              check.nobs.vs.nRE="ignore"),
                    contrasts = list(group = cMat))
summary(m2_acc_adult)

m3_acc_adult = lmer(value~group + group:task + (1+task|part_id),
                    data=scaled_all_acc,
                    control=lmerControl(optimizer = "bobyqa",
                              check.nobs.vs.nRE="ignore"),
                    contrasts = list(group = cMat))
summary(m3_acc_adult)

m2_acc <- lmer(value~group:task + group + (1 | part_id), data = crossed_random_effect_acc_long)
summary(m2_acc)

anova(m1_acc, m2_acc)

m3_acc = lmer(value~group*task + (1+task|part_id) + age_at_web_year,
          data=crossed_random_effect_acc_long,
          control=lmerControl(optimizer = "bobyqa",
                              check.nobs.vs.nRE="ignore"))
summary(m3_acc)

# m3_acc = lmer(value~group + (1|part_id),
#           data=crossed_random_effect_acc_long
#           )
# summary(m3_acc)


## write.csv(crossed_random_effect_acc_long, "bucld_accuracy_use_this_data.csv")
```


# LMER for Domain and Modality for accuracy
```{r, include = F}
lmer_acc_dom_mod <- add_dom_mod_func(crossed_random_effect_acc_long)
lmer_acc_dom_mod_adult <- add_dom_mod_func(scaled_all_acc)

lmer_acc_dom_mod_adult$group <- 
  factor(lmer_acc_dom_mod_adult$group,levels = c("adult",
                                        "TD", 
                                        "ASD"))

library(lmerTest)

m1_acc_dom = lmer(value~group*domain + (1+domain|part_id), data=lmer_acc_dom_mod,
                  control=lmerControl(optimizer = "bobyqa", check.nobs.vs.nRE="ignore"),
                  contrast = list(group = c(-1, 1), domain = c(-1,1)))
                 
summary(m1_acc_dom)

m2_acc_dom <- lmer(value~group*domain + (1 +domain | part_id), data = lmer_acc_dom_mod,
                   control=lmerControl(optimizer = "bobyqa", check.nobs.vs.nRE="ignore"))
summary(m2_acc_dom)

anova(m1_acc_dom, m2_acc_dom)

m1_acc_mod <- lmer(value~group*modality + (1 + modality | part_id), data = lmer_acc_dom_mod,
                   control=lmerControl(optimizer = "bobyqa", check.nobs.vs.nRE="ignore"),
                   contrast = list(group = c(-1, 1), modality = c(-1,1)))
summary(m1_acc_mod)
```


# LMER for Domain and Modality for RT Slope for children and adult vs. TD
```{r}
bucld_all_completed_slope$group <- factor(bucld_all_completed_slope$group,
                                    levels = c("ASD", 
                                               "TD"))

bucld_all_completed_slope$domain <- factor(bucld_all_completed_slope$domain,
                                    levels = c("nonling", 
                                               "ling"))

bucld_all_completed_slope$modality <- factor(bucld_all_completed_slope$modality,
                                             levels = c("auditory", 
                                               "visual"))

m1_slope_dom_mod <- lmer(rt_slope~group*domain*modality + (1 +domain | part_id) + (0 + modality | part_id), 
                         data = bucld_all_completed_slope,
                         control=lmerControl(optimizer = "bobyqa", check.nobs.vs.nRE="ignore"),
                         contrasts = list(domain = c(-1, 1),
                                          modality = c(-1, 1),
                                      group = c(-1,1)))
summary(m1_slope_dom_mod)


# bucld_all_completed_slope$domain <-
#   factor(bucld_all_completed_slope$domain,levels = c("ling",
#                                                      "nonling"))
# bucld_all_completed_slope$group <-
#   factor(bucld_all_completed_slope$group,levels = c("ASD",
#                                                  "TD"))


# m1_slope_dom <- lmer(rt_slope~group*domain + (1 +domain | part_id), data = bucld_all_completed_slope,
#                      contrasts = list(domain = c(-1, 1),
#                                       group = c(-1,1)),
#                    control=lmerControl(optimizer = "bobyqa", check.nobs.vs.nRE="ignore"))
# summary(m1_slope_dom)
# 
# 
# m1_slope_mod <- lmer(rt_slope~group*modality + (1 + modality | part_id), data = bucld_all_completed_slope,
#                    control=lmerControl(optimizer = "bobyqa", check.nobs.vs.nRE="ignore"),
#                    contrasts = list(modality = c(-1, 1),
#                                       group = c(-1,1)))
# summary(m1_slope_mod)

adult_slope <-
melt(blast_adult_wide[,c(which(str_detect(colnames(blast_adult_wide), 
                                      "part_id|group|age_at_web_year|slope")))], 
     id.vars = c("part_id", "group", "age_at_web_year"))

colnames(adult_slope) <- c("part_id", "group", "age_at_web_year", "task", "rt_slope")

adult_slope <- add_dom_mod_func(adult_slope)

td_slope <- bucld_all_completed_slope[which(bucld_all_completed_slope$group == "TD"),]

adult_slope <- rbind(td_slope, adult_slope)

adult_slope$task <-
  str_extract(adult_slope$task, "(?<=slope_adult_)\\S{3}|(?<=slope_children_)\\S{3}")

adult_slope$group <- factor(adult_slope$group,
                                    levels = c("TD", 
                                               "adult"))

adult_slope$domain <- factor(adult_slope$domain,
                                    levels = c("nonling", 
                                               "ling"))

adult_slope$modality <- factor(adult_slope$modality,
                                             levels = c("auditory", 
                                               "visual"))

m1_slope_adult_dom_mod <- lmer(rt_slope~group*domain*modality + (1 +domain | part_id) + 
                                 (0 + modality | part_id), 
                         data = adult_slope,
                         control=lmerControl(optimizer = "bobyqa", check.nobs.vs.nRE="ignore"),
                         contrasts = list(domain = c(-1, 1),
                                          modality = c(-1, 1),
                                      group = c(-1,1)))
summary(m1_slope_dom_mod)
```

```{r, include F, eval = F}
all_slope$group <- factor(all_slope$group,
                                    levels = c("adult",
                                               "TD", 
                                               "ASD"))



all_slope$domain <- factor(all_slope$domain,
                                    levels = c("nonling",
                                               "ling"))

all_slope$modality <- factor(all_slope$modality,
                                    levels = c("auditory",
                                               "visual"))

mat <- rbind(c(1, -0.5, -0.5),     # a vs. (b + c) / 2
             c(0, 1, -1))    

library(MASS)
cMat <- ginv(mat)

m1_slope_dom_mod_adult <- lmer(rt_slope~group*domain*modality + (1 +domain | part_id) + (0 + modality | part_id), 
                         data = all_slope,
                         control=lmerControl(optimizer = "bobyqa", check.nobs.vs.nRE="ignore"),
                         contrasts = list(domain = c(-1, 1),
                                          modality = c(-1, 1),
                                      group = cMat))

summary(m1_slope_dom_mod_adult)
```


# Run LMER for RT slope by task
```{r}
library("stringr")
bucld_all_completed_slope$task <- str_extract(bucld_all_completed_slope$task, "(?<=children_)\\S{3}")
bucld_all_completed_slope$task <- as.factor(bucld_all_completed_slope$task)

m1_slope = lmer(rt_slope~group*task + (1+task|part_id),
          data=bucld_all_completed_slope,
          control=lmerControl(optimizer = "bobyqa",
                              check.nobs.vs.nRE="ignore"),
          contrasts = list(group = c(-1,1)))
summary(m1_slope)
```

```{r}
adult_slope$task <- factor(adult_slope$task,
                                    levels = c("lsl", 
                                               "vsl",
                                               "tsl",
                                               "ssl"))


m1_slope_adult_task <- lmer(rt_slope~group*task + (1 +task | part_id),
                         data = adult_slope,
                         control=lmerControl(optimizer = "bobyqa", check.nobs.vs.nRE="ignore"),
                         contrasts = list(group = c(-1,1)))
summary(m1_slope_adult_task)
```

```{r, include = F, eval = F}

m1_slope_adult = lmer(rt_slope~group*task + (1+task|part_id),
          data=all_slope,
          control=lmerControl(optimizer = "bobyqa",
                              check.nobs.vs.nRE="ignore"),
          contrasts = list(group = cMat))
summary(m1_slope_adult)


# m1_slope_sum <- summary(m1_slope) 
# 
# m2_slope <- lmer(rt_slope~group:task + group  + (1 | part_id), data = bucld_all_completed_slope)
# summary(m2_slope)
# 
# anova(m1_slope, m2_slope)
# # write.csv(m1_slope_sum$coefficients, "lmer_slope.csv")
# # write.csv(bucld_all_completed_slope, "bucld_all_completed_slope_use_this_poster.csv")
```


# Run LMER for entropy
```{r, include = F}
crossed_random_effect_entropy_long$task <- 
  factor(crossed_random_effect_entropy_long$task,levels = c("entropy_children_lsl_entropy", 
                                              "entropy_children_ssl_entropy", 
                                              "entropy_children_vsl_entropy", 
                                              "entropy_children_tsl_entropy"))

crossed_random_effect_entropy_long <-
  crossed_random_effect_entropy_long[order(crossed_random_effect_entropy_long$task), ]

library("stringr")

crossed_random_effect_entropy_long$task <- str_extract(crossed_random_effect_entropy_long$task, "(?<=children_)\\S{3}")

crossed_random_effect_entropy_long$task <- as.factor(crossed_random_effect_entropy_long$task)


m1_ent = lmer(value~group:task + group + (1+task|part_id),
          data=crossed_random_effect_entropy_long,
          control=lmerControl(optimizer = "bobyqa",
                              check.nobs.vs.nRE="ignore"))
summary(m1_ent)

m2_ent <- lmer(value~group:task + group + (1 | part_id), data = crossed_random_effect_entropy_long)
summary(m2_ent)

anova(m1_ent, m2_ent)

```

# Run LMER for mean rt
```{r, include = F}
library("stringr")
crossed_random_effect_rt_long$task <- str_extract(crossed_random_effect_rt_long$task, "(?<=children_)\\S{3}")
crossed_random_effect_rt_long$task <- as.factor(crossed_random_effect_rt_long$task)

m1_rt = lmer(value~group:task + group  + (1+task|part_id),
          data=crossed_random_effect_rt_long,
          control=lmerControl(optimizer = "bobyqa",
                              check.nobs.vs.nRE="ignore"))
summary(m1_rt)

m2_rt <- lmer(value~task*group + (1 | part_id), data = crossed_random_effect_rt_long)
summary(m2_rt)

anova(m1_rt, m2_rt)
```




# By trial Accuracy GLMER (Need to remove outlier if any: no outliers in this analysis)
```{r, include = F}
input_path3 <-
  "my_path/blast_online_data/data_summaries/blast_online_child/breakdown/acc_by_trial/acc_by_trial"

input_path4 <- "my_path/spoli/data_summaries/breakdown/acc_by_trial"

input_path5 <-
  "my_path/blast_online_data/data_summaries/blast_online_adult/breakdown/acc_by_trial"

acclist <-
  list.files(path = input_path3,
             pattern = "*by_trial.csv", full.names = T)

acclistSPL <-
  list.files(path = input_path4,
             pattern = "*by_trial.csv", full.names = T)

acclistAdult <-
  list.files(path = input_path5,
             pattern = "*by_trial.csv", full.names = T)


library("stringr")

tname <- str_extract(basename(acclist), "(?<=blast_)\\S{3}")

tnameSPL <- str_extract(basename(acclistSPL), "(?<=spoli_)\\S{3}")

tnameAdult <- str_extract(basename(acclistAdult), "(?<=blast_)\\S{3}")

acc_trial <- lapply(acclist, read.csv)

acc_trialSPL <- lapply(acclistSPL, read.csv)

acc_trial_adult <- lapply(acclistAdult, read.csv)

for (i in 1:length(acc_trial)) {
  acc_trial[[i]]$task <-tname[i]
}

acc_trial <- do.call(rbind, acc_trial)

acc_trial <- acc_trial[,!names(acc_trial) %in% "X"]


for (i in 1:length(acc_trialSPL)) {
  acc_trialSPL[[i]]$task <-tnameSPL[i]
}

acc_trialSPL <- do.call(rbind, acc_trialSPL)

acc_trialSPL <- acc_trialSPL[,!names(acc_trialSPL) %in% "X"]

for (i in 1:length(acc_trial_adult)) {
  acc_trial_adult[[i]]$task <-tnameAdult[i]
}

acc_trial_adult <- do.call(rbind, acc_trial_adult)

acc_trial_adult <- acc_trial_adult[,!names(acc_trial_adult) %in% "X"]

acc_trial <- rbind(acc_trial, acc_trialSPL)


acc_trial <-
  merge(acc_trial,
      bucld_all_completed[,c("part_id", "group", "gender", "age_at_web_month", "age_at_web_year", "scq_web", "scq_total")],
      by.x = "subj",
      by.y = "part_id",
      all.y = T)

setdiff(unique(bucld_all_completed$part_id), unique(acc_trial$subj))

acc_trial$corr <- as.factor(acc_trial$corr)
acc_trial$subj <- as.factor(acc_trial$subj)
acc_trial$task <- as.factor(acc_trial$task)
acc_trial$group <- as.factor(acc_trial$group)

# # write.csv(acc_trial, "my_path/bucld_2019_followup/acc_trial.csv")

# Important Step, match the dataset to the current analysis
acc_trial <- acc_trial[which(acc_trial$subj %in% bucld_all_completed$part_id),]


acc_trial <- add_dom_mod_func(acc_trial)

acc_trial_adult$group <- "adult"
acc_trial_adult <- add_dom_mod_func(acc_trial_adult)

column <- intersect(colnames(acc_trial_adult), colnames(acc_trial))

acc_trial_adult <- rbind(acc_trial_adult[,colnames(acc_trial_adult) %in% column],
                         acc_trial[,colnames(acc_trial) %in% column])
```

# GLMER results for children
```{r}
head(acc_trial)

acc_trial$task <- as.factor(acc_trial$task)
acc_trial$subj <- as.factor(acc_trial$subj)
acc_trial$age_at_web_year <- as.numeric(as.character(acc_trial$age_at_web_year))

typeof(acc_trial$trial_order)
typeof(acc_trial$task)
typeof(acc_trial$corr)
typeof(acc_trial$subj)

acc_trial$task <- 
  factor(acc_trial$task,
         levels = c("lsl", 
                    "ssl", 
                    "vsl", 
                    "tsl"))

acc_trial$group <- 
  factor(acc_trial$group,
         levels = c("ASD", 
                    "TD"))

acc_trial$domain <- 
  factor(acc_trial$domain,
         levels = c("nonling", 
                    "ling"))

acc_trial$modality <- 
  factor(acc_trial$modality,
         levels = c("auditory", 
                    "visual"))

# contr.sum(n=4)

logacc <-
  glmer(corr~group*task + (1+task|subj), data = acc_trial,
        contrasts = list(group = c(-1,1)
                         ), family = binomial, control=glmerControl(optimizer = "bobyqa",
                              check.nobs.vs.nRE="ignore"))

summary(logacc)

# logacc_gender <-
#   glmer(corr~group*task + gender + gender:group + (1+task|subj), data = acc_trial,
#         contrasts = list(group = c(-1,1),
#                          gender = c(-1,1)
#                          ), family = binomial, control=glmerControl(optimizer = "bobyqa",
#                               check.nobs.vs.nRE="ignore"))
# 
# summary(logacc_gender)


logacc_dom <-
  glmer(corr~group*domain*modality + (1+domain|subj) + (0+modality|subj) + (1|trial_order), data = acc_trial,
    family = binomial, 
    contrasts = list(domain = c(-1, 1), modality = c(-1, 1), group = c(-1,1)),
    control=glmerControl(optimizer = "bobyqa",
                              check.nobs.vs.nRE="ignore"))

summary(logacc_dom)

logacc_mod <-
  glmer(corr~group*modality + (1+modality|subj) + (1|trial_order), data = acc_trial,
    family = binomial, 
    contrasts = list(modality = c(-1, 1), group = c(-1,1)),
    control=glmerControl(optimizer = "bobyqa",
                              check.nobs.vs.nRE="ignore"))

summary(logacc_mod)

# logacc_dom_gender <-
#   glmer(corr~group*domain*modality + gender + group:gender + (1+domain|subj) + (0+modality|subj) + (1|trial_order), data = acc_trial,
#     family = binomial, 
#     contrasts = list(domain = c(-1, 1), modality = c(-1, 1), group = c(-1,1), gender = c(-1, 1)),
#     control=glmerControl(optimizer = "bobyqa",
#                               check.nobs.vs.nRE="ignore"))
# 
# summary(logacc_dom_gender)
```

# GLMER results for adults vs. TD children
```{r}
library(stringr)

acc_trial_adult$task <- as.factor(acc_trial_adult$task)
acc_trial_adult$subj <- as.factor(acc_trial_adult$subj)
acc_trial_adult$corr <- as.numeric(as.character(acc_trial_adult$corr))

acc_trial_td_adult <- acc_trial_adult[which(str_detect(acc_trial_adult$group, "TD|adult")),]

acc_trial_td_adult$domain <- 
  factor(acc_trial_td_adult$domain,
         levels = c("nonling", 
                    "ling"))

acc_trial_td_adult$modality <- 
  factor(acc_trial_td_adult$modality,
         levels = c("auditory", 
                    "visual"))

acc_trial_td_adult$group <- 
  factor(acc_trial_td_adult$group,
         levels = c("TD", 
                    "adult"))

acc_trial_td_adult$task <- 
  factor(acc_trial_td_adult$task,
         levels = c("vsl", 
                    "lsl",
                    "ssl",
                    "tsl"))

logacc_td <-
  glmer(corr~group*task + (1+task|subj), data = acc_trial_td_adult,
        contrasts = list(group = c(-1, 1)
                         ), family = binomial,
        control=glmerControl(optimizer = "bobyqa",
                              check.nobs.vs.nRE="ignore"))

summary(logacc_td)


logacc_td_dom <-
  glmer(corr~group*domain*modality + (1+domain|subj) + (0+modality|subj) + (1|trial_order), 
        data = acc_trial_td_adult,
    family = binomial, 
    contrasts = list(domain = c(-1, 1), modality = c(-1, 1), group = c(-1, 1)),
    control=glmerControl(optimizer = "bobyqa",
                              check.nobs.vs.nRE="ignore"))

summary(logacc_td_dom)
```

```{r, eval = F}
acc_trial_adult$domain <- 
  factor(acc_trial_adult$domain,
         levels = c("nonling", 
                    "ling"))

acc_trial_adult$modality <- 
  factor(acc_trial_adult$modality,
         levels = c("auditory", 
                    "visual"))

logacc_adult <-
  glmer(corr~group*task + (1+task|subj), data = acc_trial_adult,
        contrasts = list(group = cMat
                         # task = contr.sum(n=4)
                         ), family = binomial)

summary(logacc_adult)


logacc_adult_dom <-
  glmer(corr~group*domain*modality + (1+domain|subj) + (0+modality|subj) + (1|trial_order), data = acc_trial_adult,
    family = binomial, 
    contrasts = list(domain = c(-1, 1), modality = c(-1, 1), group = cMat),
    control=glmerControl(optimizer = "bobyqa",
                              check.nobs.vs.nRE="ignore"))

summary(logacc_adult_dom)
```


# By trial RT LMER (Need to use Scale RT for by trial RT LMER? Outlier removed)
# To Do: Scale mean RT? Add target image as a random effect
```{r, include = F}
input_path5 <-
  "my_path/blast_online_data/data_summaries/blast_online_child/breakdown/acc_by_trial/rt_by_trial"

input_path6 <-
  "my_path/spoli/data_summaries/breakdown/rt_by_trial"

input_path7 <-
  "my_path/blast_online_data/data_summaries/blast_online_adult/breakdown/rt_by_trial"

rtlist <-
  list.files(path = input_path5,
             pattern = "*by_trial.csv", full.names = T)

rtlistSpl <-
  list.files(path = input_path6,
             pattern = "*by_trial.csv", full.names = T)

rtlistAd <-
  list.files(path = input_path7,
             pattern = "*by_trial.csv", full.names = T)

library("stringr")

fname <- str_extract(basename(rtlist), "(?<=blast_)\\S{3}")
fnameSpl <- str_extract(basename(rtlistSpl), "(?<=spoli_)\\S{3}")
fnameAd <- str_extract(basename(rtlistAd), "(?<=blast_)\\S{3}")


rt_trial <- lapply(rtlist, read.csv)
rt_trialSpl <- lapply(rtlistSpl, read.csv)
rt_trialAd <- lapply(rtlistAd, read.csv)

for (i in 1:length(rt_trial)) {
  rt_trial[[i]]$task <-fname[i]
}

for (i in 1:length(rt_trialSpl)) {
  rt_trialSpl[[i]]$task <-fnameSpl[i]
}

for (i in 1:length(rt_trialAd)) {
  rt_trialAd[[i]]$task <-fnameAd[i]
}


for (i in 2:length(rt_trial)) {
  rt_trial[[i]] <- rt_trial[[i]][,-6]
}

for (i in 2:length(rt_trialSpl)) {
  rt_trialSpl[[i]] <- rt_trialSpl[[i]][,-6]
}

for (i in 2:length(rt_trialAd)) {
  rt_trialAd[[i]] <- rt_trialAd[[i]][,-6]
}

rt_trial[[1]]$id <- str_extract(rt_trial[[1]]$id, "\\S+(?=_lsl)")
rt_trialSpl[[1]]$id <- str_extract(rt_trialSpl[[1]]$id, "\\S+(?=_lsl)")
rt_trialAd[[1]]$id <- str_extract(rt_trialAd[[1]]$id, "\\S+(?=_lsl)")

# Save TD by trial VSL RT for BOLD Lab
# vslRTtriaTD <- rt_trial[[4]][which(rt_trial[[4]]$id %in% bucld_all_completed[which(bucld_all_completed$group == "TD"), "part_id"]),]
#
# vslRTtriaTD <- vslRTtriaTD[,c(4,5,3)]
#
# # write.csv(vslRTtriaTD, "vslRTtriaTD.csv", row.names = F)

rt_trial <- do.call(rbind, rt_trial)
rt_trialSpl <- do.call(rbind, rt_trialSpl)
rt_trialAd <- do.call(rbind, rt_trialAd)

rt_trialAd <- rt_trialAd[,!names(rt_trialAd) %in% "X"]

rt_trial <- rbind(rt_trial, rt_trialSpl)

rt_trial <- rt_trial[,!names(rt_trial) %in% "X"]

if(length(ssl_rt_outlier) != 0) {
  rt_trial <-
  rt_trial[-which(
    rt_trial$id %in% ssl_rt_outlier &
      rt_trial$task == "ssl"),]
}

if(length(tsl_rt_outlier) != 0) {
  rt_trial <-
  rt_trial[-which(
    rt_trial$id %in% tsl_rt_outlier &
      rt_trial$task == "tsl"),]
}

if(length(vsl_rt_outlier) != 0) {
  rt_trial <-
  rt_trial[-which(
    rt_trial$id %in% vsl_rt_outlier &
      rt_trial$task == "vsl"),]
}

if(length(lsl_rt_outlier) != 0) {
  rt_trial <-
  rt_trial[-which(
    rt_trial$id %in% lsl_rt_outlier &
      rt_trial$task == "lsl"),]
}

rt_trial <-
  merge(rt_trial,
      bucld_all_completed[,c("part_id", "group", "gender", "age_at_web_month", "age_at_web_year")],
      by.x = "id",
      by.y = "part_id",
      all.y = T)

setdiff(unique(bucld_all_completed$part_id), unique(rt_trial$id))

rt_trial <- rt_trial[which(rt_trial$id %in% bucld_all_completed$part_id),]

# TD outliers are already removed
rt_trialTD <- rt_trial[which(str_detect(rt_trial$group, "TD")),]

rt_trialAd <-
  merge(rt_trialAd,
      blast_adult_wide[,c("part_id", "group", "gender", "age_at_web_month", "age_at_web_year")],
      by.x = "id",
      by.y = "part_id",
      all.y = T)

setdiff(unique(rt_trialAd$id), unique(blast_adult_wide$part_id))

rt_trial_td_adult <- rbind(rt_trialTD, rt_trialAd)

if(length(ssl_rt_outlierA) != 0) {
  rt_trial_td_adult <-
  rt_trial_td_adult[-which(
    rt_trial_td_adult$id %in% ssl_rt_outlierA &
      rt_trial_td_adult$task == "ssl"),]
}

if(length(tsl_rt_outlierA) != 0) {
  rt_trial_td_adult <-
  rt_trial_td_adult[-which(
    rt_trial_td_adult$id %in% tsl_rt_outlierA &
      rt_trial_td_adult$task == "tsl"),]
}

if(length(vsl_rt_outlierA) != 0) {
  rt_trial_td_adult <-
  rt_trial_td_adult[-which(
    rt_trial_td_adult$id %in% vsl_rt_outlierA &
      rt_trial_td_adult$task == "vsl"),]
}

if(length(lsl_rt_outlierA) != 0) {
  rt_trial_td_adult <-
  rt_trial_td_adult[-which(
    rt_trial_td_adult$id %in% lsl_rt_outlierA &
      rt_trial_td_adult$task == "lsl"),]
}

rt_trial <- add_dom_mod_func(rt_trial)
rt_trial_td_adult <- add_dom_mod_func(rt_trial_td_adult)
```

# By trial RT results in children
```{r}
head(rt_trial)

rt_trial$reaction_time <- as.numeric(as.character(rt_trial$reaction_time))
rt_trial$id <- as.factor(rt_trial$id)
rt_trial$task <- as.factor(rt_trial$task)
rt_trial$targ_index <- as.numeric(as.character(rt_trial$targ_index))


rt_trial$task <- 
  factor(rt_trial$task,
         levels = c("lsl", 
                    "ssl", 
                    "vsl", 
                    "tsl"))

rt_trial$group <- 
  factor(rt_trial$group,
         levels = c("ASD", 
                    "TD"))

rt_trial$domain <- 
  factor(rt_trial$domain,
         levels = c("nonling", 
                    "ling"))

rt_trial$modality <- 
  factor(rt_trial$modality,
         levels = c("auditory", 
                    "visual"))

lmerrt_trial <-
  lmer(reaction_time~group*targ_index*task  + (1+task|id), data = rt_trial,
       contrasts = list(group = c(-1,1)),
       control=lmerControl(optimizer = "bobyqa",
                              check.nobs.vs.nRE="ignore"))

summary(lmerrt_trial)


lmerrt_trial_dom <-
  lmer(reaction_time~group*targ_index*domain*modality  + (1+domain|id) + (0+modality|id), 
       data = rt_trial,
       contrasts = list(group = c(-1,1),
                        modality = c(-1, 1),
                        domain = c(-1, 1)),
       control=lmerControl(optimizer = "bobyqa",
                              check.nobs.vs.nRE="ignore"))

summary(lmerrt_trial_dom)
```

```{r, include = F}
rt_trial_td_adult$reaction_time <- as.numeric(as.character(rt_trial_td_adult$reaction_time))
rt_trial_td_adult$id <- as.factor(rt_trial_td_adult$id)
rt_trial_td_adult$task <- as.factor(rt_trial_td_adult$task)
rt_trial_td_adult$targ_index <- as.numeric(as.character(rt_trial_td_adult$targ_index))
```

# By trial RT results in adults vs. TD
```{r}
rt_trial_td_adult$task <- 
  factor(rt_trial_td_adult$task,
         levels = c("lsl", 
                    "ssl", 
                    "vsl", 
                    "tsl"))

rt_trial_td_adult$group <- 
  factor(rt_trial_td_adult$group,
         levels = c("TD", 
                    "adult"))

rt_trial_td_adult$domain <- 
  factor(rt_trial_td_adult$domain,
         levels = c("nonling", 
                    "ling"))

rt_trial_td_adult$modality <- 
  factor(rt_trial_td_adult$modality,
         levels = c("auditory", 
                    "visual"))

lmerrt_trial_adult <-
  lmer(reaction_time~group*targ_index*task  + (1+task|id), data = rt_trial_td_adult,
       contrasts = list(group = c(-1,1)),
       control=lmerControl(optimizer = "bobyqa",
                              check.nobs.vs.nRE="ignore"))

summary(lmerrt_trial_adult)

lmerrt_trial_adult_dom <-
  lmer(reaction_time~group*targ_index*domain*modality  + (1+domain|id) + (0+modality|id), data = rt_trial_td_adult,
       contrasts = list(group = c(-1,1),
                        modality = c(-1,1),
                        domain = c(-1,1)),
       control=lmerControl(optimizer = "bobyqa",
                              check.nobs.vs.nRE="ignore"))

summary(lmerrt_trial_adult_dom)
```

# Prep Plotting
```{r}
#bucld_all_completed <- bucld_all_completed[,-c(1)]
bucld_sl_bar_all <-  bucld_all_completed[,c(which(str_detect(colnames(bucld_all_completed), 
                                          "part_id|group|ssl|lsl|vsl|tsl")))]
```


# Accuracy Line Plot (no outliers)
# SL Accuracy Descriptive Stat
```{r}
library(plyr)
library(dplyr)
library(ggplot2)
library(data.table)

library("pastecs")

stat_desc <- 
function(df,group,task) {
  stat.desc(df[which(df$group == group & df$variable == task),])
}

bucld_sl_bar_all_long <- melt(bucld_sl_bar_all, id.vars=c("part_id", "group"))

bucld_sl_bar_acc <-
  bucld_sl_bar_all_long[which(str_detect(
    bucld_sl_bar_all_long$variable, "(?<=accuracy_children_)\\S{3}(?=_accuracies)")),]

bucld_sl_bar_acc$variable <-
revalue(bucld_sl_bar_acc$variable, c("accuracy_children_lsl_accuracies"="Letter",
                                     "accuracy_children_vsl_accuracies"="Image",
                                     "accuracy_children_tsl_accuracies"="Tone",
                                     "accuracy_children_ssl_accuracies"="Syllable"))

bucld_sl_bar_acc$variable <- 
  factor(bucld_sl_bar_acc$variable,levels = c("Image", 
                                              "Letter", 
                                              "Tone", 
                                              "Syllable"))

bucld_sl_bar_acc <-
  bucld_sl_bar_acc[order(bucld_sl_bar_acc$variable), ]

bucld_sl_bar_acc$value <- 
  as.numeric(as.character(bucld_sl_bar_acc$value))

td_tone <- stat_desc(bucld_sl_bar_acc, "TD", "Tone")
td_syllable <- stat_desc(bucld_sl_bar_acc, "TD", "Syllable")
td_image <- stat_desc(bucld_sl_bar_acc, "TD", "Image")
td_letter <- stat_desc(bucld_sl_bar_acc, "TD", "Letter")
asd_tone <- stat_desc(bucld_sl_bar_acc, "ASD", "Tone")
asd_syllable <- stat_desc(bucld_sl_bar_acc, "ASD", "Syllable")
asd_image <- stat_desc(bucld_sl_bar_acc, "ASD", "Image")
asd_letter <- stat_desc(bucld_sl_bar_acc, "ASD", "Letter") 

extract_line_graph_stat <- function (x, group, task) {
y <- x[c("nbr.val","mean", "SE.mean", "std.dev"),"value"]
dim(y) <- c(4, 1)
y <- t(y)
colnames(y) <- c("n", "mean", "std_error", "sd")
y <- data.frame(y)
y$group <- group
y$task <- task


return(y)
}

td_tone_stat <- extract_line_graph_stat(td_tone, "TD", "Tone")
td_syllable_stat <- extract_line_graph_stat(td_syllable, "TD", "Syllable")
td_image_stat <- extract_line_graph_stat(td_image, "TD", "Image")
td_letter_stat <- extract_line_graph_stat(td_letter, "TD", "Letter")

asd_tone_stat <- extract_line_graph_stat(asd_tone, "ASD", "Tone")
asd_syllable_stat <- extract_line_graph_stat(asd_syllable, "ASD", "Syllable")
asd_image_stat <- extract_line_graph_stat(asd_image, "ASD", "Image")
asd_letter_stat <- extract_line_graph_stat(asd_letter, "ASD", "Letter")


acc_stat <- rbind(td_tone_stat, td_syllable_stat, td_image_stat, td_letter_stat, 
                  asd_tone_stat, asd_syllable_stat, asd_image_stat, asd_letter_stat)

colnames(acc_stat)[colnames(acc_stat) == "group"] <- "Group"

acc_stat$task <- 
  factor(acc_stat$task,levels = c("Image", 
                                              "Letter", 
                                              "Tone", 
                                              "Syllable"))

acc_stat <-
  acc_stat[order(acc_stat$task), ]

cast(acc_stat, task~Group, value = "mean")
cast(acc_stat, task~Group, value = "sd")

library(reshape)
acc_stat_descrip <- acc_stat[,c("Group", "task", "mean", "sd")]
acc_stat_mean <- cast(acc_stat_descrip, task~Group, value = "mean")
acc_stat_sd <- cast(acc_stat_descrip, task~Group, value = "sd")
acc_stat_across_sd <- cbind(acc_stat_mean, acc_stat_sd)
acc_stat_across_sd[,c(2:3, 5:6)] <- round(acc_stat_across_sd[,c(2:3, 5:6)], 2)

# write.csv(acc_stat_across_sd, "srcd_figure/acc_stat.csv")

```


# SL Accuracy within subject error 
```{r, include = F}
summarySEwithin <- function(data=NULL, measurevar, betweenvars=NULL, withinvars=NULL,
                            idvar=NULL, na.rm=FALSE, conf.interval=.95, .drop=TRUE) {

  # Ensure that the betweenvars and withinvars are factors
  factorvars <- vapply(data[, c(betweenvars, withinvars), drop=FALSE],
    FUN=is.factor, FUN.VALUE=logical(1))

  if (!all(factorvars)) {
    nonfactorvars <- names(factorvars)[!factorvars]
    message("Automatically converting the following non-factors to factors: ",
            paste(nonfactorvars, collapse = ", "))
    data[nonfactorvars] <- lapply(data[nonfactorvars], factor)
  }

  # Get the means from the un-normed data
  datac <- summarySE(data, measurevar, groupvars=c(betweenvars, withinvars),
                     na.rm=na.rm, conf.interval=conf.interval, .drop=.drop)

  # Drop all the unused columns (these will be calculated with normed data)
  datac$sd <- NULL
  datac$se <- NULL
  datac$ci <- NULL

  # Norm each subject's data
  ndata <- normDataWithin(data, idvar, measurevar, betweenvars, na.rm, .drop=.drop)

  # This is the name of the new column
  measurevar_n <- paste(measurevar, "_norm", sep="")

  # Collapse the normed data - now we can treat between and within vars the same
  ndatac <- summarySE(ndata, measurevar_n, groupvars=c(betweenvars, withinvars),
                      na.rm=na.rm, conf.interval=conf.interval, .drop=.drop)

  # Apply correction from Morey (2008) to the standard error and confidence interval
  #  Get the product of the number of conditions of within-S variables
  nWithinGroups    <- prod(vapply(ndatac[,withinvars, drop=FALSE], FUN=nlevels,
                           FUN.VALUE=numeric(1)))
  correctionFactor <- sqrt( nWithinGroups / (nWithinGroups-1) )

  # Apply the correction factor
  ndatac$sd <- ndatac$sd * correctionFactor
  ndatac$se <- ndatac$se * correctionFactor
  ndatac$ci <- ndatac$ci * correctionFactor

  # Combine the un-normed means with the normed results
  merge(datac, ndatac)
}

summarySE <- function(data=NULL, measurevar, groupvars=NULL, na.rm=FALSE,
                      conf.interval=.95, .drop=TRUE) {
    library(plyr)

    # New version of length which can handle NA's: if na.rm==T, don't count them
    length2 <- function (x, na.rm=FALSE) {
        if (na.rm) sum(!is.na(x))
        else       length(x)
    }

    # This does the summary. For each group's data frame, return a vector with
    # N, mean, and sd
    datac <- ddply(data, groupvars, .drop=.drop,
      .fun = function(xx, col) {
        c(N    = length2(xx[[col]], na.rm=na.rm),
          mean = mean   (xx[[col]], na.rm=na.rm),
          sd   = sd     (xx[[col]], na.rm=na.rm)
        )
      },
      measurevar
    )

    # Rename the "mean" column    
    datac <- rename(datac, c("mean" = measurevar))

    datac$se <- datac$sd / sqrt(datac$N)  # Calculate standard error of the mean

    # Confidence interval multiplier for standard error
    # Calculate t-statistic for confidence interval: 
    # e.g., if conf.interval is .95, use .975 (above/below), and use df=N-1
    ciMult <- qt(conf.interval/2 + .5, datac$N-1)
    datac$ci <- datac$se * ciMult

    return(datac)
}

normDataWithin <- function(data=NULL, idvar, measurevar, betweenvars=NULL,
                           na.rm=FALSE, .drop=TRUE) {
    library(plyr)

    # Measure var on left, idvar + between vars on right of formula.
    data.subjMean <- ddply(data, c(idvar, betweenvars), .drop=.drop,
     .fun = function(xx, col, na.rm) {
        c(subjMean = mean(xx[,col], na.rm=na.rm))
      },
      measurevar,
      na.rm
    )

    # Put the subject means with original data
    data <- merge(data, data.subjMean)

    # Get the normalized data in a new column
    measureNormedVar <- paste(measurevar, "_norm", sep="")
    data[,measureNormedVar] <- data[,measurevar] - data[,"subjMean"] +
                               mean(data[,measurevar], na.rm=na.rm)

    # Remove this subject mean column
    data$subjMean <- NULL

    return(data)
}
```

```{r}
detach(package:plyr)

acc_within_stat <- summarySEwithin(bucld_sl_bar_acc, measurevar="value", betweenvars = "group",
                                   withinvars="variable", idvar="part_id", na.rm=T, conf.interval=.95)

acc_within_stat_adult <- summarySEwithin(all_acc, measurevar="accuracy", betweenvars = "group",
                                   withinvars="task", idvar="part_id", na.rm=T, conf.interval=.95)



colnames(acc_within_stat)[colnames(acc_within_stat) == "group"] <- "Group"

colnames(acc_within_stat_adult)[colnames(acc_within_stat_adult) == "group"] <- "Group"

acc_within_stat$variable <- 
  factor(acc_within_stat$variable,levels = c("Image", 
                                              "Letter", 
                                              "Tone", 
                                              "Syllable"))


acc_within_stat_adult$task <-
revalue(acc_within_stat_adult$task, c("lsl_accuracies"="Letter",
                                     "vsl_accuracies"="Image",
                                     "tsl_accuracies"="Tone",
                                     "ssl_accuracies"="Syllable"))

acc_within_stat_adult$task <- 
  factor(acc_within_stat_adult$task,levels = c("Image", 
                                              "Letter", 
                                              "Tone", 
                                              "Syllable"))

acc_within_stat_adult$Group <- 
  factor(acc_within_stat_adult$Group,levels = c("ASD", 
                                              "TD", 
                                              "adult"))
```

```{r}

pd <- position_dodge(width = 0.2)

acc_within_stat %>%
  ggplot(aes(x = variable, y = value, group = Group)) +
  geom_line(aes(linetype = Group, color = Group), position = pd, size = 1.8) +
   geom_errorbar(aes(ymin = value - se, ymax = value + se), width = .1, position = pd) +
     geom_point(aes(color = Group), size = 4, position = pd,show.legend = FALSE) + 
          geom_point(size = 3, color = "white", position = pd) +
      labs(title = "SL Accuracy against Chance-level",
         x = "SL Task",  # Change x-axis label
         y = "Mean Accuracy (%)") +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(
        plot.title = element_text(size=16, face="bold"),
        axis.title.x = element_text(size=14, face="bold"),
        axis.title.y = element_text(size=14, face="bold"),
        axis.text=element_text(size=12, face = "bold")
        ) +
  theme(legend.text=element_text(size=14, face="bold"),
        legend.title=element_text(size=15, face="bold")) +
   theme(
    panel.background = element_rect(fill = "white"),         # Set plot background to white
    legend.key  = element_rect(fill = "white"),              # Set legend item backgrounds to white
    axis.line.x = element_line(colour = "black", size = 1),  # Add line to x axis
    axis.line.y = element_line(colour = "black", size = 1)   # Add line to y axis
  ) +
  geom_hline(yintercept=0.5, color = "grey") +
  geom_text(aes(x= 1, y = 0.505, label = paste0("chance", "-level")), size=5) +
   geom_text(aes(x= 1.05, y = 0.7, label = paste0("***")), size=7, color="#00BFC4") +
  geom_text(aes(x= 2.05, y = 0.7, label = paste0("***")), size=7, color="#00BFC4") +
  geom_text(aes(x= 3.05, y = 0.7, label = paste0("**")), size=7, color="#00BFC4") +
  geom_text(aes(x= 4.05, y = 0.7, label = paste0("**")), size=7, color="#00BFC4") +
  # geom_text(aes(x= 4.05, y = 0.7, label = paste0("")), size=7, color="#00BFC4") +
  geom_text(aes(x= 0.95, y = 0.51, label = paste0("*")), size=7, color="#F8766d") +
  geom_text(aes(x= 1.95, y = 0.51, label = paste0("")), size=7, color="#F8766d") +
   geom_text(aes(x= 2.95, y = 0.51, label = paste0("**")), size=7, color="#F8766d") +
  geom_text(aes(x= 3.95, y = 0.494, label = paste0("*")), size=7, color="#F8766d") 

# ggsave("paper_analysis_matched/behavioral_acc_across_group.png",
#        bg="transparent",width = 15, height = 15, units = "cm")
```

```{r}
pd <- position_dodge(width = 0.2)

acc_within_stat_td_adult <- 
  acc_within_stat_adult[which(str_detect(acc_within_stat_adult$Group, "adult|TD")),] 

acc_within_stat_td_adult %>%
  ggplot(aes(x = task, y = accuracy, group = Group)) +
  geom_line(aes(linetype = Group, color = Group), position = pd, size = 1.8) +
   geom_errorbar(aes(ymin = accuracy - se, ymax = accuracy + se), width = .1, position = pd) +
     geom_point(aes(color = Group), size = 4, position = pd,show.legend = FALSE) + 
          geom_point(size = 3, color = "white", position = pd) +
      labs(title = "SL Accuracy against Chance-level",
         x = "SL Task",  # Change x-axis label
         y = "Mean Accuracy (%)") +
  theme(plot.title = element_text(hjust = 0.5)) +
  # scale_color_manual(values=c('#F8766d', '#00BFC4',"black"))+
  scale_color_manual(values=c('#00BFC4', "black")) +
  theme(
        plot.title = element_text(size=16, face="bold"),
        axis.title.x = element_text(size=14, face="bold"),
        axis.title.y = element_text(size=14, face="bold"),
        axis.text=element_text(size=12, face = "bold")
        ) +
  theme(legend.text=element_text(size=14, face="bold"),
        legend.title=element_text(size=15, face="bold")) +
   theme(
    panel.background = element_rect(fill = "white"),         # Set plot background to white
    legend.key  = element_rect(fill = "white"),              # Set legend item backgrounds to white
    axis.line.x = element_line(colour = "black", size = 1),  # Add line to x axis
    axis.line.y = element_line(colour = "black", size = 1)   # Add line to y axis
  ) +
  geom_hline(yintercept=0.5, color = "grey") +
  geom_text(aes(x= 1, y = 0.505, label = paste0("chance", "-level")), size=5) +
   geom_text(aes(x= 1.05, y = 0.51, label = paste0("***")), size=7, color="#00BFC4") +
  geom_text(aes(x= 2.05, y = 0.51, label = paste0("***")), size=7, color="#00BFC4") +
  geom_text(aes(x= 3.05, y = 0.51, label = paste0("**")), size=7, color="#00BFC4") +
  geom_text(aes(x= 4.05, y = 0.51, label = paste0("**")), size=7, color="#00BFC4") +
  # geom_text(aes(x= 4.05, y = 0.7, label = paste0("")), size=7, color="#00BFC4") +
  # geom_text(aes(x= 0.95, y = 0.51, label = paste0("**")), size=7, color="#F8766d") +
  # geom_text(aes(x= 1.95, y = 0.51, label = paste0("")), size=7, color="#F8766d") +
  #  geom_text(aes(x= 2.95, y = 0.51, label = paste0("**")), size=7, color="#F8766d") +
  # geom_text(aes(x= 3.95, y = 0.494, label = paste0("*")), size=7, color="#F8766d") +
 geom_text(aes(x= 1.05, y = 0.87, label = paste0("***")), size=7, color="black") +
  geom_text(aes(x= 2.05, y = 0.87, label = paste0("***")), size=7, color="black") +
  geom_text(aes(x= 3.05, y = 0.87, label = paste0("***")), size=7, color="black") +
  geom_text(aes(x= 4.05, y = 0.87, label = paste0("***")), size=7, color="black")

# ggsave("paper_analysis_matched/behavioral_acc_across_adult_td.png",
# bg="transparent",
# width = 15, height = 15, units = "cm")
```
# Accuracy Bar Plot in Linguistics Task
```{r, include = F}

pd <- position_dodge(width = 0.2)

library(ggbeeswarm)
acc_bar <- bucld_sl_bar_acc 
colnames(acc_bar)[colnames(acc_bar) == "group"] <- "Group"
acc_bar[which(acc_bar$variable == "Letter" | acc_bar$variable == "Syllable"),] %>%
  ggplot(aes(x = variable, y = value)) +
  geom_bar(
    aes(fill = Group),
    position = position_dodge(),
    width = 0.9,
    stat = "summary",
    fun.y = "mean",
  ) +
 labs(title = "Behavioral Accuracy in Linguistic SL",
         x = "SL Task",  # Change x-axis label
         y = "Mean Accuracy") +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(
        plot.title = element_text(size=16, face="bold"),
        axis.title.x = element_text(size=14, face="bold"),
        axis.title.y = element_text(size=14, face="bold"),
        axis.text=element_text(size=12, face = "bold")
        ) +
  theme(legend.text=element_text(size=14, face="bold"),
        legend.title=element_text(size=15, face="bold")) +
   theme(
    panel.background = element_rect(fill = "white"),         # Set plot background to white
    legend.key  = element_rect(fill = "white"),              # Set legend item backgrounds to white
    axis.line.x = element_line(colour = "black", size = 1),  # Add line to x axis
    axis.line.y = element_line(colour = "black", size = 1)   # Add line to y axis
  ) + 
  geom_beeswarm(
    aes(fill = Group),
    dodge.width = 1,
    cex = 2.5,
    size = 0.8,
    show.legend = FALSE
  ) + 
  geom_text(aes(x= 1, y = 1.04, label = paste0("**")), size=7) +
  geom_segment(aes(x=0.75,xend=1.25, y = 1.02, yend = 1.02)) +
  geom_segment(aes(x=0.75,xend=0.75, yend = 1, y = 1.02)) +
  geom_segment(aes(x=1.25,xend=1.25, yend = 1, y = 1.02)) +
  geom_text(aes(x= 2, y = 1.06, label = paste0("")), size=7) +
  geom_segment(aes(x=1.75,xend=2.25, y = 1.02, yend = 1.02)) +
  geom_segment(aes(x=1.75,xend=1.75, yend = 1, y = 1.02)) +
  geom_segment(aes(x=2.25,xend=2.25, yend = 1, y = 1.02))

```



```{r}
library(ggbeeswarm)
acc_bar <- bucld_sl_bar_acc 
colnames(acc_bar)[colnames(acc_bar) == "group"] <- "Group"
acc_bar %>%
  ggplot(aes(x = variable, y = value)) +
  geom_bar(
    aes(fill = Group),
    position = position_dodge(),
    width = 0.9,
    stat = "summary",
    fun.y = "mean",
  ) +
 labs(title = "SL Accuracy Between Group Comparison",
         x = "SL Task",  # Change x-axis label
         y = "Mean Accuracy") +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(
        plot.title = element_text(size=16, face="bold"),
        axis.title.x = element_text(size=14, face="bold"),
        axis.title.y = element_text(size=14, face="bold"),
        axis.text=element_text(size=12, face = "bold")
        ) +
  theme(legend.text=element_text(size=14, face="bold"),
        legend.title=element_text(size=15, face="bold")) +
   theme(
    panel.background = element_rect(fill = "white"),         # Set plot background to white
    legend.key  = element_rect(fill = "white"),              # Set legend item backgrounds to white
    axis.line.x = element_line(colour = "black", size = 1),  # Add line to x axis
    axis.line.y = element_line(colour = "black", size = 1)   # Add line to y axis
  ) + 
  geom_beeswarm(
    aes(fill = Group),
    dodge.width = 1,
    cex = 2.5,
    size = 0.8,
    show.legend = FALSE
  ) + 
  # geom_text(aes(x= 1, y = 1.04, label = paste0("")), size=7) +
  # geom_segment(aes(x=0.75,xend=1.25, y = 1.02, yend = 1.02)) +
  # geom_segment(aes(x=0.75,xend=0.75, yend = 1, y = 1.02)) +
  # geom_segment(aes(x=1.25,xend=1.25, yend = 1, y = 1.02)) +
  # geom_text(aes(x= 2, y = 1.06, label = paste0("*")), size=7) +
  geom_segment(aes(x=1.75,xend=2.25, y = 1.02, yend = 1.02)) +
  geom_segment(aes(x=1.75,xend=1.75, yend = 1, y = 1.02)) +
  geom_segment(aes(x=2.25,xend=2.25, yend = 1, y = 1.02)) +
   geom_segment(aes(x=0.75,xend=1.25, y = 1.02, yend = 1.02)) +
  geom_segment(aes(x=0.75,xend=0.75, yend = 1, y = 1.02)) +
  geom_segment(aes(x=1.25,xend=1.25, yend = 1, y = 1.02)) +
  geom_text(aes(x= 1, y = 1.06, label = paste0("")), size=7) +
  geom_text(aes(x= 2, y = 1.06, label = paste0("")), size=7) +
  # geom_segment(aes(x=2.75,xend=3.25, y = 1.02, yend = 1.02)) +
  # geom_segment(aes(x=2.75,xend=2.75, yend = 1, y = 1.02)) +
  # geom_segment(aes(x=2.25,xend=2.25, yend = 1, y = 1.02)) +
   geom_text(aes(x= 4, y = 1.06, label = paste0("*")), size=7) +
  geom_segment(aes(x=3.75,xend=4.25, y = 1.02, yend = 1.02)) +
  geom_segment(aes(x=3.75,xend=3.75, yend = 1, y = 1.02)) +
  geom_segment(aes(x=4.25,xend=4.25, yend = 1, y = 1.02)) 

# ggsave("srcd_figure/behavioral_acc_ling_bar.png",
       # bg="transparent",
       # # ggsave = 15, height = 15, units = "cm")
```

# JoVE accuracy bar plot TD
```{r}
library(ggbeeswarm)

acc_bar[which(acc_bar$Group == "TD"),] %>%
  ggplot(aes(x = variable, y = value)) +
  geom_bar(
    position = position_dodge(),
    fill = "grey",
    # ggsave = 0.5,
    stat = "summary",
    fun.y = "mean"
  ) +
 labs(title = "SL Accuracy Against Chance",
         x = "SL Condition",  # Change x-axis label
         y = "Mean Accuracy (%)") +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(
        plot.title = element_text(size=16, face="bold"),
        axis.title.x = element_text(size=14, face="bold"),
        axis.title.y = element_text(size=14, face="bold"),
        axis.text=element_text(size=12, face = "bold")
        ) +
  theme(legend.text=element_text(size=14, face="bold"),
        legend.title=element_text(size=15, face="bold")) +
   theme(
    panel.background = element_rect(fill = "white"),         # Set plot background to white
    legend.key  = element_rect(fill = "white"),              # Set legend item backgrounds to white
    axis.line.x = element_line(colour = "black", size = 1),  # Add line to x axis
    axis.line.y = element_line(colour = "black", size = 1)   # Add line to y axis
  ) + 
  geom_beeswarm(
    dodge.width = 1,
    cex = 2.5,
    size = 1.2,
    show.legend = FALSE
  ) + 
  # geom_text(aes(x= 1, y = 1.04, label = paste0("")), size=7) +
  # geom_segment(aes(x=0.75,xend=1.25, y = 1.02, yend = 1.02)) +
  # geom_segment(aes(x=0.75,xend=0.75, yend = 1, y = 1.02)) +
  geom_hline(yintercept=0.5, color = "red", size = 0.5, stat="density", alpha=0.6) +
  # geom_text(aes(x= 0.8, y = 0.51, label = paste0("chance", "-level")), size=5) +
  geom_text(aes(x= 2, y = 1.02, label = paste0("**")), size=7, color="red") +
  geom_text(aes(x= 3, y = 1.02, label = paste0("**")), size=7, color="red") +
  geom_text(aes(x= 1, y = 1.02, label = paste0("**")), size=7, color="red") +
  geom_text(aes(x= 4, y = 1.02, label = paste0("*")), size=6, color="red")

# ggsave("barPlotTD.png",
       # bg="transparent",
       # width = 15, height = 15, units = "cm")
```




## Accuracy Boxplot for TD JoVE paper
```{r}
acc_bar[which(acc_bar$Group == "TD"),] %>%
  ggplot(aes(x = variable, y = value)) +
  geom_boxplot(
  ) +
 labs(title = "SL Accuracy Across Conditions",
         x = "SL Condition",  # Change x-axis label
         y = "% Correct") +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(
        plot.title = element_text(size=16, face="bold"),
        axis.title.x = element_text(size=14, face="bold"),
        axis.title.y = element_text(size=14, face="bold"),
        axis.text=element_text(size=12, face = "bold")
        ) +
  theme(legend.text=element_text(size=14, face="bold"),
        legend.title=element_text(size=15, face="bold")) +
   theme(
    panel.background = element_rect(fill = "white"),         # Set plot background to white
    legend.key  = element_rect(fill = "white"),              # Set legend item backgrounds to white
    axis.line.x = element_line(colour = "black", size = 1),  # Add line to x axis
    axis.line.y = element_line(colour = "black", size = 1)   # Add line to y axis
  ) + 
   geom_jitter(shape=16, position=position_jitter(0.2))



# ggsave("boxplot_accTD.png",
       # bg="transparent",
       # width = 15, height = 15, units = "cm")
```


# JoVE accuracy line plot
```{r}

pd <- position_dodge(width = 0.2)

acc_within_stat[which(acc_within_stat$Group == "TD"),] %>%
  ggplot(aes(x = variable, y = value, group = Group)) +
  geom_line(position = pd, size = 1.8) +
   geom_errorbar(aes(ymin = value - se, ymax = value + se), width = .1, position = pd) +
     geom_point(size = 4, position = pd,show.legend = FALSE) + 
          geom_point(size = 3, color = "white", position = pd) +
      labs(title = "SL Mean Accuracy against Chance-level",
         x = "SL Condition",  # Change x-axis label
         y = "% Correct") +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(
        plot.title = element_text(size=16, face="bold"),
        axis.title.x = element_text(size=14, face="bold"),
        axis.title.y = element_text(size=14, face="bold"),
        axis.text=element_text(size=12, face = "bold")
        ) +
  theme(legend.text=element_text(size=14, face="bold"),
        legend.title=element_text(size=15, face="bold")) +
   theme(
    panel.background = element_rect(fill = "white"),         # Set plot background to white
    legend.key  = element_rect(fill = "white"),              # Set legend item backgrounds to white
    axis.line.x = element_line(colour = "black", size = 1),  # Add line to x axis
    axis.line.y = element_line(colour = "black", size = 1)   # Add line to y axis
  ) +
  geom_hline(yintercept=0.5, color = "grey", size = 1.5) +
  geom_text(aes(x= 1, y = 0.507, label = paste0("chance", "-level")), size=7) +
  geom_text(aes(x= 2, y = 0.7, label = paste0("**")), size=6, color="black") +
  geom_text(aes(x= 3, y = 0.7, label = paste0("*")), size=7, color="black") +
  geom_text(aes(x= 1, y = 0.7, label = paste0("*")), size=7, color="black") +
  geom_text(aes(x= 4, y = 0.7, label = paste0("")), size=7, color="black")  


# ggsave("lineplot_accTD.png",
       # bg="transparent",
       # width = 15, height = 15, units = "cm")
```


# Scaled Accuracy Line Plot
```{r} 
library(plyr)
library(dplyr)
library(ggplot2)
library(data.table)

library("pastecs")


bucld_sl_bar_acc <- crossed_random_effect_acc_long

bucld_sl_bar_acc$task <-
revalue(bucld_sl_bar_acc$task, c("lsl"="Letter",
                                     "vsl"="Image",
                                     "tsl"="Tone",
                                     "ssl"="Syllable"))

bucld_sl_bar_acc$task <- 
  factor(bucld_sl_bar_acc$task,levels = c("Image", 
                                              "Letter", 
                                              "Tone", 
                                              "Syllable"))

bucld_sl_bar_acc <-
  bucld_sl_bar_acc[order(bucld_sl_bar_acc$task), ]

bucld_sl_bar_acc$value <- 
  as.numeric(as.character(bucld_sl_bar_acc$value))

stat_desc <- 
function(df,group,task) {
  stat.desc(df[which(df$group == group & df[,"task"] == task),])
}

td_tone <- stat_desc(bucld_sl_bar_acc, "TD", "Tone")
td_syllable <- stat_desc(bucld_sl_bar_acc, "TD", "Syllable")
td_image <- stat_desc(bucld_sl_bar_acc, "TD", "Image")
td_letter <- stat_desc(bucld_sl_bar_acc, "TD", "Letter")
asd_tone <- stat_desc(bucld_sl_bar_acc, "ASD", "Tone")
asd_syllable <- stat_desc(bucld_sl_bar_acc, "ASD", "Syllable")
asd_image <- stat_desc(bucld_sl_bar_acc, "ASD", "Image")
asd_letter <- stat_desc(bucld_sl_bar_acc, "ASD", "Letter") 

extract_line_graph_stat <- function (x, group, task) {
y <- x[c("nbr.val","mean", "SE.mean", "std.dev"),"value"]
dim(y) <- c(4, 1)
y <- t(y)
colnames(y) <- c("n", "mean", "std_error", "sd")
y <- data.frame(y)
y$group <- group
y$task <- task


return(y)
}

td_tone_stat <- extract_line_graph_stat(td_tone, "TD", "Tone")
td_syllable_stat <- extract_line_graph_stat(td_syllable, "TD", "Syllable")
td_image_stat <- extract_line_graph_stat(td_image, "TD", "Image")
td_letter_stat <- extract_line_graph_stat(td_letter, "TD", "Letter")

asd_tone_stat <- extract_line_graph_stat(asd_tone, "ASD", "Tone")
asd_syllable_stat <- extract_line_graph_stat(asd_syllable, "ASD", "Syllable")
asd_image_stat <- extract_line_graph_stat(asd_image, "ASD", "Image")
asd_letter_stat <- extract_line_graph_stat(asd_letter, "ASD", "Letter")


acc_stat <- rbind(td_tone_stat, td_syllable_stat, td_image_stat, td_letter_stat, 
                  asd_tone_stat, asd_syllable_stat, asd_image_stat, asd_letter_stat)

colnames(acc_stat)[colnames(acc_stat) == "group"] <- "Group"

acc_stat$task <- 
  factor(acc_stat$task,levels = c("Image", 
                                              "Letter", 
                                              "Tone", 
                                              "Syllable"))


acc_stat <-
  acc_stat[order(acc_stat$task), ]

cast(acc_stat, task~Group, value = "mean")
cast(acc_stat, task~Group, value = "sd")

pd <- position_dodge(width = 0.2)

```

```{r}
detach(package:plyr)
acc_within_stat <- summarySEwithin(bucld_sl_bar_acc, measurevar="value", betweenvars = "group", withinvars="task",
                        idvar="part_id", na.rm=T, conf.interval=.95)


colnames(acc_within_stat)[colnames(acc_within_stat) == "group"] <- "Group"

acc_within_stat$tasl <- 
  factor(acc_within_stat$task,levels = c("Image", 
                                              "Letter", 
                                              "Tone", 
                                              "Syllable"))


acc_within_stat %>%
  ggplot(aes(x = task, y = value, group = Group)) +
  geom_line(aes(linetype = Group, color = Group), position = pd, size = 1.8) +
   geom_errorbar(aes(ymin = value - se, ymax = value + se), width = .1, position = pd) +
     geom_point(aes(color = Group), size = 4, position = pd,show.legend = FALSE) + 
          geom_point(size = 3, color = "white", position = pd) +
      labs(title = "Behavioral Accuracy across Groups",
         x = "SL Task",  # Change x-axis label
         y = "Scaled Mean Accuracy (arbitrary unit)") +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(
        plot.title = element_text(size=16, face="bold"),
        axis.title.x = element_text(size=14, face="bold"),
        axis.title.y = element_text(size=14, face="bold"),
        axis.text=element_text(size=12, face = "bold")
        ) +
  theme(legend.text=element_text(size=14, face="bold"),
        legend.title=element_text(size=15, face="bold")) +
   theme(
    panel.background = element_rect(fill = "white"),         # Set plot background to white
    legend.key  = element_rect(fill = "white"),              # Set legend item backgrounds to white
    axis.line.x = element_line(colour = "black", size = 1),  # Add line to x axis
    axis.line.y = element_line(colour = "black", size = 1)   # Add line to y axis
  ) 
# +
# geom_hline(yintercept=0.5, color = "grey") +
# geom_text(aes(x= 1, y = 0.505, label = paste0("chance", "-level")), size=5)
# +
  # geom_text(aes(x= 2.05, y = 0.7, label = paste0("**")), size=7, color="#00BFC4") +
  # geom_text(aes(x= 3.05, y = 0.7, label = paste0("")), size=7, color="#00BFC4") +
  # geom_text(aes(x= 1.05, y = 0.7, label = paste0("*")), size=7, color="#00BFC4") +
  # geom_text(aes(x= 4.05, y = 0.7, label = paste0("*")), size=7, color="#00BFC4") +
  # geom_text(aes(x= 0.95, y = 0.52, label = paste0("*")), size=7, color="#F8766d") +
  #  geom_text(aes(x= 2.95, y = 0.52, label = paste0("*")), size=7, color="#F8766d")

# ggsave("behavioral_scaled_acc_across_group.png",
       # bg="transparent",
       # width = 15, height = 15, units = "cm")
```


# Entropy Line Plot (no outliers)
```{r}
library(dplyr)
library(ggplot2)

bucld_sl_bar_all_long <- melt(bucld_sl_bar_all, id.vars=c("part_id", "group"))


bucld_sl_bar_entropy <-
  bucld_sl_bar_all_long[which(
    str_detect(bucld_sl_bar_all_long$variable, "(?<=entropy_children_)\\S{3}(?=_entropy)")),]

bucld_sl_bar_entropy$variable <-
revalue(bucld_sl_bar_entropy$variable, c("entropy_children_lsl_entropy"="Letter",
                                     "entropy_children_vsl_entropy"="Image",
                                     "entropy_children_tsl_entropy"="Tone",
                                     "entropy_children_ssl_entropy"="Syllable"))

bucld_sl_bar_entropy$variable <- 
  factor(bucld_sl_bar_entropy$variable,levels = c("Image", 
                                                  "Letter", 
                                                  "Tone", 
                                                  "Syllable"))

bucld_sl_bar_entropy <-
  bucld_sl_bar_entropy[order(bucld_sl_bar_entropy$variable), ]

bucld_sl_bar_entropy$value <- 
  as.numeric(as.character(bucld_sl_bar_entropy$value))


library("pastecs")
stat_desc <- 
function(df,group,task) {
  stat.desc(df[which(df$group == group & df$variable == task),])
}

td_tone <- stat_desc(bucld_sl_bar_entropy, "TD", "Tone")
td_syllable <- stat_desc(bucld_sl_bar_entropy, "TD", "Syllable")
td_image <- stat_desc(bucld_sl_bar_entropy, "TD", "Image")
td_letter <- stat_desc(bucld_sl_bar_entropy, "TD", "Letter")

asd_tone <- stat_desc(bucld_sl_bar_entropy, "ASD", "Tone")
asd_syllable <- stat_desc(bucld_sl_bar_entropy, "ASD", "Syllable")
asd_image <- stat_desc(bucld_sl_bar_entropy, "ASD", "Image")
asd_letter <- stat_desc(bucld_sl_bar_entropy, "ASD", "Letter")
 
extract_line_graph_stat <- function (x, group, task) {
y <- x[c("nbr.val","mean", "SE.mean"),"value"]
dim(y) <- c(3, 1)
y <- t(y)
colnames(y) <- c("n", "mean", "std_error")
y <- data.frame(y)
y$group <- group
y$task <- task


return(y)
}

td_tone_stat <- extract_line_graph_stat(td_tone, "TD", "Tone")
td_syllable_stat <- extract_line_graph_stat(td_syllable, "TD", "Syllable")
td_image_stat <- extract_line_graph_stat(td_image, "TD", "Image")
td_letter_stat <- extract_line_graph_stat(td_letter, "TD", "Letter")

asd_tone_stat <- extract_line_graph_stat(asd_tone, "ASD", "Tone")
asd_syllable_stat <- extract_line_graph_stat(asd_syllable, "ASD", "Syllable")
asd_image_stat <- extract_line_graph_stat(asd_image, "ASD", "Image")
asd_letter_stat <- extract_line_graph_stat(asd_letter, "ASD", "Letter")



entropy_stat <- rbind(td_tone_stat, td_syllable_stat, td_image_stat, td_letter_stat,
                      asd_tone_stat, asd_syllable_stat, asd_image_stat, asd_letter_stat)

colnames(entropy_stat)[colnames(entropy_stat) == "group"] <- "Group"

entropy_stat$task <- 
  factor(entropy_stat$task,levels = c("Image", 
                                              "Letter", 
                                              "Tone", 
                                              "Syllable"))

entropy_stat <-
  entropy_stat[order(entropy_stat$task), ]


pd <- position_dodge(width = 0.2)

entropy_stat %>%
  ggplot(aes(x = task, y = mean, group = Group)) +
  geom_line(aes(linetype = Group, color = Group), position = pd, size = 1.8) +
   geom_errorbar(aes(ymin = mean - std_error, ymax = mean + std_error), width = .1, position = pd) +
     geom_point(aes(color = Group), size = 4, position = pd,show.legend = FALSE) + 
          geom_point(size = 3, color = "white", position = pd) +
      labs(title = "Behavioral Entropy across Groups",
         x = "SL Task",  # Change x-axis label
         y = "Mean Entropy") +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(
        plot.title = element_text(size=16, face="bold"),
        axis.title.x = element_text(size=14, face="bold"),
        axis.title.y = element_text(size=14, face="bold"),
        axis.text=element_text(size=12, face = "bold")
        ) +
  theme(legend.text=element_text(size=14, face="bold"),
        legend.title=element_text(size=15, face="bold")) +
   theme(
    panel.background = element_rect(fill = "white"),         # Set plot background to white
    legend.key  = element_rect(fill = "white"),              # Set legend item backgrounds to white
    axis.line.x = element_line(colour = "black", size = 1),  # Add line to x axis
    axis.line.y = element_line(colour = "black", size = 1)   # Add line to y axis
  )

# ggsave("behavioral_entropy_across_group.png",
       # bg="transparent",
       # width = 15, height = 15, units = "cm")
```





# Mean RT Line Plot (no outliers)
```{r}
library(dplyr)
library(ggplot2)

bucld_sl_bar_all_long <- melt(bucld_sl_bar_all, id.vars=c("part_id", "group"))


bucld_sl_bar_rt <-
  bucld_sl_bar_all_long[which(
    str_detect(bucld_sl_bar_all_long$variable, "(?<=rt_children_)\\S{3}(?=_indiv_rts)")),]

bucld_sl_bar_rt$variable <-
revalue(bucld_sl_bar_rt$variable, c("rt_children_lsl_indiv_rts"="Letter",
                                     "rt_children_vsl_indiv_rts"="Image",
                                     "rt_children_tsl_indiv_rts"="Tone",
                                     "rt_children_ssl_indiv_rts"="Syllable"))

bucld_sl_bar_rt$variable <- 
  factor(bucld_sl_bar_rt$variable,levels = c("Image", 
                                                  "Letter", 
                                                  "Tone", 
                                                  "Syllable"))

bucld_sl_bar_rt <-
  bucld_sl_bar_rt[order(bucld_sl_bar_rt$variable), ]

bucld_sl_bar_rt$value <- 
  as.numeric(as.character(bucld_sl_bar_rt$value))


library("pastecs")
stat_desc <- 
function(df,group,task) {
  stat.desc(df[which(df$group == group & df$variable == task),])
}

td_tone <- stat_desc(bucld_sl_bar_rt, "TD", "Tone")
td_syllable <- stat_desc(bucld_sl_bar_rt, "TD", "Syllable")
td_image <- stat_desc(bucld_sl_bar_rt, "TD", "Image")
td_letter <- stat_desc(bucld_sl_bar_rt, "TD", "Letter")

asd_tone <- stat_desc(bucld_sl_bar_rt, "ASD", "Tone")
asd_syllable <- stat_desc(bucld_sl_bar_rt, "ASD", "Syllable")
asd_image <- stat_desc(bucld_sl_bar_rt, "ASD", "Image")
asd_letter <- stat_desc(bucld_sl_bar_rt, "ASD", "Letter")
 
extract_line_graph_stat <- function (x, group, task) {
y <- x[c("nbr.val","mean", "SE.mean"),"value"]
dim(y) <- c(3, 1)
y <- t(y)
colnames(y) <- c("n", "mean", "std_error")
y <- data.frame(y)
y$group <- group
y$task <- task


return(y)
}

td_tone_stat <- extract_line_graph_stat(td_tone, "TD", "Tone")
td_syllable_stat <- extract_line_graph_stat(td_syllable, "TD", "Syllable")
td_image_stat <- extract_line_graph_stat(td_image, "TD", "Image")
td_letter_stat <- extract_line_graph_stat(td_letter, "TD", "Letter")

asd_tone_stat <- extract_line_graph_stat(asd_tone, "ASD", "Tone")
asd_syllable_stat <- extract_line_graph_stat(asd_syllable, "ASD", "Syllable")
asd_image_stat <- extract_line_graph_stat(asd_image, "ASD", "Image")
asd_letter_stat <- extract_line_graph_stat(asd_letter, "ASD", "Letter")



rt_stat <- rbind(td_tone_stat, td_syllable_stat, td_image_stat, td_letter_stat,
                      asd_tone_stat, asd_syllable_stat, asd_image_stat, asd_letter_stat)


colnames(rt_stat)[colnames(rt_stat) == "group"] <- "Group"

rt_stat$task <- 
  factor(rt_stat$task,levels = c("Image", 
                                              "Letter", 
                                              "Tone", 
                                              "Syllable"))

rt_stat <-
  rt_stat[order(rt_stat$task), ]


pd <- position_dodge(width = 0.2)

rt_stat %>%
  ggplot(aes(x = task, y = mean, group = Group)) +
  geom_line(aes(linetype = Group, color = Group), position = pd, size = 1.8) +
   geom_errorbar(aes(ymin = mean - std_error, ymax = mean + std_error), width = .1, position = pd) +
     geom_point(aes(color = Group), size = 4, position = pd,show.legend = FALSE) + 
          geom_point(size = 3, color = "white", position = pd) +
      labs(title = "Behavioral Reaction Time across Groups",
         x = "SL Task",  # Change x-axis label
         y = "Mean Reaction Time (ms)") +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(
        plot.title = element_text(size=16, face="bold"),
        axis.title.x = element_text(size=14, face="bold"),
        axis.title.y = element_text(size=14, face="bold"),
        axis.text=element_text(size=12, face = "bold")
        ) +
  theme(legend.text=element_text(size=14, face="bold"),
        legend.title=element_text(size=15, face="bold")) +
   theme(
    panel.background = element_rect(fill = "white"),         # Set plot background to white
    legend.key  = element_rect(fill = "white"),              # Set legend item backgrounds to white
    axis.line.x = element_line(colour = "black", size = 1),  # Add line to x axis
    axis.line.y = element_line(colour = "black", size = 1)   # Add line to y axis
  )

# ggsave("behavioral_rt_across_group.png",
       # width = 15, height = 15, units = "cm")

# write.csv(blast_spoli_data_wide, "blast_spoli_data_all_measures.csv")
# write.csv(bucld_all_completed, "blast_spoli_data_all_measures_no_outlier.csv")
```



# RT Slope Line Plot (no outliers)
```{r, include = F}
library(dplyr)
library(ggplot2)

bucld_sl_bar_all_long <- melt(bucld_sl_bar_all, id.vars=c("part_id", "group"))


bucld_sl_bar_slope <-
  bucld_sl_bar_all_long[which(
    str_detect(bucld_sl_bar_all_long$variable, "(?<=slope_children_)\\S{3}(?=_indiv_rts_slope)")),]


bucld_sl_bar_slope$variable <-
revalue(bucld_sl_bar_slope$variable, c("slope_children_lsl_indiv_rts_slope"="Letter",
                                     "slope_children_vsl_indiv_rts_slope"="Image",
                                     "slope_children_tsl_indiv_rts_slope"="Tone",
                                     "slope_children_ssl_indiv_rts_slope"="Syllable"))

bucld_sl_bar_slope$variable <- 
  factor(bucld_sl_bar_slope$variable,levels = c("Image", 
                                                  "Letter", 
                                                  "Tone", 
                                                  "Syllable"))

bucld_sl_bar_slope <-
  bucld_sl_bar_slope[order(bucld_sl_bar_slope$variable), ]

bucld_sl_bar_slope$value <- 
  as.numeric(as.character(bucld_sl_bar_slope$value))


library("pastecs")
stat_desc <- 
function(df,group,task) {
  stat.desc(df[which(df$group == group & df$variable == task),])
}

td_tone <- stat_desc(bucld_sl_bar_slope, "TD", "Tone")
td_syllable <- stat_desc(bucld_sl_bar_slope, "TD", "Syllable")
td_image <- stat_desc(bucld_sl_bar_slope, "TD", "Image")
td_letter <- stat_desc(bucld_sl_bar_slope, "TD", "Letter")

asd_tone <- stat_desc(bucld_sl_bar_slope, "ASD", "Tone")
asd_syllable <- stat_desc(bucld_sl_bar_slope, "ASD", "Syllable")
asd_image <- stat_desc(bucld_sl_bar_slope, "ASD", "Image")
asd_letter <- stat_desc(bucld_sl_bar_slope, "ASD", "Letter")
 
extract_line_graph_stat <- function (x, group, task) {
y <- x[c("nbr.val","mean", "SE.mean", "std.dev"),"value"]
dim(y) <- c(4, 1)
y <- t(y)
colnames(y) <- c("n", "mean", "std_error", "sd")
y <- data.frame(y)
y$group <- group
y$task <- task


return(y)
}

td_tone_stat <- extract_line_graph_stat(td_tone, "TD", "Tone")
td_syllable_stat <- extract_line_graph_stat(td_syllable, "TD", "Syllable")
td_image_stat <- extract_line_graph_stat(td_image, "TD", "Image")
td_letter_stat <- extract_line_graph_stat(td_letter, "TD", "Letter")

asd_tone_stat <- extract_line_graph_stat(asd_tone, "ASD", "Tone")
asd_syllable_stat <- extract_line_graph_stat(asd_syllable, "ASD", "Syllable")
asd_image_stat <- extract_line_graph_stat(asd_image, "ASD", "Image")
asd_letter_stat <- extract_line_graph_stat(asd_letter, "ASD", "Letter")



slope_stat <- rbind(td_tone_stat, td_syllable_stat, td_image_stat, td_letter_stat,
                      asd_tone_stat, asd_syllable_stat, asd_image_stat, asd_letter_stat)

slope_stat$task <- 
  factor(slope_stat$task,levels = c("Image", 
                                              "Letter", 
                                              "Tone", 
                                              "Syllable"))
slope_stat <-
  slope_stat[order(slope_stat$task), ]

print(slope_stat)

pd <- position_dodge(width = 0.2)

colnames(slope_stat)[colnames(slope_stat) == "group"] <- "Group"

# write.csv(slope_stat, "slope_stat.csv")
```

```{r, include = F}
detach(package:plyr)
slope_within_stat <- summarySEwithin(bucld_sl_bar_slope, measurevar="value", betweenvars = "group", withinvars="variable",
                        idvar="part_id", na.rm=T, conf.interval=.95)

slope_within_stat_adult <- summarySEwithin(all_slope, measurevar="rt_slope", betweenvars = "group", withinvars="task",
                        idvar="part_id", na.rm=T, conf.interval=.95)

colnames(slope_within_stat)[colnames(slope_within_stat) == "group"] <- "Group"
colnames(slope_within_stat)[colnames(slope_within_stat) == "value"] <- "mean"
colnames(slope_within_stat)[colnames(slope_within_stat) == "se"] <- "std_error"
colnames(slope_within_stat)[colnames(slope_within_stat) == "variable"] <- "task"


slope_within_stat$task <- 
  factor(slope_within_stat$task,levels = c("Image", 
                                              "Letter", 
                                              "Tone", 
                                              "Syllable"))

colnames(slope_within_stat_adult)[colnames(slope_within_stat_adult) == "group"] <- "Group"
colnames(slope_within_stat_adult)[colnames(slope_within_stat_adult) == "se"] <- "std_error"
colnames(slope_within_stat_adult)[colnames(slope_within_stat_adult) == "rt_slope"] <- "mean"

slope_within_stat_adult$task <-
revalue(slope_within_stat_adult$task, c("lsl_indiv_rts_slope"="Letter",
                                     "vsl_indiv_rts_slope"="Image",
                                     "tsl_indiv_rts_slope"="Tone",
                                     "ssl_indiv_rts_slope"="Syllable"))

slope_within_stat_adult$task <- 
  factor(slope_within_stat_adult$task,levels = c("Image", 
                                              "Letter", 
                                              "Tone", 
                                              "Syllable"))

slope_within_stat_adult$Group <- 
  factor(slope_within_stat_adult$Group,levels = c("ASD", 
                                              "TD", 
                                              "adult"))
```

# Median Split of Slope
```{r}
ssl_slope <- bucld_all_completed_slope[which(bucld_all_completed_slope$task == "ssl" & 
                                               bucld_all_completed_slope$group == "TD"),]
ssl_slope <- ssl_slope[order(ssl_slope$age_at_web_year),]
ssl_slope[1:round(length(ssl_slope$age_at_web_year)/2),"Group"] <- "Younger TD" 
median <- round((length(ssl_slope$age_at_web_year)/2))+1
ssl_slope[median:length(ssl_slope$age_at_web_year),"Group"] <- "Older TD"

ssl_slopeASD <- bucld_all_completed_slope[which(bucld_all_completed_slope$task == "ssl" & 
                                               bucld_all_completed_slope$group == "ASD"),]
ssl_slopeASD <- ssl_slopeASD[order(ssl_slopeASD$age_at_web_year),]
ssl_slopeASD[1:round(length(ssl_slopeASD$age_at_web_year)/2),"Group"] <- "Younger ASD" 
medianASD <- round((length(ssl_slopeASD$age_at_web_year)/2))+1
ssl_slopeASD[median:length(ssl_slopeASD$age_at_web_year),"Group"] <- "Older ASD"

ssl_slopeA <- blast_adult_wide_slope[which(blast_adult_wide_slope$task == "slope_adult_ssl_indiv_rts_slope" & 
                                               blast_adult_wide_slope$group == "adult"),]
# ssl_slopeA <- ssl_slopeA[order(ssl_slopeA$age_at_web_year),]
# ssl_slopeA[1:round(length(ssl_slopeA$age_at_web_year)/2),"age_range"] <- "lower" 
# medianA <- round((length(ssl_slopeA$age_at_web_year)/2))+1
# ssl_slopeA[median:length(ssl_slopeA$age_at_web_year),"age_range"] <- "upper"
# ssl_slopeA$task <- str_extract(ssl_slopeA$task, "\\S{3}(?=_indiv_rts_slope)")


ssl_slopeA$Group <- "Adult"

ssl_slope_TDadult <- rbind(ssl_slope, ssl_slopeA)

ssl_slope_TDadult$Group <- 
  factor(ssl_slope_TDadult$Group,levels = c("Younger TD", 
                                              "Older TD", 
                                              "Adult"))

ssl_slope_TDadult <-
  ssl_slope_TDadult[order(ssl_slope_TDadult$Group), ]

ssl_slope_TDadult %>%
  ggplot(aes(x = Group, y = rt_slope,fill = Group)) +
  geom_bar(aes(shape = group),  
           position = position_dodge(),
           width = 0.9,
           stat = "summary", fun.y = "mean") +
   labs(title = "SSL RT Slope Median Split by Age in Adult and TD",
        x = "Age Group",  # Change x-axis label
         y = "Syllable SL RT Slope (arbitrary unit/ trial)") +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(
        plot.title = element_text(size=16, face="bold"),
        axis.title.x = element_text(size=14, face="bold"),
        axis.title.y = element_text(size=14, face="bold"),
        axis.text=element_text(size=12, face = "bold")
        ) +
  scale_fill_manual(values = c("#3182bd", "#9ecae1", "grey")) +
  theme(legend.text=element_text(size=14, face="bold"),
        legend.title=element_text(size=15, face="bold")) +
   theme(
    panel.background = element_rect(fill = "white"),         # Set plot background to white
    legend.key  = element_rect(fill = "white"),              # Set legend item backgrounds to white
    axis.line.x = element_line(colour = "black", size = 1),  # Add line to x axis
    axis.line.y = element_line(colour = "black", size = 1)   # Add line to y axis
  ) + 
  geom_beeswarm(
    aes(fill = Group),
    dodge.width = 1,
    cex = 2.5,
    size = 0.8,
    show.legend = FALSE
  )

# ggsave("paper_analysis_matched/ssl_slope_td_adult.png",
#        width = 18, height = 15, units = "cm")
```

```{r}
pd <- position_dodge(width = 0.2)

slope_within_stat %>%
  ggplot(aes(x = task, y = mean, group = Group)) +
  geom_line(aes(linetype = Group, color = Group), position = pd, size = 1.8) +
   geom_errorbar(aes(ymin = mean - std_error, ymax = mean + std_error), width = .1, position = pd) +
     geom_point(aes(color = Group), size = 4, position = pd,show.legend = FALSE) + 
          geom_point(size = 3, color = "white", position = pd) +
      labs(title = "SL Reaction Time Slope across Tasks",
         x = "SL Task",  # Change x-axis label
         y = "Mean Reaction Time Slope (arbitrary unit/trial)") +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(
        plot.title = element_text(size=16, face="bold"),
        axis.title.x = element_text(size=14, face="bold"),
        axis.title.y = element_text(size=14, face="bold"),
        axis.text=element_text(size=12, face = "bold")
        ) +
  theme(legend.text=element_text(size=14, face="bold"),
        legend.title=element_text(size=15, face="bold")) +
   theme(
    panel.background = element_rect(fill = "white"),         # Set plot background to white
    legend.key  = element_rect(fill = "white"),              # Set legend item backgrounds to white
    axis.line.x = element_line(colour = "black", size = 1),  # Add line to x axis
    axis.line.y = element_line(colour = "black", size = 1)   # Add line to y axis
  )  +
  geom_hline(yintercept=0, color = "grey") +
  # geom_text(aes(x= 1.05, y = 0.7, label = paste0("**")), size=7, color="#00BFC4") +
  geom_text(aes(x= 2.05, y = -0.033, label = paste0("**")), size=7, color="#00BFC4") +
  # geom_text(aes(x= 3.05, y = 0.7, label = paste0("**")), size=7, color="#00BFC4") +
  geom_text(aes(x= 4.05, y = -0.033, label = paste0("***")), size=7, color="#00BFC4") +
  geom_text(aes(x= 0.95, y = -0.033, label = paste0("*")), size=7, color="#F8766d") 

 
# ggsave(
#    "paper_analysis_matched/behavioral_slope_across_group.png",
#     width = 15, height = 15, units = "cm"
# )
```

```{r}
pd <- position_dodge(width = 0.2)

slope_within_stat_td_adult <- 
  slope_within_stat_adult[which(str_detect(slope_within_stat_adult$Group, "adult|TD")),]
# 
# slope_within_stat_td_adult$Group <- 
#   factor(slope_within_stat_td_adult$Group,levels = c("adult", "TD"))
# 
# slope_within_stat_td_adult <-
#   slope_within_stat_td_adult[order(slope_within_stat_td_adult$Group), ]

slope_within_stat_td_adult %>%
  ggplot(aes(x = task, y = mean, group = Group)) +
  geom_line(aes(linetype = Group, color = Group), position = pd, size = 1.8) +
   geom_errorbar(aes(ymin = mean - std_error, ymax = mean + std_error), width = .1, position = pd) +
     geom_point(aes(color = Group), size = 4, position = pd,show.legend = FALSE) + 
          geom_point(size = 3, color = "white", position = pd) +
      labs(title = "SL Reaction Time Slope across Tasks",
         x = "SL Task",  # Change x-axis label
         y = "Mean Reaction Time Slope (arbitrary unit/trial)") +
  theme(plot.title = element_text(hjust = 0.5)) +
  # scale_color_manual(values=c('#F8766d', '#00BFC4',"black")) +
  scale_color_manual(values=c('#00BFC4', "black")) +
  theme(
        plot.title = element_text(size=16, face="bold"),
        axis.title.x = element_text(size=14, face="bold"),
        axis.title.y = element_text(size=14, face="bold"),
        axis.text=element_text(size=12, face = "bold")
        ) +
  theme(legend.text=element_text(size=14, face="bold"),
        legend.title=element_text(size=15, face="bold")) +
   theme(
    panel.background = element_rect(fill = "white"),         # Set plot background to white
    legend.key  = element_rect(fill = "white"),              # Set legend item backgrounds to white
    axis.line.x = element_line(colour = "black", size = 1),  # Add line to x axis
    axis.line.y = element_line(colour = "black", size = 1)   # Add line to y axis
  )  +
  geom_hline(yintercept=0, color = "grey") +
  # geom_text(aes(x= 1.05, y = 0.7, label = paste0("**")), size=7, color="#00BFC4") +
  geom_text(aes(x= 2.05, y = -0.034, label = paste0("**")), size=7, color="#00BFC4") +
  # geom_text(aes(x= 3.05, y = 0.7, label = paste0("**")), size=7, color="#00BFC4") +
  geom_text(aes(x= 4.05, y = -0.034, label = paste0("***")), size=7, color="#00BFC4") +
   # geom_text(aes(x= 3.95, y = -0.03, label = paste0("*")), size=7, color="#F8766d") +
  geom_text(aes(x= 1.94, y = -0.029, label = paste0("*")), size=7, color="black") +
  geom_text(aes(x= 0.95, y = -0.029, label = paste0("*")), size=7, color="black") 

 
# ggsave(
#    "paper_analysis_matched/behavioral_slope_across_td_adult.png",
#     width = 15, height = 15, units = "cm"
# )
```

```{r}
library(ggbeeswarm)
slope_bar <- bucld_sl_bar_slope 
colnames(slope_bar)[colnames(slope_bar) == "group"] <- "Group"
slope_bar %>%
  ggplot(aes(x = variable, y = value)) +
  geom_bar(
    aes(fill = Group),
    position = position_dodge(),
    width = 0.9,
    stat = "summary",
    fun.y = "mean",
  ) +
 labs(title = "SL Reaction Time Slope Between Group Comparison",
         x = "SL Task",  # Change x-axis label
         y = "Mean Reaction Time Slope (arbitrary unit/trial)") +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(
        plot.title = element_text(size=16, face="bold"),
        axis.title.x = element_text(size=14, face="bold"),
        axis.title.y = element_text(size=14, face="bold"),
        axis.text=element_text(size=12, face = "bold")
        ) +
  theme(legend.text=element_text(size=14, face="bold"),
        legend.title=element_text(size=15, face="bold")) +
   theme(
    panel.background = element_rect(fill = "white"),         # Set plot background to white
    legend.key  = element_rect(fill = "white"),              # Set legend item backgrounds to white
    axis.line.x = element_line(colour = "black", size = 1),  # Add line to x axis
    axis.line.y = element_line(colour = "black", size = 1)   # Add line to y axis
  ) + 
  geom_beeswarm(
    aes(fill = Group),
    dodge.width = 1,
    cex = 2.5,
    size = 0.8,
    show.legend = FALSE
  ) + 
  # geom_text(aes(x= 1, y = 1.04, label = paste0("")), size=7) +
  # geom_segment(aes(x=0.75,xend=1.25, y = 1.02, yend = 1.02)) +
  # geom_segment(aes(x=0.75,xend=0.75, yend = 1, y = 1.02)) +
  # geom_segment(aes(x=1.25,xend=1.25, yend = 1, y = 1.02)) +
   geom_text(aes(x= 2, y = 0.102, label = paste0("*")), size=7) +
   geom_segment(aes(x=1.75,xend=2.25, y = 0.1, yend = 0.1)) +
   geom_segment(aes(x=1.75,xend=1.75, yend = 0.096, y = 0.1)) +
  geom_segment(aes(x=2.25,xend=2.25, yend = 0.096, y = 0.1))

# ggsave("srcd_figure/behavioral_slope_ling_bar.png",
       # bg="transparent",
       # width = 15.5, height = 15.5, units = "cm")

```

# RT slope bar plot below 1.5 SD
```{r}
library(ggbeeswarm)
slope_bar <- bucld_sl_bar_slope 
colnames(slope_bar)[colnames(slope_bar) == "group"] <- "Group"
slope_bar %>%
  ggplot(aes(x = variable, y = value)) +
  geom_bar(
    aes(fill = Group),
    position = position_dodge(),
    width = 0.9,
    stat = "summary",
    fun.y = "mean",
  ) +
 labs(title = "SL Reaction Time Slope Between Group Comparison",
         x = "SL Task",  # Change x-axis label
         y = "Mean Reaction Time Slope (arbitrary unit/trial)") +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(
        plot.title = element_text(size=16, face="bold"),
        axis.title.x = element_text(size=14, face="bold"),
        axis.title.y = element_text(size=14, face="bold"),
        axis.text=element_text(size=12, face = "bold")
        ) +
  theme(legend.text=element_text(size=14, face="bold"),
        legend.title=element_text(size=15, face="bold")) +
   theme(
    panel.background = element_rect(fill = "white"),         # Set plot background to white
    legend.key  = element_rect(fill = "white"),              # Set legend item backgrounds to white
    axis.line.x = element_line(colour = "black", size = 1),  # Add line to x axis
    axis.line.y = element_line(colour = "black", size = 1)   # Add line to y axis
  ) + 
  geom_beeswarm(
    aes(fill = Group),
    dodge.width = 1,
    cex = 2.5,
    size = 0.8,
    show.legend = FALSE
  ) +
  # geom_segment(aes(x=3.6,xend=4.4, y = ssl1.5SD_slope , yend = ssl1.5SD_slope)) +
  # geom_segment(aes(x=1.6,xend=2.4, y = lsl1.5SD_slope , yend = lsl1.5SD_slope))
  geom_segment(aes(x=3.6,xend=4.4, y = confInterval_ssl, yend = confInterval_ssl)) +
  geom_segment(aes(x=1.6,xend=2.4, y = confInterval_lsl, yend = confInterval_lsl))
```

# JoVE RT slope bar plot TD
```{r}
library(ggbeeswarm)

slope_bar[which(slope_bar$Group == "TD"),] %>%
  ggplot(aes(x = variable, y = value)) +
  geom_bar(
    position = position_dodge(),
    fill = "grey",
    width = 0.5,
    stat = "summary",
    fun.y = "mean"
  ) +
 labs(title = "SL Reaction Time Slope",
         x = "SL Condition",  # Change x-axis label
         y = "Mean Reaction Time Slope (arbitrary unit/trial)") +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(
        plot.title = element_text(size=16, face="bold"),
        axis.title.x = element_text(size=14, face="bold"),
        axis.title.y = element_text(size=14, face="bold"),
        axis.text=element_text(size=12, face = "bold")
        ) +
  theme(legend.text=element_text(size=14, face="bold"),
        legend.title=element_text(size=15, face="bold")) +
   theme(
    panel.background = element_rect(fill = "white"),         # Set plot background to white
    legend.key  = element_rect(fill = "white"),              # Set legend item backgrounds to white
    axis.line.x = element_line(colour = "black", size = 1),  # Add line to x axis
    axis.line.y = element_line(colour = "black", size = 1)   # Add line to y axis
  ) + 
  geom_beeswarm(
    dodge.width = 1,
    cex = 2.5,
    size = 1.2,
    show.legend = FALSE
  ) 
# +
  # geom_text(aes(x= 1, y = 1.04, label = paste0("")), size=7) +
  # geom_segment(aes(x=0.75,xend=1.25, y = 1.02, yend = 1.02)) +
  # geom_segment(aes(x=0.75,xend=0.75, yend = 1, y = 1.02)) +
    # geom_hline(yintercept=0, color = "red", size = 0.3, stat="density", alpha=0.6) +
  # geom_text(aes(x= 0.8, y = 0.51, label = paste0("chance", "-level")), size=5) +
  # geom_text(aes(x= 2, y = -0.13, label = paste0("")), size=7, color="red") +
  # geom_text(aes(x= 3, y = 1.02, label = paste0("*")), size=7, color="red") +
  # geom_text(aes(x= 1, y = 1.02, label = paste0("*")), size=7, color="red") +
  # geom_text(aes(x= 4, y = -0.13, label = paste0("*")), size=6, color="red")

# ggsave("barPlotSlopeTD.png",
       # bg="transparent",
       # width = 15, height = 15, units = "cm")
```


# Multiple Regression for Accuracy
```{r}
# Regenerate a long data frame with GJT and scaled accuracy scores
gjt_mulreg <- crossed_random_effect_acc_long
gjt_mulreg$gjt_std <- rep(bucld_all_completed$gjt_std_score_gjt_web, 4)

gjt_mulreg <- add_dom_mod_func(gjt_mulreg)
gjt_mulreg$domain <- as.factor(gjt_mulreg$domain)
gjt_mulreg$modality <- as.factor(gjt_mulreg$modality)


m1_gjt <- 
  lmer(value ~ task*gjt_std  + (1 + task|part_id), data= gjt_mulreg,
          control=lmerControl(optimizer = "bobyqa",
                              check.nobs.vs.nRE="ignore", optCtrl=list(maxfun=2e5)))

summary(m1_gjt)

m1_gjt_dom <- 
  lmer(value ~domain*modality*gjt_std  + (1+domain|part_id) + (0+modality|part_id), data= gjt_mulreg,
          control=lmerControl(optimizer = "bobyqa",
                              check.nobs.vs.nRE="ignore", optCtrl=list(maxfun=2e5)))
summary(m1_gjt_dom)

# Regenerate a long data frame with GJT and non-scaled accuracy scores
gjt_mulreg <- bucld_all_completed[,c(1:2, 5, 16, 25, 7:9)]

gjt_mulreg <- melt(gjt_mulreg, id.vars = c("part_id", "group", "age_at_web_year", "gjt_std_score_gjt_web"))

colnames(gjt_mulreg) <- c("part_id", "group", "age", "gjt_std", "task", "acc")

gjt_mulreg <- add_dom_mod_func(gjt_mulreg)

gjt_mulreg$domain <- as.factor(gjt_mulreg$domain)
gjt_mulreg$modality <- as.factor(gjt_mulreg$modality)
gjt_mulreg$task <- as.factor(gjt_mulreg$task)
gjt_mulreg$part_id <- as.factor(gjt_mulreg$part_id)
gjt_mulreg$acc <- as.numeric(as.character(gjt_mulreg$acc))
gjt_mulreg$age <- as.numeric(as.character(gjt_mulreg$age))


gjt_acc <- lm(gjt_std ~ acc*domain*modality, data = gjt_mulreg)
summary(gjt_acc)

gjt_acc_task <- lm(acc ~ gjt_std*task, data = gjt_mulreg)
summary(gjt_acc_task)

acc_gjt_task <- lm(gjt_std ~ acc*task, data = gjt_mulreg)
summary(acc_gjt_task)


cor.test(gjt_mulreg$acc, gjt_mulreg$gjt_std, method = "pearson")

```


# Plot GJT and All SL accuracy relationship
```{r}
gjt_mulreg$task <-
revalue(gjt_mulreg$task, c(
                                     "accuracy_children_vsl_accuracies"="Image",
                                     "accuracy_children_tsl_accuracies"="Tone",
                                     "accuracy_children_ssl_accuracies"="Syllable",
                                     "accuracy_children_lsl_accuracies"="Letter"))


gjt_mulreg$task <- 
  factor(gjt_mulreg$task,levels = c("Image", 
                                              "Letter", 
                                              "Tone", 
                                              "Syllable"))

colnames(gjt_mulreg)[which(colnames(gjt_mulreg) == "group")] <- "Group"
colnames(gjt_mulreg)[which(colnames(gjt_mulreg) == "task")] <- "Task"

gjt_mulreg %>%
ggplot(aes(x = gjt_std , y = acc, color = Group, shape = Task)) +
  geom_point(size = 2, position = pd, stroke = 1.7, alpha = 0.7) +
  scale_shape_manual(values=c(0, 1, 2, 3)) +
  scale_fill_brewer(palette = "Set2") +
      labs(title = "SL Accuracy and GJT Score Correlation",
         x = "Grammaticality Judgment Standard Score",  # hange x-axis label
         y = "SL Accuracy (%)") +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(
        plot.title = element_text(size=16, face="bold"),
        axis.title.x = element_text(size=14, face="bold"),
        axis.title.y = element_text(size=14, face="bold"),
        axis.text=element_text(size=12, face = "bold")
        ) +
  theme(legend.text=element_text(size=14, face="bold")) +
   theme(
    panel.background = element_rect(fill = "white"),
    legend.title = element_text(size = 16, face = "bold"),# Set plot background to white
    legend.key  = element_rect(fill = "white"),              # Set legend item backgrounds to white
    axis.line.x = element_line(colour = "black", size = 1),  # Add line to x axis
    axis.line.y = element_line(colour = "black", size = 1)   # Add line to y axis
  ) +
  geom_smooth(
              aes(x = gjt_std, y = acc), color = "black",
              method=lm, se=FALSE, show.legend = F, inherit.aes = F) +
   geom_text(aes(x= 45, y = 0.96, label = paste0("R = 0.33***")), color = "black", size=5) 

# ggsave("srcd_figure/srcd_gjt_sl_corr.png",
       # width = 15, height = 15, units = "cm")
```

```{r}
library("data.table")

bucld_mulreg <- bucld_all_completed
# bucld_mulreg$group_dummy <-
# revalue(bucld_all_completed$group, c("TD" = 1,
#                                    "ASD" = 0))

# ssl_lsl_mulreg <-
# lm(accuracy_children_ssl_accuracies~accuracy_children_lsl_accuracies*group,
#    data=bucld_mulreg)
# summary(ssl_lsl_mulreg)
# ling_mulreg <- summary(ssl_lsl_mulreg)

# # write.csv(ling_mulreg$coefficients, "srcd_figure/ling_mulreg.csv")

# library("QuantPsyc")
# lm.beta(ssl_lsl_mulreg)

# ssl_lsl_mulreg_vsl_out <-
# lm(accuracy_children_ssl_accuracies~group*accuracy_children_lsl_accuracies + accuracy_children_vsl_accuracies + age_at_web_year,
#    data=bucld_mulreg)
# summary(ssl_lsl_mulreg_vsl_out)

# lsl_ssl_mulreg <-
# lm(accuracy_children_lsl_accuracies~accuracy_children_ssl_accuracies*group +  age_at_web_year,
#    data=bucld_mulreg)
# summary(lsl_ssl_mulreg)
#Interaction marginally significant 

# tsl_ssl_mulreg <-
# lm(accuracy_children_tsl_accuracies~accuracy_children_ssl_accuracies*group,
#    data=bucld_mulreg)
# summary(tsl_ssl_mulreg)

#  ssl_tsl_mulreg <-
# lm(accuracy_children_ssl_accuracies~accuracy_children_tsl_accuracies*group,
#    data=bucld_mulreg)
# summary(ssl_tsl_mulreg)

vsl_lsl_mulreg <-
lm(accuracy_children_vsl_accuracies~accuracy_children_lsl_accuracies*group + age_at_web_year,
   data=bucld_mulreg)
summary(vsl_lsl_mulreg)
# LSL significant

# lsl_vsl_mulreg <-
# lm(accuracy_children_lsl_accuracies~accuracy_children_vsl_accuracies*group,
#    data=bucld_mulreg)
# summary(lsl_vsl_mulreg)
# VSL significant

# ssl_vsl_mulreg <-
# lm(accuracy_children_ssl_accuracies~accuracy_children_vsl_accuracies*group + age_at_web_year,
#    data=bucld_mulreg)
# summary(ssl_vsl_mulreg)
# # Interaction significant


# ssl_vsl_mulreg_lsl_out <-
# lm(accuracy_children_ssl_accuracies~accuracy_children_vsl_accuracies*group + accuracy_children_lsl_accuracies,
#    data=bucld_mulreg)
# summary(ssl_vsl_mulreg_lsl_out)

# vsl_ssl_mulreg <-
# lm(accuracy_children_vsl_accuracies~accuracy_children_ssl_accuracies*group + age_at_web_year,
#    data=bucld_mulreg)
# summary(vsl_ssl_mulreg)
# # Interaction Significant

# lsl_tsl_mulreg <-
# lm(accuracy_children_lsl_accuracies~accuracy_children_tsl_accuracies*group,
#    data=bucld_mulreg)
# summary(lsl_tsl_mulreg)

# tsl_lsl_mulreg <-
# lm(accuracy_children_tsl_accuracies~accuracy_children_lsl_accuracies*group,
#    data=bucld_mulreg)
# summary(tsl_lsl_mulreg)

vsl_tsl_mulreg <-
lm(accuracy_children_vsl_accuracies~accuracy_children_tsl_accuracies*group + age_at_web_year,
   data=bucld_mulreg)
summary(vsl_tsl_mulreg)

# tsl_vsl_mulreg <-
# lm(accuracy_children_tsl_accuracies~accuracy_children_vsl_accuracies*group,
#    data=bucld_mulreg)
# summary(tsl_vsl_mulreg)
```

**Plot LSL vs. SSL Acc (interaction); SSL vs. VSL Acc (interaction); TSL vs. VSL Acc (task main effect)** 



# Multiple Regression Mean RT
```{r, include = F}
# tsl_vsl_mulreg_rt <-
# lm(rt_children_tsl_indiv_rts~rt_children_vsl_indiv_rts*group,
#    data=bucld_mulreg)
# summary(tsl_vsl_mulreg_rt)
# 
# vsl_tsl_mulreg_rt <-
# lm(rt_children_vsl_indiv_rts~rt_children_tsl_indiv_rts*group,
#    data=bucld_mulreg)
# summary(vsl_tsl_mulreg_rt)

# lsl_vsl_mulreg_rt <-
# lm(rt_children_lsl_indiv_rts~rt_children_vsl_indiv_rts*group,
#    data=bucld_mulreg)
# summary(lsl_vsl_mulreg_rt)
# 
# 
# vsl_lsl_mulreg_rt <-
# lm(rt_children_vsl_indiv_rts~rt_children_lsl_indiv_rts*group,
#    data=bucld_mulreg)
# summary(vsl_lsl_mulreg_rt)

# ssl_lsl_mulreg_rt <-
# lm(rt_children_ssl_indiv_rts~rt_children_lsl_indiv_rts*group,
#    data=bucld_mulreg)
# summary(ssl_lsl_mulreg_rt)

# lsl_ssl_mulreg_rt <-
# lm(rt_children_lsl_indiv_rts~rt_children_ssl_indiv_rts*group,
#    data=bucld_mulreg)
# summary(lsl_ssl_mulreg_rt)

# ssl_tsl_mulreg_rt <-
# lm(rt_children_ssl_indiv_rts~rt_children_tsl_indiv_rts*group,
#    data=bucld_mulreg)
# summary(ssl_tsl_mulreg_rt)

# tsl_ssl_mulreg_rt <-
# lm(rt_children_tsl_indiv_rts~rt_children_ssl_indiv_rts*group,
#    data=bucld_mulreg)
# summary(tsl_ssl_mulreg_rt)

# ssl_vsl_mulreg_rt <-
# lm(rt_children_ssl_indiv_rts~rt_children_vsl_indiv_rts*group,
#    data=bucld_mulreg)
# summary(ssl_vsl_mulreg_rt)
# 
# vsl_ssl_mulreg_rt <-
# lm(rt_children_vsl_indiv_rts~rt_children_ssl_indiv_rts*group,
#    data=bucld_mulreg)
# summary(vsl_ssl_mulreg_rt)

# lsl_tsl_mulreg_rt <-
# lm(rt_children_lsl_indiv_rts~rt_children_tsl_indiv_rts*group,
#    data=bucld_mulreg)
# summary(lsl_tsl_mulreg_rt)
# 
# tsl_lsl_mulreg_rt <-
# lm(rt_children_tsl_indiv_rts~rt_children_lsl_indiv_rts*group,
#    data=bucld_mulreg)
# summary(tsl_lsl_mulreg_rt)

```

TSL vs. SSL RT (interaction)


# Multiple regression rt slope 
```{r}
# ssl_lsl_mulreg <-
# lm(slope_children_ssl_indiv_rts_slope~slope_children_lsl_indiv_rts_slope*group,
#    data=bucld_mulreg)
# summary(ssl_lsl_mulreg)
# 
# ssl_lsl_mulreg <-
# lm(slope_children_ssl_indiv_rts_slope~group*slope_children_lsl_indiv_rts_slope,
#    data=bucld_mulreg)
# summary(ssl_lsl_mulreg)


# tsl_ssl_mulreg <-
# lm(slope_children_tsl_indiv_rts_slope~slope_children_ssl_indiv_rts_slope*group,
#    data=bucld_mulreg)
# summary(tsl_ssl_mulreg)
# Interaction

# ssl_tsl_mulreg <-
# lm(slope_children_ssl_indiv_rts_slope~slope_children_tsl_indiv_rts_slope*group,
#    data=bucld_mulreg)
# summary(ssl_tsl_mulreg)
# Interaction

# vsl_lsl_mulreg <-
# lm(slope_children_vsl_indiv_rts_slope~slope_children_lsl_indiv_rts_slope*group +age_at_web_year,
#    data=bucld_mulreg)
# summary(vsl_lsl_mulreg)


# lsl_vsl_mulreg <-
# lm(slope_children_lsl_indiv_rts_slope~slope_children_vsl_indiv_rts_slope*group + age_at_web_year,
#    data=bucld_mulreg)
# summary(lsl_vsl_mulreg)
# Marginal group main effect

# ssl_vsl_mulreg <-
# lm(slope_children_ssl_indiv_rts_slope~slope_children_vsl_indiv_rts_slope*group,
#    data=bucld_mulreg)
# summary(ssl_vsl_mulreg)


# vsl_ssl_mulreg <-
# lm(slope_children_vsl_indiv_rts_slope~slope_children_ssl_indiv_rts_slope*group,
#    data=bucld_mulreg)
# summary(vsl_ssl_mulreg)


# lsl_tsl_mulreg <-
#  lm(slope_children_lsl_indiv_rts_slope~slope_children_tsl_indiv_rts_slope*group,
#     data=bucld_mulreg)
#  summary(lsl_tsl_mulreg)

 # tsl_lsl_mulreg <-
 # lm(slope_children_tsl_indiv_rts_slope~slope_children_lsl_indiv_rts_slope*group,
 #    data=bucld_mulreg)
 # summary(tsl_lsl_mulreg)

# vsl_tsl_mulreg <-
# lm(slope_children_vsl_indiv_rts_slope~slope_children_tsl_indiv_rts_slope*group,
#    data=bucld_mulreg)
# summary(vsl_tsl_mulreg)

# tsl_vsl_mulreg <-
# lm(slope_children_tsl_indiv_rts_slope~slope_children_vsl_indiv_rts_slope*group,
#    data=bucld_mulreg)
# summary(tsl_vsl_mulreg)
```
SSL vs. TSL slope interaction; LSL vs. VSL Slope group main effect





**Plot LSL vs. SSL Acc (interaction); SSL vs. VSL Acc (interaction); TSL vs. VSL Acc (task main effect)** 

# Plot Accuracy Correlation of SL taks across groups

# LSL vs. SSL Acc (interaction)
```{r}
library(ggpubr)
colnames(bucld_mulreg)[colnames(bucld_mulreg) == "group"] <- "Group"

pd <- position_dodge(width = 0.01)

bucld_mulreg %>%
ggplot(aes(x = accuracy_children_ssl_accuracies, y = accuracy_children_lsl_accuracies, color = Group)) +
  geom_point(size = 4, shape = 1, position = pd, stroke = 1.7) +
  scale_fill_brewer(palette = "Set2") +
      labs(title = "Syllable and Letter SL Accuracy Correlation",
         y = "Letter SL Accuracy",  # Change x-axis label
         x = "Syllable SL Accuracy") +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(
        plot.title = element_text(size=16, face="bold"),
        axis.title.x = element_text(size=14, face="bold"),
        axis.title.y = element_text(size=14, face="bold"),
        axis.text=element_text(size=12, face = "bold")
        ) +
  theme(legend.text=element_text(size=14, face="bold")) +
   theme(
    panel.background = element_rect(fill = "white"),
    legend.title = element_text(size = 16, face = "bold"),# Set plot background to white
    legend.key  = element_rect(fill = "white"),              # Set legend item backgrounds to white
    axis.line.x = element_line(colour = "black", size = 1),  # Add line to x axis
    axis.line.y = element_line(colour = "black", size = 1)   # Add line to y axis
  ) +
  geom_smooth(data = subset(bucld_mulreg, Group == "TD"),
              aes(x = accuracy_children_ssl_accuracies, y = accuracy_children_lsl_accuracies),
              method=lm, se=FALSE, show.legend = F, inherit.aes = F, color = "#00BFC4") +
  geom_smooth(data = subset(bucld_mulreg, Group == "ASD"),
              aes(x = accuracy_children_ssl_accuracies, y = accuracy_children_lsl_accuracies),
              method=lm, se=FALSE, show.legend = F, inherit.aes = F, color = "#F8766d") +
  stat_cor(data = subset(bucld_mulreg, Group == "TD"),
              aes(x = accuracy_children_ssl_accuracies, y = accuracy_children_lsl_accuracies),
           method = "pearson", label.x = 0.55, label.y = 0.92,
           inherit.aes = F, color = "#00BFC4", size = 5) +
    stat_cor(data = subset(bucld_mulreg, Group == "ASD"),
              aes(x = accuracy_children_ssl_accuracies, y = accuracy_children_lsl_accuracies),
             method = "pearson", label.x = 0.55, label.y = 0.3, 
           inherit.aes = F, color = "#F8766d", size = 5)
  #+ 
  #geom_text(aes(x = 20, y = 120, label = paste("rho =", "-0.76**")),color = "red",size=4)

# ggsave("srcd_figure/bucld_ssl_lsl_corr.png",
       # width = 15, height = 15, units = "cm")
```

# LSL vs. SSL Slope (inverse correaltion between TD vs. ASD)
```{r}
library(ggpubr)
colnames(bucld_mulreg)[colnames(bucld_mulreg) == "group"] <- "Group"

pd <- position_dodge(width = 0.01)

bucld_mulreg %>%
ggplot(aes(x = slope_children_ssl_indiv_rts_slope, y = slope_children_tsl_indiv_rts_slope, color = Group)) +
  geom_point(size = 4, shape = 1, position = pd, stroke = 1.7) +
  scale_fill_brewer(palette = "Set2") +
      labs(title = "Syllable and Tone SL RT Slope Correlation",
         y = "Tone SL RT Slope",  # Change x-axis label
         x = "Syllable SL RT Slope") +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(
        plot.title = element_text(size=16, face="bold"),
        axis.title.x = element_text(size=14, face="bold"),
        axis.title.y = element_text(size=14, face="bold"),
        axis.text=element_text(size=12, face = "bold")
        ) +
  theme(legend.text=element_text(size=14, face="bold")) +
   theme(
    panel.background = element_rect(fill = "white"),
    legend.title = element_text(size = 16, face = "bold"),# Set plot background to white
    legend.key  = element_rect(fill = "white"),              # Set legend item backgrounds to white
    axis.line.x = element_line(colour = "black", size = 1),  # Add line to x axis
    axis.line.y = element_line(colour = "black", size = 1)   # Add line to y axis
  ) +
  geom_smooth(data = subset(bucld_mulreg, Group == "TD"),
              aes(x = slope_children_ssl_indiv_rts_slope, y = slope_children_tsl_indiv_rts_slope),
              method=lm, se=FALSE, show.legend = F, inherit.aes = F, color = "#00BFC4") +
  geom_smooth(data = subset(bucld_mulreg, Group == "ASD"),
              aes(x = slope_children_ssl_indiv_rts_slope, y = slope_children_tsl_indiv_rts_slope),
              method=lm, se=FALSE, show.legend = F, inherit.aes = F, color = "#F8766d") +
  stat_cor(data = subset(bucld_mulreg, Group == "TD"),
              aes(x = slope_children_ssl_indiv_rts_slope, y = slope_children_lsl_indiv_rts_slope),
           method = "pearson", label.x = -0.05,
           inherit.aes = F, color = "#00BFC4", size = 5) +
    stat_cor(data = subset(bucld_mulreg, Group == "ASD"),
              aes(x = slope_children_ssl_indiv_rts_slope, y = slope_children_lsl_indiv_rts_slope),
             method = "pearson",label.x = -0.05, label.y = 0.05, 
           inherit.aes = F, color = "#F8766d", size = 5)
  # +
  # geom_text(aes(x = 20, y = 120, label = paste("rho =", "-0.76**")),color = "red",size=4)

# ggsave("paper_analysis_matched/bucld_ssl_lsl_corr.png",
# width = 15, height = 15, units = "cm")
```
# VSL vs. SSL Acc (interaction)
```{r, include = F}
library(ggpubr)
colnames(bucld_mulreg)[colnames(bucld_mulreg) == "group"] <- "Group"

pd <- position_dodge(width = 0.01)

bucld_mulreg %>%
ggplot(aes(x = accuracy_children_ssl_accuracies, y = accuracy_children_vsl_accuracies, color = Group)) +
  geom_point(size = 4, shape = 1, position = pd, stroke = 1.7) +
  scale_fill_brewer(palette = "Set2") +
      labs(title = "Syllable and Image SL Accuracy Correlation",
         y = "Syllable SL Accuracy",  # Change x-axis label
         x = "Image SL Accuracy") +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(
        plot.title = element_text(size=16, face="bold"),
        axis.title.x = element_text(size=14, face="bold"),
        axis.title.y = element_text(size=14, face="bold"),
        axis.text=element_text(size=12, face = "bold")
        ) +
  theme(legend.text=element_text(size=14, face="bold")) +
   theme(
    panel.background = element_rect(fill = "white"),
    legend.title = element_text(size = 16, face = "bold"),# Set plot background to white
    legend.key  = element_rect(fill = "white"),              # Set legend item backgrounds to white
    axis.line.x = element_line(colour = "black", size = 1),  # Add line to x axis
    axis.line.y = element_line(colour = "black", size = 1)   # Add line to y axis
  ) +
  geom_smooth(data = subset(bucld_mulreg, Group == "TD"),
              aes(x = accuracy_children_ssl_accuracies, y = accuracy_children_vsl_accuracies),
              method=lm, se=FALSE, show.legend = F, inherit.aes = F, color = "#00BFC4") +
  geom_smooth(data = subset(bucld_mulreg, Group == "ASD"),
              aes(x = accuracy_children_ssl_accuracies, y = accuracy_children_vsl_accuracies),
              method=lm, se=FALSE, show.legend = F, inherit.aes = F, color = "#F8766d") +
  stat_cor(data = subset(bucld_mulreg, Group == "TD"),
              aes(x = accuracy_children_ssl_accuracies, y = accuracy_children_vsl_accuracies),
           method = "pearson", label.x = 0.55, label.y = 0.95,
           inherit.aes = F, color = "#00BFC4", size = 5) +
    stat_cor(data = subset(bucld_mulreg, Group == "ASD"),
              aes(x = accuracy_children_ssl_accuracies, y = accuracy_children_vsl_accuracies),
             method = "pearson", label.x = 0.55, label.y = 0.3, 
           inherit.aes = F, color = "#F8766d", size = 5)
  #+ 
  # geom_text(aes(x = 20, y = 120, label = paste("rho =", "-0.76**")),color = "red",size=4)

# ggsave("paper_analysis_matched/vsl_ssl_corr.png",
# width = 15, height = 15, units = "cm")
```



# TSL vs. VSL Acc (significant in ASD)
```{r}
library(ggpubr)
colnames(bucld_mulreg)[colnames(bucld_mulreg) == "group"] <- "Group"

pd <- position_dodge(width = 0.01)

bucld_mulreg %>%
ggplot(aes(x = accuracy_children_tsl_accuracies, y = accuracy_children_vsl_accuracies, color = Group)) +
  geom_point(size = 4, shape = 1, position = pd, stroke = 1.7) +
  scale_fill_brewer(palette = "Set2") +
      labs(title = "Tone and Image SL Accuracy Correlation",
         y = "Tone SL Accuracy",  # Change x-axis label
         x = "Image SL Accuracy") +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(
        plot.title = element_text(size=16, face="bold"),
        axis.title.x = element_text(size=14, face="bold"),
        axis.title.y = element_text(size=14, face="bold"),
        axis.text=element_text(size=12, face = "bold")
        ) +
  theme(legend.text=element_text(size=14, face="bold")) +
   theme(
    panel.background = element_rect(fill = "white"),
    legend.title = element_text(size = 16, face = "bold"),# Set plot background to white
    legend.key  = element_rect(fill = "white"),              # Set legend item backgrounds to white
    axis.line.x = element_line(colour = "black", size = 1),  # Add line to x axis
    axis.line.y = element_line(colour = "black", size = 1)   # Add line to y axis
  ) +
  geom_smooth(data = subset(bucld_mulreg, Group == "TD"),
              aes(x = accuracy_children_tsl_accuracies, y = accuracy_children_vsl_accuracies),
              method=lm, se=FALSE, show.legend = F, inherit.aes = F, color = "#00BFC4") +
  geom_smooth(data = subset(bucld_mulreg, Group == "ASD"),
              aes(x = accuracy_children_tsl_accuracies, y = accuracy_children_vsl_accuracies),
              method=lm, se=FALSE, show.legend = F, inherit.aes = F, color = "#F8766d")
# +
#   stat_cor(data = subset(bucld_mulreg, Group == "TD"),
#               aes(x = accuracy_children_tsl_accuracies, y = accuracy_children_vsl_accuracies),
#            method = "pearson", label.x = 0.55, label.y = 0.95,
#            inherit.aes = F, color = "#00BFC4", size = 5) +
#     stat_cor(data = subset(bucld_mulreg, Group == "ASD"),
#               aes(x = accuracy_children_tsl_accuracies, y = accuracy_children_vsl_accuracies),
#              method = "pearson", label.x = 0.55, label.y = 0.3, 
#            inherit.aes = F, color = "#F8766d", size = 5)
#   #+ 
  #geom_text(aes(x = 20, y = 120, label = paste("rho =", "-0.76**")),color = "red",size=4)

# ggsave("bucld_tsl_vsl_corr.png",
       # width = 15, height = 15, units = "cm")
```




# LSL vs. VSL Acc (significant in ASD)
```{r}
library(ggpubr)
colnames(bucld_mulreg)[colnames(bucld_mulreg) == "group"] <- "Group"

pd <- position_dodge(width = 0.01)

bucld_mulreg %>%
ggplot(aes(x = accuracy_children_lsl_accuracies, y = accuracy_children_vsl_accuracies, color = Group)) +
  geom_point(size = 4, shape = 1, position = pd, stroke = 1.7) +
  scale_fill_brewer(palette = "Set2") +
      labs(title = "Letter and Image SL Accuracy Correlation",
         y = "letter SL Accuracy",  # Change x-axis label
         x = "Image SL Accuracy") +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(
        plot.title = element_text(size=16, face="bold"),
        axis.title.x = element_text(size=14, face="bold"),
        axis.title.y = element_text(size=14, face="bold"),
        axis.text=element_text(size=12, face = "bold")
        ) +
  theme(legend.text=element_text(size=14, face="bold")) +
   theme(
    panel.background = element_rect(fill = "white"),
    legend.title = element_text(size = 16, face = "bold"),# Set plot background to white
    legend.key  = element_rect(fill = "white"),              # Set legend item backgrounds to white
    axis.line.x = element_line(colour = "black", size = 1),  # Add line to x axis
    axis.line.y = element_line(colour = "black", size = 1)   # Add line to y axis
  ) +
  geom_smooth(data = subset(bucld_mulreg, Group == "TD"),
              aes(x = accuracy_children_lsl_accuracies, y = accuracy_children_vsl_accuracies),
              method=lm, se=FALSE, show.legend = F, inherit.aes = F, color = "#00BFC4") +
  geom_smooth(data = subset(bucld_mulreg, Group == "ASD"),
              aes(x = accuracy_children_lsl_accuracies, y = accuracy_children_vsl_accuracies),
              method=lm, se=FALSE, show.legend = F, inherit.aes = F, color = "#F8766d") 
# +
#   stat_cor(data = subset(bucld_mulreg, Group == "TD"),
#               aes(x = accuracy_children_lsl_accuracies, y = accuracy_children_vsl_accuracies),
#            method = "pearson", label.x = 0.55, label.y = 0.95,
#            inherit.aes = F, color = "#00BFC4", size = 5) +
#     stat_cor(data = subset(bucld_mulreg, Group == "ASD"),
#               aes(x = accuracy_children_lsl_accuracies, y = accuracy_children_vsl_accuracies),
#              method = "pearson", label.x = 0.55, label.y = 0.3, 
#            inherit.aes = F, color = "#F8766d", size = 5)
  #+ 
  #geom_text(aes(x = 20, y = 120, label = paste("rho =", "-0.76**")),color = "red",size=4)

# ggsave("bucld_lsl_vsl_corr.png",
       # width = 15, height = 15, units = "cm")
```



## Plot Age and Accuracy corr
```{r}
bucld_mulreg %>%
ggplot(aes(x = age_at_web_year, y = accuracy_children_lsl_accuracies, color = Group)) +
  geom_point(size = 4, shape = 1, position = pd, stroke = 1.7) +
  scale_fill_brewer(palette = "Set2") +
      labs(title = "Age and Letter SL Accuracy Correlation",
         y = "Letter SL Accuracy",  # Change x-axis label
         x = "Age") +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(
        plot.title = element_text(size=16, face="bold"),
        axis.title.x = element_text(size=14, face="bold"),
        axis.title.y = element_text(size=14, face="bold"),
        axis.text=element_text(size=12, face = "bold")
        ) +
  theme(legend.text=element_text(size=14, face="bold")) +
   theme(
    panel.background = element_rect(fill = "white"),
    legend.title = element_text(size = 16, face = "bold"),# Set plot background to white
    legend.key  = element_rect(fill = "white"),              # Set legend item backgrounds to white
    axis.line.x = element_line(colour = "black", size = 1),  # Add line to x axis
    axis.line.y = element_line(colour = "black", size = 1)   # Add line to y axis
  ) +
  geom_smooth(data = subset(bucld_mulreg, Group == "TD"),
              aes(x = age_at_web_year, y = accuracy_children_lsl_accuracies),
              method=lm, se=FALSE, show.legend = F, inherit.aes = F, color = "#00BFC4") +
  geom_smooth(data = subset(bucld_mulreg, Group == "ASD"),
              aes(x = age_at_web_year, y = accuracy_children_lsl_accuracies),
              method=lm, se=FALSE, show.legend = F, inherit.aes = F, color = "#F8766d") +
  stat_cor(data = subset(bucld_mulreg, Group == "TD"),
              aes(x = age_at_web_year, y = accuracy_children_lsl_accuracies),
           method = "pearson", label.x = 5, label.y = 0.95,
           inherit.aes = F, color = "#00BFC4", size = 5) +
    stat_cor(data = subset(bucld_mulreg, Group == "ASD"),
              aes(x = age_at_web_year, y = accuracy_children_lsl_accuracies),
             method = "pearson", label.x = 5, label.y = 0.3, 
           inherit.aes = F, color = "#F8766d", size = 5)

# ggsave("srcd_figure/lsl_age_corr.png",
       # width = 10, height = 15, units = "cm")
```


```{r}
bucld_mulreg %>%
ggplot(aes(x = age_at_web_year, y = accuracy_children_vsl_accuracies, color = Group)) +
  geom_point(size = 4, shape = 1, position = pd, stroke = 1.7) +
  scale_fill_brewer(palette = "Set2") +
      labs(title = "Age and Image SL Accuracy Correlation",
         y = "Image SL Accuracy",  # Change x-axis label
         x = "Age") +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(
        plot.title = element_text(size=16, face="bold"),
        axis.title.x = element_text(size=14, face="bold"),
        axis.title.y = element_text(size=14, face="bold"),
        axis.text=element_text(size=12, face = "bold")
        ) +
  theme(legend.text=element_text(size=14, face="bold")) +
   theme(
    panel.background = element_rect(fill = "white"),
    legend.title = element_text(size = 16, face = "bold"),# Set plot background to white
    legend.key  = element_rect(fill = "white"),              # Set legend item backgrounds to white
    axis.line.x = element_line(colour = "black", size = 1),  # Add line to x axis
    axis.line.y = element_line(colour = "black", size = 1)   # Add line to y axis
  ) +
  geom_smooth(data = subset(bucld_mulreg, Group == "TD"),
              aes(x = age_at_web_year, y = accuracy_children_vsl_accuracies),
              method=lm, se=FALSE, show.legend = F, inherit.aes = F, color = "#00BFC4") +
  geom_smooth(data = subset(bucld_mulreg, Group == "ASD"),
              aes(x = age_at_web_year, y = accuracy_children_vsl_accuracies),
              method=lm, se=FALSE, show.legend = F, inherit.aes = F, color = "#F8766d") +
  stat_cor(data = subset(bucld_mulreg, Group == "TD"),
              aes(x = age_at_web_year, y = accuracy_children_vsl_accuracies),
           method = "pearson", label.x = 5, label.y = 0.95,
           inherit.aes = F, color = "#00BFC4", size = 5) +
    stat_cor(data = subset(bucld_mulreg, Group == "ASD"),
              aes(x = age_at_web_year, y = accuracy_children_vsl_accuracies),
             method = "pearson", label.x = 5, label.y = 0.3, 
           inherit.aes = F, color = "#F8766d", size = 5)

# ggsave("paper_analysis_matched/vsl_age_corr.png",
#        width = 10, height = 15, units = "cm")

```


```{r}
bucld_mulreg %>%
ggplot(aes(x = age_at_web_year, y = accuracy_children_ssl_accuracies, color = Group)) +
  geom_point(size = 4, shape = 1, position = pd, stroke = 1.7) +
  scale_fill_brewer(palette = "Set2") +
      labs(title = "Age and Syllable SL Accuracy Correlation",
         y = "Syllable SL Accuracy",  # Change x-axis label
         x = "Age") +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(
        plot.title = element_text(size=16, face="bold"),
        axis.title.x = element_text(size=14, face="bold"),
        axis.title.y = element_text(size=14, face="bold"),
        axis.text=element_text(size=12, face = "bold")
        ) +
  theme(legend.text=element_text(size=14, face="bold")) +
   theme(
    panel.background = element_rect(fill = "white"),
    legend.title = element_text(size = 16, face = "bold"),# Set plot background to white
    legend.key  = element_rect(fill = "white"),              # Set legend item backgrounds to white
    axis.line.x = element_line(colour = "black", size = 1),  # Add line to x axis
    axis.line.y = element_line(colour = "black", size = 1)   # Add line to y axis
  ) +
  geom_smooth(data = subset(bucld_mulreg, Group == "TD"),
              aes(x = age_at_web_year, y = accuracy_children_ssl_accuracies),
              method=lm, se=FALSE, show.legend = F, inherit.aes = F, color = "#00BFC4") +
  geom_smooth(data = subset(bucld_mulreg, Group == "ASD"),
              aes(x = age_at_web_year, y = accuracy_children_ssl_accuracies),
              method=lm, se=FALSE, show.legend = F, inherit.aes = F, color = "#F8766d") +
  stat_cor(data = subset(bucld_mulreg, Group == "TD"),
              aes(x = age_at_web_year, y = accuracy_children_ssl_accuracies),
           method = "pearson", label.x = 5, label.y = 0.95,
           inherit.aes = F, color = "#00BFC4", size = 5) +
    stat_cor(data = subset(bucld_mulreg, Group == "ASD"),
              aes(x = age_at_web_year, y = accuracy_children_ssl_accuracies),
             method = "pearson", label.x = 5, label.y = 0.3, 
           inherit.aes = F, color = "#F8766d", size = 5)

# ggsave("paper_analysis_matched/ssl_age_corr.png",
#        width = 15, height = 15, units = "cm")

```

```{r}
bucld_mulreg %>%
ggplot(aes(x = age_at_web_year, y = slope_children_ssl_indiv_rts_slope, color = Group)) +
  geom_point(size = 4, shape = 1, position = pd, stroke = 1.7) +
  scale_fill_brewer(palette = "Set2") +
      labs(title = "Age and Syllable SL RT Slope Correlation",
         y = "Syllable SL RT Slope",  # Change x-axis label
         x = "Age") +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(
        plot.title = element_text(size=16, face="bold"),
        axis.title.x = element_text(size=14, face="bold"),
        axis.title.y = element_text(size=14, face="bold"),
        axis.text=element_text(size=12, face = "bold")
        ) +
  theme(legend.text=element_text(size=14, face="bold")) +
   theme(
    panel.background = element_rect(fill = "white"),
    legend.title = element_text(size = 16, face = "bold"),# Set plot background to white
    legend.key  = element_rect(fill = "white"),              # Set legend item backgrounds to white
    axis.line.x = element_line(colour = "black", size = 1),  # Add line to x axis
    axis.line.y = element_line(colour = "black", size = 1)   # Add line to y axis
  ) +
  geom_smooth(data = subset(bucld_mulreg, Group == "TD"),
              aes(x = age_at_web_year, y = slope_children_ssl_indiv_rts_slope),
              method=lm, se=FALSE, show.legend = F, inherit.aes = F, color = "#00BFC4") +
  geom_smooth(data = subset(bucld_mulreg, Group == "ASD"),
              aes(x = age_at_web_year, y = slope_children_ssl_indiv_rts_slope),
              method=lm, se=FALSE, show.legend = F, inherit.aes = F, color = "#F8766d") +
  stat_cor(data = subset(bucld_mulreg, Group == "TD"),
              aes(x = age_at_web_year, y = slope_children_ssl_indiv_rts_slope),
           method = "pearson", label.x = 5, label.y = 0,
           inherit.aes = F, color = "#00BFC4", size = 5) +
    stat_cor(data = subset(bucld_mulreg, Group == "ASD"),
              aes(x = age_at_web_year, y = slope_children_ssl_indiv_rts_slope),
             method = "pearson", label.x = 5, label.y = 0.01, 
           inherit.aes = F, color = "#F8766d", size = 5)

# ggsave("paper_analysis_matched/sslSlope_age_corr.png",
#        width = 15, height = 15, units = "cm")
```


```{r}
bucld_mulreg %>%
ggplot(aes(x = age_at_web_year, y = accuracy_children_tsl_accuracies, color = Group)) +
  geom_point(size = 4, shape = 1, position = pd, stroke = 1.7) +
  scale_fill_brewer(palette = "Set2") +
      labs(title = "Age and Tone SL Accuracy Correlation",
         y = "Tone SL Accuracy",  # Change x-axis label
         x = "Age") +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(
        plot.title = element_text(size=16, face="bold"),
        axis.title.x = element_text(size=14, face="bold"),
        axis.title.y = element_text(size=14, face="bold"),
        axis.text=element_text(size=12, face = "bold")
        ) +
  theme(legend.text=element_text(size=14, face="bold")) +
   theme(
    panel.background = element_rect(fill = "white"),
    legend.title = element_text(size = 16, face = "bold"),# Set plot background to white
    legend.key  = element_rect(fill = "white"),              # Set legend item backgrounds to white
    axis.line.x = element_line(colour = "black", size = 1),  # Add line to x axis
    axis.line.y = element_line(colour = "black", size = 1)   # Add line to y axis
  ) +
  geom_smooth(data = subset(bucld_mulreg, Group == "TD"),
              aes(x = age_at_web_year, y = accuracy_children_tsl_accuracies),
              method=lm, se=FALSE, show.legend = F, inherit.aes = F, color = "#00BFC4") +
  geom_smooth(data = subset(bucld_mulreg, Group == "ASD"),
              aes(x = age_at_web_year, y = accuracy_children_tsl_accuracies),
              method=lm, se=FALSE, show.legend = F, inherit.aes = F, color = "#F8766d") +
  stat_cor(data = subset(bucld_mulreg, Group == "TD"),
              aes(x = age_at_web_year, y = accuracy_children_tsl_accuracies),
           method = "pearson", label.x = 5, label.y = 0.95,
           inherit.aes = F, color = "#00BFC4", size = 5) +
    stat_cor(data = subset(bucld_mulreg, Group == "ASD"),
              aes(x = age_at_web_year, y = accuracy_children_tsl_accuracies),
             method = "pearson", label.x = 5, label.y = 0.3, 
           inherit.aes = F, color = "#F8766d", size = 5)

# ggsave("srcd_figure/tsl_age_corr.png",
       # width = 10, height = 15, units = "cm")
```

# Plot Accuracy and RT Slope Correlation
```{r}
bucld_mulreg %>%
ggplot(aes(x = slope_children_lsl_indiv_rts_slope, y = accuracy_children_lsl_accuracies, color = Group)) +
  geom_point(size = 4, shape = 1, position = pd, stroke = 1.7) +
  scale_fill_brewer(palette = "Set2") +
      labs(title = "Letter SL Accuracy and RT Slope Correlation",
         y = "Letter SL Accuracy",  # Change x-axis label
         x = "Letter SL RT Slope (arbitrary unit/ trial)") +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(
        plot.title = element_text(size=16, face="bold"),
        axis.title.x = element_text(size=14, face="bold"),
        axis.title.y = element_text(size=14, face="bold"),
        axis.text=element_text(size=12, face = "bold")
        ) +
  theme(legend.text=element_text(size=14, face="bold")) +
   theme(
    panel.background = element_rect(fill = "white"),
    legend.title = element_text(size = 16, face = "bold"),# Set plot background to white
    legend.key  = element_rect(fill = "white"),              # Set legend item backgrounds to white
    axis.line.x = element_line(colour = "black", size = 1),  # Add line to x axis
    axis.line.y = element_line(colour = "black", size = 1)   # Add line to y axis
  ) +
  geom_smooth(data = subset(bucld_mulreg, Group == "TD"),
              aes(x = slope_children_lsl_indiv_rts_slope, y = accuracy_children_lsl_accuracies),
              method=lm, se=FALSE, show.legend = F, inherit.aes = F, color = "#00BFC4") +
  geom_smooth(data = subset(bucld_mulreg, Group == "ASD"),
              aes(x = slope_children_lsl_indiv_rts_slope, y = accuracy_children_lsl_accuracies),
              method=lm, se=FALSE, show.legend = F, inherit.aes = F, color = "#F8766d") +
  stat_cor(data = subset(bucld_mulreg, Group == "TD"),
              aes(x = slope_children_lsl_indiv_rts_slope, y = accuracy_children_lsl_accuracies),
           method = "pearson", label.x = 0, label.y = 0.95,
           inherit.aes = F, color = "#00BFC4", size = 5) +
    stat_cor(data = subset(bucld_mulreg, Group == "ASD"),
              aes(x = slope_children_lsl_indiv_rts_slope, y = accuracy_children_lsl_accuracies),
             method = "pearson", label.x = 0, label.y = 0.3, 
           inherit.aes = F, color = "#F8766d", size = 5)

# ggsave("srcd_figure/acc_slope_lslCorr.png",
       # width = 15, height = 15, units = "cm")
```


```{r}
bucld_mulreg %>%
ggplot(aes(x = slope_children_ssl_indiv_rts_slope, y = accuracy_children_ssl_accuracies, color = Group)) +
  geom_point(size = 4, shape = 1, position = pd, stroke = 1.7) +
  scale_fill_brewer(palette = "Set2") +
      labs(title = "Syllable SL Accuracy and RT Slope Correlation",
         y = "Syllable SL Accuracy",  # Change x-axis label
         x = "Syllable SL RT Slope (arbitrary unit/ trial)") +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(
        plot.title = element_text(size=16, face="bold"),
        axis.title.x = element_text(size=14, face="bold"),
        axis.title.y = element_text(size=14, face="bold"),
        axis.text=element_text(size=12, face = "bold")
        ) +
  theme(legend.text=element_text(size=14, face="bold")) +
   theme(
    panel.background = element_rect(fill = "white"),
    legend.title = element_text(size = 16, face = "bold"),# Set plot background to white
    legend.key  = element_rect(fill = "white"),              # Set legend item backgrounds to white
    axis.line.x = element_line(colour = "black", size = 1),  # Add line to x axis
    axis.line.y = element_line(colour = "black", size = 1)   # Add line to y axis
  ) +
  geom_smooth(data = subset(bucld_mulreg, Group == "TD"),
              aes(x = slope_children_ssl_indiv_rts_slope, y = accuracy_children_ssl_accuracies),
              method=lm, se=FALSE, show.legend = F, inherit.aes = F, color = "#00BFC4") +
  geom_smooth(data = subset(bucld_mulreg, Group == "ASD"),
              aes(x = slope_children_ssl_indiv_rts_slope, y = accuracy_children_ssl_accuracies),
              method=lm, se=FALSE, show.legend = F, inherit.aes = F, color = "#F8766d") +
  stat_cor(data = subset(bucld_mulreg, Group == "TD"),
              aes(x = slope_children_ssl_indiv_rts_slope, y = accuracy_children_ssl_accuracies),
           method = "pearson", label.x = 0, label.y = 0.95,
           inherit.aes = F, color = "#00BFC4", size = 5) +
    stat_cor(data = subset(bucld_mulreg, Group == "ASD"),
              aes(x = slope_children_ssl_indiv_rts_slope, y = accuracy_children_ssl_accuracies),
             method = "pearson", label.x = 0, label.y = 0.3, 
           inherit.aes = F, color = "#F8766d", size = 5) +
  geom_text(aes(label = part_id))

# ggsave("srcd_figure/acc_slope_sslCorr.png",
       # width = 10, height = 15, units = "cm")
```

# Cocor compare correlations
```{r}
library(cocor)
cocor.indep.groups(r1.jk=+0.85, r2.hm=+0.31, n1=12, n2=21, alternative="two.sided", alpha=0.05, conf.level=0.95, null.value=0)
```






# RT slope and vsl 

LSL vs. VSL Slope interaction
```{r}
library(ggpubr)
colnames(bucld_mulreg)[colnames(bucld_mulreg) == "group"] <- "Group"

pd <- position_dodge(width = 0.01)

bucld_mulreg %>%
ggplot(aes(x = slope_children_vsl_indiv_rts_slope, y = slope_children_lsl_indiv_rts_slope, color = Group)) +
  geom_point(size = 4, shape = 1, position = pd, stroke = 1.7) +
  scale_fill_brewer(palette = "Set2") +
      labs(title = "Image and Letter Reaction Time Slope Correlation",
         y = "Letter Reaction Time Slope (arbitrary unit/ trial)",  # Change x-axis label
         x = "Image Reaction Time Slope (arbitrary unit/ trial)") +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(
        plot.title = element_text(size=16, face="bold"),
        axis.title.x = element_text(size=14, face="bold"),
        axis.title.y = element_text(size=14, face="bold"),
        axis.text=element_text(size=12, face = "bold")
        ) +
  theme(legend.text=element_text(size=14, face="bold")) +
   theme(
    panel.background = element_rect(fill = "white"),
    legend.title = element_text(size = 16, face = "bold"),# Set plot background to white
    legend.key  = element_rect(fill = "white"),              # Set legend item backgrounds to white
    axis.line.x = element_line(colour = "black", size = 1),  # Add line to x axis
    axis.line.y = element_line(colour = "black", size = 1)   # Add line to y axis
  ) +
  geom_smooth(data = subset(bucld_mulreg, Group == "TD"),
              aes(x = slope_children_vsl_indiv_rts_slope, y = slope_children_lsl_indiv_rts_slope),
              method=lm, se=FALSE, show.legend = F, inherit.aes = F, color = "#00BFC4") +
  geom_smooth(data = subset(bucld_mulreg, Group == "ASD"),
              aes(x = slope_children_vsl_indiv_rts_slope, y = slope_children_lsl_indiv_rts_slope),
              method=lm, se=FALSE, show.legend = F, inherit.aes = F, color = "#F8766d") +
stat_cor(data = subset(bucld_mulreg, Group == "TD"),
            aes(x = slope_children_vsl_indiv_rts_slope, y = slope_children_lsl_indiv_rts_slope),
         method = "pearson", label.x = -0.025, label.y = -0.05,
         inherit.aes = F, color = "#00BFC4", size = 5) +
  stat_cor(data = subset(bucld_mulreg, Group == "ASD"),
            aes(x = slope_children_vsl_indiv_rts_slope, y = slope_children_lsl_indiv_rts_slope),
           method = "pearson", label.x = -0.025, label.y = 0.07,
         inherit.aes = F, color = "#F8766d", size = 5)
geom_text(aes(x = 20, y = 120, label = paste("rho =", "-0.76**")),color = "red",size=4)

# ggsave("srcd_figure/lsl_vsl_rtSlopeCorr.png",
       # width = 10, height = 15, units = "cm")

```


# SSL vs. TSL slope interaction (due to outlier probably)
```{r, include = F}
library("ggpubr")
bucld_mulreg %>%
ggplot(aes(x = slope_children_ssl_indiv_rts_slope, y = slope_children_tsl_indiv_rts_slope, color = Group)) +
  geom_point(size = 4, alpha = 0.8) +
  scale_fill_brewer(palette = "Set2") +
      labs(title = "Syllable and Tone Reaction Time Slope Correlation",
          x = "Syllable Reaction Time Slope (arbitrary unit/ trial)",
          y = "Tone Reaction Time Slope (arbitrary unit/ trial)") +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(
        plot.title = element_text(size=16, face="bold"),
        axis.title.x = element_text(size=14, face="bold"),
        axis.title.y = element_text(size=14, face="bold"),
        axis.text=element_text(size=12, face = "bold")
        ) +
  theme(legend.text=element_text(size=14, face="bold")) +
   theme(
    panel.background = element_rect(fill = "white"),
    legend.title = element_text(size = 16, face = "bold"),# Set plot background to white
    legend.key  = element_rect(fill = "white"),              # Set legend item backgrounds to white
    axis.line.x = element_line(colour = "black", size = 1),  # Add line to x axis
    axis.line.y = element_line(colour = "black", size = 1)   # Add line to y axis
  ) +
  geom_smooth(data = subset(bucld_mulreg, Group == "TD"),
              aes(x = slope_children_ssl_indiv_rts_slope, 
                  y = slope_children_tsl_indiv_rts_slope),
              method=lm, se=FALSE, show.legend = F, inherit.aes = F, color = "#00BFC4") +
  geom_smooth(data = subset(bucld_mulreg, Group == "ASD"),
              aes(x = slope_children_ssl_indiv_rts_slope, 
                  y = slope_children_tsl_indiv_rts_slope),
              method=lm, se=FALSE, show.legend = F, inherit.aes = F, color = "#F8766d") +
  stat_cor(data = subset(bucld_mulreg, Group == "TD"),
              aes(x = slope_children_ssl_indiv_rts_slope,
                  y = slope_children_tsl_indiv_rts_slope),
           method = "pearson", label.x = 0, label.y = -0.05,
           inherit.aes = F, color = "#00BFC4", size = 5) +
    stat_cor(data = subset(bucld_mulreg, Group == "ASD"),
              aes(x = slope_children_ssl_indiv_rts_slope, 
                  y = slope_children_tsl_indiv_rts_slope),
             method = "pearson", label.x = 0, label.y = -0.04,
           inherit.aes = F, color = "#F8766d", size = 5)
  #+
  #geom_text(aes(x = 20, y = 120, label = paste("rho =", "-0.76**")),color = "red",size=4)

```



# Plot GJT raw against letter and image Mean RT in ASD
```{r, include = F, eval=F}
library("ggpubr")
pd <- position_dodge(width = 0.01)

bucld_mulreg[which(bucld_mulreg$Group == "ASD"),c(1:40)] %>%
ggplot(aes(x = rt_children_lsl_indiv_rts, y = a_prime, color = Group)) +
  geom_point(size = 4, shape = 1, position = pd, stroke = 1.7) +
  scale_fill_brewer(palette = "Set2") +
      labs(title = "Letter Mean RT and GJT Correlation",
          x = "Letter SL Mean Reaction Time (ms)",
          y = "Grammaticality Judgment Raw Score") +
  theme(plot.title = element_text(hjust = 0.5)) +r
  theme(
        plot.title = element_text(size=16, face="bold"),
        axis.title.x = element_text(size=14, face="bold"),
        axis.title.y = element_text(size=14, face="bold"),
        axis.text=element_text(size=12, face = "bold")
        ) +
  theme(legend.text=element_text(size=14, face="bold")) +
   theme(
    panel.background = element_rect(fill = "white"),
    legend.title = element_text(size = 16, face = "bold"),# Set plot background to white
    legend.key  = element_rect(fill = "white"),              # Set legend item backgrounds to white
    axis.line.x = element_line(colour = "black", size = 1),  # Add line to x axis
    axis.line.y = element_line(colour = "black", size = 1)   # Add line to y axis
  ) +
  geom_smooth(data = subset(bucld_mulreg, Group == "ASD"),
              aes(x = rt_children_lsl_indiv_rts, y = a_prime),
              method=lm, se=FALSE, show.legend = F, inherit.aes = F, color = "#F8766d") +
  geom_text(aes(x= 800, y = 1, label = paste0("")), size=7, color="#F8766d") 
   

# ggsave("bucld_gjt_lsl_rt_corr.png",
       width = 13, height = 15, units = "cm")
  #+ 
  #geom_text(aes(x = 20, y = 120, label = paste("rho =",
```


## Behavioral Correlations
```{r, include = FALSE}
library("Hmisc")
bucld_all_completed_td <- bucld_all_completed[which(bucld_all_completed$group == "TD"),]
bucld_all_completed_asd <- bucld_all_completed[which(bucld_all_completed$group == "ASD"),]

extract_data_for_corr <- 
function(df) {rcorr(as.matrix(df[,c(
      "age_at_web_year",
      "kbit_matrices_std",
      "scq_web",
      "rsr_raw",
      "rsr_std",
      "gjt_std_score_gjt_web",
      "a_prime",
      "accuracy_children_vsl_accuracies",
      "entropy_children_vsl_entropy",
      "rt_children_vsl_indiv_rts",
      "slope_children_vsl_indiv_rts_slope",
      "accuracy_children_lsl_accuracies",
      "entropy_children_lsl_entropy",
      "rt_children_lsl_indiv_rts",
      "slope_children_lsl_indiv_rts_slope",
      "accuracy_children_tsl_accuracies",
      "entropy_children_tsl_entropy",
      "rt_children_tsl_indiv_rts",
      "slope_children_tsl_indiv_rts_slope",
      "accuracy_children_ssl_accuracies",
      "entropy_children_ssl_entropy",
      "rt_children_ssl_indiv_rts",
      "slope_children_ssl_indiv_rts_slope"
      )]), 
                         type = c("pearson"))}


extract_data_for_corr_td <- 
function(df) {rcorr(as.matrix(df[,c(
      "age_at_web_year",
      "kbit_matrices_std",
      # "scq_total",
      # "rsr_raw",
       # "rsr_std",
      # "gjt_std_score_gjt_web",
      # "a_prime",
      "accuracy_children_vsl_accuracies",
      "entropy_children_vsl_entropy",
      "rt_children_vsl_indiv_rts",
      "slope_children_vsl_indiv_rts_slope",
      "accuracy_children_lsl_accuracies",
      "entropy_children_lsl_entropy",
      "rt_children_lsl_indiv_rts",
      "slope_children_lsl_indiv_rts_slope",
      "accuracy_children_tsl_accuracies",
      "entropy_children_tsl_entropy",
      "rt_children_tsl_indiv_rts",
      "slope_children_tsl_indiv_rts_slope",
      "accuracy_children_ssl_accuracies",
      "entropy_children_ssl_entropy",
      "rt_children_ssl_indiv_rts",
      "slope_children_ssl_indiv_rts_slope"
      )]), 
                         type = c("pearson"))}

extract_data_jove <- 
function(df) {rcorr(as.matrix(df[,c(
  "age_at_web_year",
      # "kbit_matrices_std",
      # "scq_total",
      # "rsr_raw",
       # "rsr_std",
      # "gjt_std_score_gjt_web",
      # "a_prime",
      "accuracy_children_vsl_accuracies",
      # "entropy_children_vsl_entropy",
      "rt_children_vsl_indiv_rts",
      "slope_children_vsl_indiv_rts_slope",
      "accuracy_children_lsl_accuracies",
      # "entropy_children_lsl_entropy",
      # "rt_children_lsl_indiv_rts",
      "slope_children_lsl_indiv_rts_slope",
      "accuracy_children_tsl_accuracies",
      # "entropy_children_tsl_entropy",
      # "rt_children_tsl_indiv_rts",
      "slope_children_tsl_indiv_rts_slope",
      "accuracy_children_ssl_accuracies",
      # "entropy_children_ssl_entropy",
      # "rt_children_ssl_indiv_rts",
      "slope_children_ssl_indiv_rts_slope")]), type = c("pearson"))}

extract_data_adult <- 
function(df) {rcorr(as.matrix(df[,c(
  "age_at_web_year",
      # "kbit_matrices_std",
      # "scq_total",
      # "rsr_raw",
       # "rsr_std",
      # "gjt_std_score_gjt_web",
      # "a_prime",
      "accuracy_adult_vsl_accuracies",
      # "entropy_children_vsl_entropy",
      # "rt_adult_vsl_indiv_rts",
      "slope_adult_vsl_indiv_rts_slope",
      "accuracy_adult_lsl_accuracies",
      # "entropy_children_lsl_entropy",
      # "rt_children_lsl_indiv_rts",
      "slope_adult_lsl_indiv_rts_slope",
      "accuracy_adult_tsl_accuracies",
      # "entropy_children_tsl_entropy",
      # "rt_children_tsl_indiv_rts",
      "slope_adult_tsl_indiv_rts_slope",
      "accuracy_adult_ssl_accuracies",
      # "entropy_children_ssl_entropy",
      # "rt_children_ssl_indiv_rts",
      "slope_adult_ssl_indiv_rts_slope")]), type = c("pearson"))}

corr_beh_result <- extract_data_for_corr(bucld_all_completed)
corr_beh_result_td <- extract_data_for_corr_td(bucld_all_completed_td)
corr_beh_result_asd <- extract_data_for_corr(bucld_all_completed_asd)

corr_beh_result_jove <- extract_data_jove(bucld_all_completed_td)
asdAccSlopeCorr <- extract_data_jove(bucld_all_completed_asd)
bothAccSlopeCorr <- extract_data_jove(bucld_all_completed)
adultAccSlopeCorr <- extract_data_adult(blast_adult_wide)
```


```{r}
extract_data_for_corr_task <-
function(df) {rcorr(as.matrix(df[,c(
      "age_at_web_year",
      "kbit_matrices_std",
      "scq_web",
      "rsr_raw",
      "rsr_std",
      "gjt_std_score_gjt_web",
      "a_prime",
      "accuracy_children_vsl_accuracies",
      "accuracy_children_lsl_accuracies",
      "accuracy_children_tsl_accuracies",
      "accuracy_children_ssl_accuracies",
      "entropy_children_vsl_entropy",
      "entropy_children_lsl_entropy",
      "entropy_children_tsl_entropy",
      "entropy_children_ssl_entropy",
      "rt_children_vsl_indiv_rts",
      "rt_children_lsl_indiv_rts",
      "rt_children_tsl_indiv_rts",
      "rt_children_ssl_indiv_rts",
      "slope_children_vsl_indiv_rts_slope",
      "slope_children_lsl_indiv_rts_slope",
      "slope_children_tsl_indiv_rts_slope",
      "slope_children_ssl_indiv_rts_slope"
      )]), 
      type = c("pearson"))}

extract_data_for_corr_task_td <-
function(df) {rcorr(as.matrix(df[,c(
      "age_at_web_year",
      "kbit_matrices_std",
      "accuracy_children_vsl_accuracies",
      "accuracy_children_lsl_accuracies",
      "accuracy_children_tsl_accuracies",
      "accuracy_children_ssl_accuracies",
      "entropy_children_vsl_entropy",
      "entropy_children_lsl_entropy",
      "entropy_children_tsl_entropy",
      "entropy_children_ssl_entropy",
      "rt_children_vsl_indiv_rts",
      "rt_children_lsl_indiv_rts",
      "rt_children_tsl_indiv_rts",
      "rt_children_ssl_indiv_rts",
      "slope_children_vsl_indiv_rts_slope",
      "slope_children_lsl_indiv_rts_slope",
      "slope_children_tsl_indiv_rts_slope",
      "slope_children_ssl_indiv_rts_slope")]), 
      type = c("pearson"))}

extract_data_for_corr_task_jove <-
  function(df) {rcorr(as.matrix(df[,c(
    "age_at_web_year",
      "accuracy_children_vsl_accuracies",
      "accuracy_children_lsl_accuracies",
      "accuracy_children_tsl_accuracies",
      "accuracy_children_ssl_accuracies",
      "entropy_children_vsl_entropy",
      "slope_children_vsl_indiv_rts_slope",
      "slope_children_lsl_indiv_rts_slope",
      "slope_children_tsl_indiv_rts_slope",
      "slope_children_ssl_indiv_rts_slope")]), type = c("pearson"))}

extract_data_for_corr_task_adult <-
  function(df) {rcorr(as.matrix(df[,c(
      "age_at_web_year",
      "accuracy_adult_vsl_accuracies",
      "accuracy_adult_lsl_accuracies",
      "accuracy_adult_tsl_accuracies",
      "accuracy_adult_ssl_accuracies",
      "slope_adult_vsl_indiv_rts_slope",
      "slope_adult_lsl_indiv_rts_slope",
      "slope_adult_tsl_indiv_rts_slope",
      "slope_adult_ssl_indiv_rts_slope")]), 
  type = c("pearson"))}



corr_beh_result_across_task <- extract_data_for_corr_task(bucld_all_completed)
corr_beh_result_across_task_td <- extract_data_for_corr_task_td(bucld_all_completed_td)
corr_beh_result_across_task_asd <- extract_data_for_corr_task(bucld_all_completed_asd)

corr_beh_result_across_task_jove <- extract_data_for_corr_task_jove(bucld_all_completed_td)
asdAccSlopeCorrTask <- extract_data_for_corr_task_jove(bucld_all_completed_asd)
bothAccSlopeCorrTask <- extract_data_for_corr_task_jove(bucld_all_completed)

adultAccSlopeCorrTask <- extract_data_for_corr_task_adult(blast_adult_wide)




flattenCorrMatrix <- function(cormat, pmat, nmat) {
  ut <- upper.tri(cormat)
  data.frame(
    row = rownames(cormat)[row(cormat)[ut]],
    column = rownames(cormat)[col(cormat)[ut]],
    cor  = (cormat)[ut],
    p = pmat[ut],
    n = nmat[ut]
  )
}

#beh_corr_result_pearson_all <- flattenCorrMatrix(corr_beh_result_all$r, corr_beh_result_all$P, corr_beh_result_all$n)

beh_corr_result_pearson <- flattenCorrMatrix(corr_beh_result$r, corr_beh_result$P, corr_beh_result$n)
beh_corr_result_pearson_td <- flattenCorrMatrix(corr_beh_result_td$r, corr_beh_result_td$P, corr_beh_result_td$n)
beh_corr_result_pearson_asd <- flattenCorrMatrix(corr_beh_result_asd$r, corr_beh_result_asd$P, corr_beh_result_asd$n)

beh_corr_result_pearson_jove <- flattenCorrMatrix(corr_beh_result_jove$r, corr_beh_result_jove$P, corr_beh_result_jove$n)
beh_asdAccSlopeCorr <- flattenCorrMatrix(asdAccSlopeCorr$r, asdAccSlopeCorr$P, asdAccSlopeCorr$n)
beh_bothAccSlopeCorr <- flattenCorrMatrix(bothAccSlopeCorr$r, bothAccSlopeCorr$P, bothAccSlopeCorr$n)
beh_adultAccSlopeCorr <- flattenCorrMatrix(adultAccSlopeCorr$r, adultAccSlopeCorr$P, adultAccSlopeCorr$n)


beh_corr_result_pearson_task <- flattenCorrMatrix(corr_beh_result_across_task$r, 
                                              corr_beh_result_across_task$P, 
                                              corr_beh_result_across_task$n)

beh_corr_result_pearson_task_td <- flattenCorrMatrix(corr_beh_result_across_task_td$r, 
                                              corr_beh_result_across_task_td$P, 
                                              corr_beh_result_across_task_td$n)


beh_corr_result_pearson_task_asd <- flattenCorrMatrix(corr_beh_result_across_task_asd$r, 
                                              corr_beh_result_across_task_asd$P, 
                                              corr_beh_result_across_task_asd$n)


beh_corr_result_pearson_task_jove <- flattenCorrMatrix(corr_beh_result_across_task_jove$r, 
                                              corr_beh_result_across_task_jove$P, 
                                              corr_beh_result_across_task_jove$n)

beh_asdAccSlopeCorrTask <- flattenCorrMatrix(asdAccSlopeCorrTask$r, 
                                              asdAccSlopeCorrTask$P, 
                                              asdAccSlopeCorrTask$n)

beh_bothAccSlopeCorrTask <- flattenCorrMatrix(bothAccSlopeCorrTask$r, 
                                              bothAccSlopeCorrTask$P, 
                                              bothAccSlopeCorrTask$n)

beh_adultAccSlopeCorrTask <- flattenCorrMatrix(adultAccSlopeCorrTask$r, 
                                              adultAccSlopeCorrTask$P, 
                                              adultAccSlopeCorrTask$n)


#beh_corr_result_pearson_all[,c(3:5)] <- round(beh_corr_result_pearson_all[,c(3:5)], 3)

beh_corr_result_pearson[,c(3:5)] <- round(beh_corr_result_pearson[,c(3:5)], 3)

rounded_td <- round(beh_corr_result_pearson_td[,c(3:5)], 3)
beh_corr_result_pearson_td <- cbind(beh_corr_result_pearson_td[,c(1:2)], rounded_td)

rounded_asd <- round(beh_corr_result_pearson_asd[,c(3:5)], 3)
beh_corr_result_pearson_asd <- cbind(beh_corr_result_pearson_asd[,c(1:2)], rounded_asd)

#beh_corr_result_pearson_sig_all <- beh_corr_result_pearson_all[which(beh_corr_result_pearson_all$p <= 0.05),]
```


```{r}
beh_corr_result_pearson_sig <- beh_corr_result_pearson[which(beh_corr_result_pearson$p <= 0.05),]
beh_corr_result_pearson_sig_td <- beh_corr_result_pearson_td[which(beh_corr_result_pearson_td$p <= 0.05),]
beh_corr_result_pearson_sig_asd <- beh_corr_result_pearson_asd[which(beh_corr_result_pearson_asd$p <= 0.05),]

# write.csv(beh_corr_result_pearson_sig, "paper_analysis_matched/beh_corr_result_pearson_gender_matched_sample.csv")
# write.csv(beh_corr_result_pearson_sig_td, "paper_analysis_matched/beh_corr_result_pearson_gender_matched_sample_td.csv")
# write.csv(beh_corr_result_pearson_sig_asd, "paper_analysis_matched/beh_corr_result_pearson_gender_matched_sample_asd.csv")


print(beh_corr_result_pearson_sig)
print(beh_corr_result_pearson_sig_td)
print(beh_corr_result_pearson_sig_asd)
```


# RSR and GJT Descriptive Stat
```{r}
tdRSRDec <- stat.desc(bucld_all_completed_td[,c("rsr_std", "rsr_raw", "a_prime", "gjt_std_score_gjt_web")])
tdRSRDec <- tdRSRDec[c("nbr.val","mean", "std.dev", "max", "min"),]
tdRSRDec <- data.frame(tdRSRDec)
tdRSRDec[nrow(tdRSRDec)+1,] <- "TD"

asdRSRDec <- stat.desc(bucld_all_completed_asd[,c("rsr_std", "rsr_raw", "a_prime", "gjt_std_score_gjt_web")])
asdRSRDec <- asdRSRDec[c("nbr.val","mean", "std.dev", "max", "min"),]
asdRSRDec <- data.frame(asdRSRDec)
asdRSRDec[nrow(asdRSRDec)+1,] <- "ASD"

GJTrsrDec <- cbind(tdRSRDec, asdRSRDec)
print(GJTrsrDec)

# write.csv(GJTrsrDec, "paper_analysis_matched/GJTrsrDec.csv")
```
  

# Correlation between SL tasks for TD
```{r}
library(RcmdrMisc)
sl_corr <-
rcorr.adjust(as.matrix(bucld_all_completed_td[c("accuracy_children_ssl_accuracies",
      "accuracy_children_tsl_accuracies",
      "accuracy_children_lsl_accuracies",
      "accuracy_children_vsl_accuracies",
      "slope_children_ssl_indiv_rts_slope",
      "slope_children_tsl_indiv_rts_slope",
      "slope_children_lsl_indiv_rts_slope",
      "slope_children_vsl_indiv_rts_slope"
      )]),
      use=c("pairwise.complete.obs"))

tdSL_corr <-
flattenCorrMatrix(data.frame(sl_corr$R[1]),
                  data.frame(sl_corr$R[3]),
                  data.frame(sl_corr$R[2]))
                  
# write.csv(data.frame(sl_corr$R[1]), "srcd_figure/tdSL_peaR.csv")
# write.csv(tdSL_corr, "srcd_figure/tdSL_corr_corrected.csv")
```

# Correlation between SL tasks for ASD
```{r}
sl_corrASD <-
rcorr.adjust(as.matrix(bucld_all_completed_asd[c("accuracy_children_ssl_accuracies",
      "accuracy_children_tsl_accuracies",
      "accuracy_children_lsl_accuracies",
      "accuracy_children_vsl_accuracies")]),
      use=c("pairwise.complete.obs"))


sl_lang_corrASD <-
rcorr.adjust(as.matrix(bucld_all_completed[c("rsr_std",
                                                 "gjt_std_score_gjt_web",
                                             "scq_web",
  "accuracy_children_ssl_accuracies",
      "accuracy_children_tsl_accuracies",
      "accuracy_children_lsl_accuracies",
      "accuracy_children_vsl_accuracies")]),
      use=c("pairwise.complete.obs"))


asdSL_corr <-
flattenCorrMatrix(data.frame(sl_corrASD$R[1]),
                  sl_corrASD$P,
                  data.frame(sl_corrASD$R[2]))
                  

slSlope_corrASD <-
rcorr.adjust(as.matrix(bucld_all_completed_asd[c("slope_children_ssl_indiv_rts_slope",
      "slope_children_tsl_indiv_rts_slope",
      "slope_children_lsl_indiv_rts_slope",
      "slope_children_vsl_indiv_rts_slope")]),
      use=c("pairwise.complete.obs"))

asdSL_corr <-
flattenCorrMatrix(data.frame(sl_corrASD$R[1]),
                  sl_corrASD$P,
                  data.frame(sl_corrASD$R[2]))


# write.csv(data.frame(sl_corrASD$R[1]), "srcd_figure/asdSL_peaR.csv")
# write.csv(asdSL_corr, "srcd_figure/asdSL_corr_corrected.csv")
```


# Correlation between SL RT Slope for TD
```{r}
sl_corr_slope <-
rcorr.adjust(as.matrix(bucld_all_completed_td[c("slope_children_ssl_indiv_rts_slope",
      "slope_children_tsl_indiv_rts_slope",
      "slope_children_lsl_indiv_rts_slope",
      "slope_children_vsl_indiv_rts_slope")]),
      use=c("pairwise.complete.obs"))

tdSL_corrSlp <-
flattenCorrMatrix(data.frame(sl_corr_slope$R[1]),
                  sl_corr_slope$P,
                  data.frame(sl_corr_slope$R[2]))

print(sl_corr_slope)
```

**No significant correlation in between SL tasks for RT slope in TD**


# Correlation between SL tasks for ASD
```{r}
sl_corr_slopeASD <-
rcorr.adjust(as.matrix(bucld_all_completed_asd[c("slope_children_ssl_indiv_rts_slope",
      "slope_children_tsl_indiv_rts_slope",
      "slope_children_lsl_indiv_rts_slope",
      "slope_children_vsl_indiv_rts_slope")]),
      use=c("pairwise.complete.obs"))

asdSL_corrSlp <-
flattenCorrMatrix(data.frame(sl_corr_slopeASD$R[1]),
                  sl_corr_slopeASD$P,
                  data.frame(sl_corr_slopeASD$R[2]))

print(sl_corr_slopeASD)
```
**No significant correlation in between SL tasks for RT slope in ASD.**


# Partial Correlation inbetween SL tasks for TD
```{r, include = F}
library("ppcor")
partial_corr_data_vsl <- subset(bucld_all_completed_td, !is.na(accuracy_children_vsl_accuracies)) 

VS <- subset(partial_corr_data_vsl, !is.na(accuracy_children_ssl_accuracies)) 

partial_corr_data_lsl <- subset(bucld_all_completed_td, !is.na(accuracy_children_lsl_accuracies)) 

SL <- subset(partial_corr_data_lsl, !is.na(accuracy_children_ssl_accuracies)) 

VL <- subset(partial_corr_data_vsl, !is.na(rt_children_lsl_indiv_rts)) 

VT <- subset(partial_corr_data_vsl, !is.na(accuracy_children_tsl_accuracies)) 

VGJtd <- subset(partial_corr_data_vsl, !is.na(a_prime)) 

partial_corr_asd_vsl <- subset(bucld_all_completed_asd, !is.na(accuracy_children_vsl_accuracies)) 

VGJasd <- subset(partial_corr_asd_vsl, !is.na(a_prime))

```




# Partial Correlation inbetween SL task and Language assessments
```{r}
library("ppcor")
library("psych")

VGJasd_parCor <-
  pcor.test(VGJasd$a_prime,
            VGJasd$accuracy_children_vsl_accuracies,
            VGJasd[,c("age_at_web_year")],method="pearson")

print(VGJasd_parCor)


Vslope_GJasd_parCor <-
  pcor.test(VGJasd$a_prime,
            VGJasd$slope_children_vsl_indiv_rts_slope,
            VGJasd[,c("age_at_web_year")],method="pearson")

print(Vslope_GJasd_parCor)


# VS_parCor <-
#   pcor.test(VS$accuracy_children_vsl_accuracies,
#             VS$accuracy_children_ssl_accuracies,
#             VS[,c("age_at_web_year")],method="pearson")
# # partial_corr_lsl_result_asd <- describe(partial_corr_lsl_result)
# print(VS_parCor)

VL_parCor <-
  pcor.test(VL$accuracy_children_vsl_accuracies,
            VL$accuracy_children_lsl_accuracies,
            VL[,c("age_at_web_year")],method="pearson")
# partial_corr_lsl_result_asd <- describe(partial_corr_lsl_result)
print(VL_parCor)

VT_parCor <-
  pcor.test(VT$accuracy_children_vsl_accuracies,
            VT$accuracy_children_tsl_accuracies,
            VT[,c("age_at_web_year")],method="pearson")
# partial_corr_lsl_result_asd <- describe(partial_corr_lsl_result)
print(VT_parCor)
# ggplot(bucld_all_completed_td,
#        aes(x=accuracy_children_vsl_accuracies, y = accuracy_children_ssl_accuracies, color = group)) +
#   geom_point() 
# 
# SL_parCor <- 
#   pcor.test(SL$accuracy_children_ssl_accuracies,
#             SL$accuracy_children_lsl_accuracies,
#             SL[,c("age_at_web_year")],method="pearson")
# # partial_corr_lsl_result_asd <- describe(partial_corr_lsl_result)
# print(SL_parCor)
# 
# ggplot(bucld_all_completed_td,
#        aes(x=accuracy_children_ssl_accuracies, y = accuracy_children_lsl_accuracies, color = group)) +
#   geom_point() 
# 
# VL_parCor <- 
#   pcor.test(VL$accuracy_children_vsl_accuracies,
#             VL$accuracy_children_lsl_accuracies,
#             VL[,c("age_at_web_year")],method="pearson")
# # partial_corr_lsl_result_asd <- describe(partial_corr_lsl_result)
# print(VL_parCor)
# 
# ggplot(bucld_all_completed_td,
#        aes(x=accuracy_children_vsl_accuracies, y = accuracy_children_lsl_accuracies, color = group)) +
#   geom_point() 


# VTasd_parCor <- 
#   pcor.test(VTasd$accuracy_children_vsl_accuracies,
#             VTasd$accuracy_children_tsl_accuracies,
#             VTasd[,c("age_at_web_year")],method="pearson")
# # partial_corr_lsl_result_asd <- describe(partial_corr_lsl_result)
# print(VTasd_parCor)
```





# Plot RSR Standard correaltions with SL
```{r}
rsrCorr_all <- 
bucld_all_completed[,c("part_id", "group", "rsr_std",
                       # "age_at_web_year",
      # "kbit_matrices_std",
      "scq_web",
      # "rsr_raw",
      # "rsr_std",
      "gjt_std_score_gjt_web",
      # "a_prime",
      # "accuracy_children_ssl_accuracies",
      "accuracy_children_tsl_accuracies",
      "accuracy_children_lsl_accuracies",
      "accuracy_children_vsl_accuracies",
      # "entropy_children_ssl_entropy",
      # "entropy_children_tsl_entropy",
      # "entropy_children_lsl_entropy",
      # "entropy_children_vsl_entropy",
      # "rt_children_ssl_indiv_rts",
      # "rt_children_tsl_indiv_rts",
      # "rt_children_lsl_indiv_rts",
      # "rt_children_vsl_indiv_rts",
      "slope_children_ssl_indiv_rts_slope",
      # "slope_children_tsl_indiv_rts_slope",
      "slope_children_lsl_indiv_rts_slope"
      # "slope_children_vsl_indiv_rts_slope"
                       )]
```

Plot RSR vs. SCQ in ASD
```{r}
rsrPlot <- bucld_all_completed
rsrPlot$Group <- rsrPlot$group

subset(rsrPlot, Group == "ASD") %>%
ggplot(aes(x = rsr_std , y = scq_web, color = Group)) +
  geom_point(size = 4, shape = 1, position = pd, stroke = 1.7) +
  scale_fill_brewer(palette = "Set2") +
      labs(title = "SCQ Score and Sentence Recall Correlation",
         x = "Sentence Recall Standard Score",  # hange x-axis label
         y = "SCQ Score") +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(
        plot.title = element_text(size=16, face="bold"),
        axis.title.x = element_text(size=14, face="bold"),
        axis.title.y = element_text(size=14, face="bold"),
        axis.text=element_text(size=12, face = "bold")
        ) +
  theme(legend.text=element_text(size=14, face="bold")) +
   theme(
    panel.background = element_rect(fill = "white"),
    legend.title = element_text(size = 16, face = "bold"),# Set plot background to white
    legend.key  = element_rect(fill = "white"),              # Set legend item backgrounds to white
    axis.line.x = element_line(colour = "black", size = 1),  # Add line to x axis
    axis.line.y = element_line(colour = "black", size = 1)   # Add line to y axis
  ) +
  geom_smooth(data = subset(rsrPlot, Group == "ASD"),
              aes(x = rsr_std, y = scq_web),
              method=lm, se=FALSE, show.legend = F, inherit.aes = F, color = "#F8766d") 


# ggsave("srcd_figure/SCQ_RSRcorr.png",
       # width = 17, height = 17, units = "cm")
```

```{r}


rsrPlot %>%
ggplot(aes(x = rsr_std , y = accuracy_children_lsl_accuracies, color = Group)) +
  geom_point(size = 4, shape = 1, position = pd, stroke = 1.7) +
  scale_fill_brewer(palette = "Set2") +
      labs(title = "Sentence Recall and Letter SL Accuracy Correlation",
         x = "Sentence Recall Standard Score",  # hange x-axis label
         y = "Letter SL Accuracy") +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(
        plot.title = element_text(size=16, face="bold"),
        axis.title.x = element_text(size=14, face="bold"),
        axis.title.y = element_text(size=14, face="bold"),
        axis.text=element_text(size=12, face = "bold")
        ) +
  theme(legend.text=element_text(size=14, face="bold")) +
   theme(
    panel.background = element_rect(fill = "white"),
    legend.title = element_text(size = 16, face = "bold"),# Set plot background to white
    legend.key  = element_rect(fill = "white"),              # Set legend item backgrounds to white
    axis.line.x = element_line(colour = "black", size = 1),  # Add line to x axis
    axis.line.y = element_line(colour = "black", size = 1)   # Add line to y axis
  ) +
  geom_smooth(
              aes(x = rsr_std, y = accuracy_children_lsl_accuracies),
              method=lm, se=FALSE, show.legend = F, inherit.aes = F) 


# ggsave("srcd_figure/RSR_LSLcorr.png",
       # width = 17, height = 17, units = "cm")
```

```{r}

rsrPlot %>%
ggplot(aes(x = rsr_std , y = accuracy_children_vsl_accuracies, color = Group)) +
  geom_point(size = 4, shape = 1, position = pd, stroke = 1.7) +
  scale_fill_brewer(palette = "Set2") +
      labs(title = "Sentence Recall and Image SL Accuracy Correlation",
         x = "Sentence Recall Standard Score",  # hange x-axis label
         y = "Image SL Accuracy") +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(
        plot.title = element_text(size=16, face="bold"),
        axis.title.x = element_text(size=14, face="bold"),
        axis.title.y = element_text(size=14, face="bold"),
        axis.text=element_text(size=12, face = "bold")
        ) +
  theme(legend.text=element_text(size=14, face="bold")) +
   theme(
    panel.background = element_rect(fill = "white"),
    legend.title = element_text(size = 16, face = "bold"),# Set plot background to white
    legend.key  = element_rect(fill = "white"),              # Set legend item backgrounds to white
    axis.line.x = element_line(colour = "black", size = 1),  # Add line to x axis
    axis.line.y = element_line(colour = "black", size = 1)   # Add line to y axis
  ) +
  geom_smooth(
              aes(x = rsr_std, y = accuracy_children_vsl_accuracies),
              method=lm, se=FALSE, show.legend = F, inherit.aes = F) 


# ggsave("srcd_figure/RSR_VSLcorr.png",
       # width = 17, height = 17, units = "cm")
```

```{r}
rsrPlot %>%
ggplot(aes(x = rsr_std , y = slope_children_lsl_indiv_rts_slope, color = Group)) +
  geom_point(size = 4, shape = 1, position = pd, stroke = 1.7) +
  scale_fill_brewer(palette = "Set2") +
      labs(title = "Sentence Recall and Letter SL RT Slope Correlation",
         x = "Sentence Recall Standard Score",  # hange x-axis label
         y = "Letter SL RT Slope (arbitrary unit/ trial)") +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(
        plot.title = element_text(size=16, face="bold"),
        axis.title.x = element_text(size=14, face="bold"),
        axis.title.y = element_text(size=14, face="bold"),
        axis.text=element_text(size=12, face = "bold")
        ) +
  theme(legend.text=element_text(size=14, face="bold")) +
   theme(
    panel.background = element_rect(fill = "white"),
    legend.title = element_text(size = 16, face = "bold"),# Set plot background to white
    legend.key  = element_rect(fill = "white"),              # Set legend item backgrounds to white
    axis.line.x = element_line(colour = "black", size = 1),  # Add line to x axis
    axis.line.y = element_line(colour = "black", size = 1)   # Add line to y axis
  ) +
  geom_smooth(
              aes(x = rsr_std, y = slope_children_lsl_indiv_rts_slope),
              method=lm, se=FALSE, show.legend = F, inherit.aes = F) 


# ggsave("srcd_figure/RSR_LSL_Slope_corr.png",
       # width = 17, height = 17, units = "cm")

```

```{r}
rsrPlot %>%
ggplot(aes(x = rsr_std , y = slope_children_ssl_indiv_rts_slope, color = Group)) +
  geom_point(size = 4, shape = 1, position = pd, stroke = 1.7) +
  scale_fill_brewer(palette = "Set2") +
      labs(title = "Sentence Recall and Syllable SL RT Slope Correlation",
         x = "Sentence Recall Standard Score",  # hange x-axis label
         y = "Syllable SL RT Slope (arbitrary unit/ trial)") +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(
        plot.title = element_text(size=16, face="bold"),
        axis.title.x = element_text(size=14, face="bold"),
        axis.title.y = element_text(size=14, face="bold"),
        axis.text=element_text(size=12, face = "bold")
        ) +
  theme(legend.text=element_text(size=14, face="bold")) +
   theme(
    panel.background = element_rect(fill = "white"),
    legend.title = element_text(size = 16, face = "bold"),# Set plot background to white
    legend.key  = element_rect(fill = "white"),              # Set legend item backgrounds to white
    axis.line.x = element_line(colour = "black", size = 1),  # Add line to x axis
    axis.line.y = element_line(colour = "black", size = 1)   # Add line to y axis
  ) +
  geom_smooth(
              aes(x = rsr_std, y = slope_children_ssl_indiv_rts_slope),
              method=lm, se=FALSE, show.legend = F, inherit.aes = F) 


# ggsave("srcd_figure/RSR_SSL_Slope_corr.png",
       # width = 17, height = 17, units = "cm")
```


# GJT Standard correaltions with SL
```{r}
rsrPlot %>%
ggplot(aes(x = gjt_std_score_gjt_web , y = slope_children_lsl_indiv_rts_slope, color = Group)) +
  geom_point(size = 4, shape = 1, position = pd, stroke = 1.7) +
  scale_fill_brewer(palette = "Set2") +
      labs(title = "GJT and Letter SL RT Slope Correlation",
         x = "GJT Standard Score",  # hange x-axis label
         y = "Letter SL RT Slope (arbitrary unit/ trial)") +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(
        plot.title = element_text(size=16, face="bold"),
        axis.title.x = element_text(size=14, face="bold"),
        axis.title.y = element_text(size=14, face="bold"),
        axis.text=element_text(size=12, face = "bold")
        ) +
  theme(legend.text=element_text(size=14, face="bold")) +
   theme(
    panel.background = element_rect(fill = "white"),
    legend.title = element_text(size = 16, face = "bold"),# Set plot background to white
    legend.key  = element_rect(fill = "white"),              # Set legend item backgrounds to white
    axis.line.x = element_line(colour = "black", size = 1),  # Add line to x axis
    axis.line.y = element_line(colour = "black", size = 1)   # Add line to y axis
  ) +
  geom_smooth(
              aes(x = gjt_std_score_gjt_web, y = slope_children_lsl_indiv_rts_slope),
              method=lm, se=FALSE, show.legend = F, inherit.aes = F) 


# ggsave("srcd_figure/GJT_LSL_Slope_corr.png",
       # width = 17, height = 17, units = "cm")
```





```{r}
rsrPlot %>%
ggplot(aes(x = gjt_std_score_gjt_web , y = accuracy_children_tsl_accuracies, color = Group)) +
  geom_point(size = 4, shape = 1, position = pd, stroke = 1.7) +
  scale_fill_brewer(palette = "Set2") +
      labs(title = "GJT and Tone SL Accuracy Correlation",
         x = "GJT Standard Score",  # hange x-axis label
         y = "Tone SL Accuracy") +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(
        plot.title = element_text(size=16, face="bold"),
        axis.title.x = element_text(size=14, face="bold"),
        axis.title.y = element_text(size=14, face="bold"),
        axis.text=element_text(size=12, face = "bold")
        ) +
  theme(legend.text=element_text(size=14, face="bold")) +
   theme(
    panel.background = element_rect(fill = "white"),
    legend.title = element_text(size = 16, face = "bold"),# Set plot background to white
    legend.key  = element_rect(fill = "white"),              # Set legend item backgrounds to white
    axis.line.x = element_line(colour = "black", size = 1),  # Add line to x axis
    axis.line.y = element_line(colour = "black", size = 1)   # Add line to y axis
  ) +
  geom_smooth(
              aes(x = gjt_std_score_gjt_web, y = accuracy_children_tsl_accuracies),
              method=lm, se=FALSE, show.legend = F, inherit.aes = F) 


# ggsave("srcd_figure/GJT_TSLacc_corr.png",
       # width = 17, height = 17, units = "cm")
```

```{r}
rsrPlot %>%
ggplot(aes(x = gjt_std_score_gjt_web , y = accuracy_children_lsl_accuracies, color = Group)) +
  geom_point(size = 4, shape = 1, position = pd, stroke = 1.7) +
  scale_fill_brewer(palette = "Set2") +
      labs(title = "GJT and Letter SL Accuracy Correlation",
         x = "GJT Standard Score",  # hange x-axis label
         y = "Letter SL Accuracy") +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(
        plot.title = element_text(size=16, face="bold"),
        axis.title.x = element_text(size=14, face="bold"),
        axis.title.y = element_text(size=14, face="bold"),
        axis.text=element_text(size=12, face = "bold")
        ) +
  theme(legend.text=element_text(size=14, face="bold")) +
   theme(
    panel.background = element_rect(fill = "white"),
    legend.title = element_text(size = 16, face = "bold"),# Set plot background to white
    legend.key  = element_rect(fill = "white"),              # Set legend item backgrounds to white
    axis.line.x = element_line(colour = "black", size = 1),  # Add line to x axis
    axis.line.y = element_line(colour = "black", size = 1)   # Add line to y axis
  ) +
  geom_smooth(
              aes(x = gjt_std_score_gjt_web, y = accuracy_children_lsl_accuracies),
              method=lm, se=FALSE, show.legend = F, inherit.aes = F) 


# ggsave("srcd_figure/GJT_LSLacc_corr.png",
       # width = 17, height = 17, units = "cm")
```

```{r}
rsrPlot %>%
ggplot(aes(x = gjt_std_score_gjt_web , y = accuracy_children_vsl_accuracies, color = Group)) +
  geom_point(size = 4, shape = 1, position = pd, stroke = 1.7) +
  scale_fill_brewer(palette = "Set2") +
      labs(title = "GJT and Image SL Accuracy Correlation",
         x = "GJT Standard Score",  # hange x-axis label
         y = "Image SL Accuracy") +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(
        plot.title = element_text(size=16, face="bold"),
        axis.title.x = element_text(size=14, face="bold"),
        axis.title.y = element_text(size=14, face="bold"),
        axis.text=element_text(size=12, face = "bold")
        ) +
  theme(legend.text=element_text(size=14, face="bold")) +
   theme(
    panel.background = element_rect(fill = "white"),
    legend.title = element_text(size = 16, face = "bold"),# Set plot background to white
    legend.key  = element_rect(fill = "white"),              # Set legend item backgrounds to white
    axis.line.x = element_line(colour = "black", size = 1),  # Add line to x axis
    axis.line.y = element_line(colour = "black", size = 1)   # Add line to y axis
  ) +
  geom_smooth(
              aes(x = gjt_std_score_gjt_web, y = accuracy_children_vsl_accuracies),
              method=lm, se=FALSE, show.legend = F, inherit.aes = F) 


# ggsave("srcd_figure/GJT_VSLacc_corr.png",
       # width = 17, height = 17, units = "cm")
```


# Linear Regression for GJT and RSR
```{r}
gjtLM <-
lm(gjt_std_score_gjt_web~accuracy_children_vsl_accuracies + accuracy_children_tsl_accuracies + slope_children_ssl_indiv_rts_slope + slope_children_lsl_indiv_rts_slope,
   data=bucld_mulreg)
summary(gjtLM)

rsrLM <-
lm(rsr_std~accuracy_children_lsl_accuracies + accuracy_children_vsl_accuracies + slope_children_ssl_indiv_rts_slope + slope_children_lsl_indiv_rts_slope,
   data=bucld_mulreg)
summary(rsrLM)

rcorr(bucld_all_completed_td$accuracy_children_lsl_accuracies, bucld_all_completed_td$accuracy_children_ssl_accuracies, type = "pearson")

rcorr(bucld_all_completed_asd$accuracy_children_lsl_accuracies, bucld_all_completed_asd$accuracy_children_ssl_accuracies, type = "pearson")

```


# Heat Map 
```{r ,include = F}

library(plyr)

extract_heatmap_data <-
function(df,column) {
    revalue(df[[column]], c("age_at_web_year"="Age", 
                                        "kbit_matrices_std"="KBIT Standardized Score",
                                        "scq_web" = "SCQ Total",
                             "rsr_raw" = "Sentence Recall Raw Score",
                        "rsr_std" = "Sentence Recall Standardized Score",
                                        "accuracy_children_tsl_accuracies"="Tone Accuracy",
                                        "accuracy_children_ssl_accuracies"="Syllable Accuracy",
                                        "accuracy_children_vsl_accuracies"="Image Accuracy",
                                        "accuracy_children_lsl_accuracies"="Letter Accuracy",
                        "accuracy_adult_tsl_accuracies"="Tone Accuracy",
                                        "accuracy_adult_ssl_accuracies"="Syllable Accuracy",
                                        "accuracy_adult_vsl_accuracies"="Image Accuracy",
                                        "accuracy_adult_lsl_accuracies"="Letter Accuracy",
                                        "entropy_children_tsl_entropy"="Tone Entropy",
                                        "entropy_children_ssl_entropy"="Syllable Entropy",
                                        "entropy_children_vsl_entropy"="Image Entropy",
                                        "entropy_children_lsl_entropy"="Letter Entropy",
                                        "rt_children_tsl_indiv_rts"="Tone Mean RT",
                                        "rt_children_ssl_indiv_rts"="Syllable Mean RT",
                                        "rt_children_vsl_indiv_rts"="Image Mean RT",
                                        "rt_children_lsl_indiv_rts"="Letter Mean RT",
                                        "gjt_std_score_gjt_web"="GJT Standardized Score",
                                        "a_prime" = "GJT Raw Score",
                                        "slope_children_ssl_indiv_rts_slope"="Syllable RT Slope",
                                        "slope_children_tsl_indiv_rts_slope"="Tone RT Slope",
                                        "slope_children_vsl_indiv_rts_slope"="Image RT Slope",
                                        "slope_children_lsl_indiv_rts_slope"="Letter RT Slope",
                        "slope_adult_ssl_indiv_rts_slope"="Syllable RT Slope",
                                        "slope_adult_tsl_indiv_rts_slope"="Tone RT Slope",
                                        "slope_adult_vsl_indiv_rts_slope"="Image RT Slope",
                                        "slope_adult_lsl_indiv_rts_slope"="Letter RT Slope"
                                        ))}


beh_corr_result_pearson$row <- extract_heatmap_data(beh_corr_result_pearson, "row")
beh_corr_result_pearson$column <- extract_heatmap_data(beh_corr_result_pearson, "column")
beh_corr_result_pearson_td$row <- extract_heatmap_data(beh_corr_result_pearson_td, "row")
beh_corr_result_pearson_td$column <- extract_heatmap_data(beh_corr_result_pearson_td, "column")
beh_corr_result_pearson_asd$row <- extract_heatmap_data(beh_corr_result_pearson_asd, "row")
beh_corr_result_pearson_asd$column <- extract_heatmap_data(beh_corr_result_pearson_asd, "column")

beh_corr_result_pearson_jove$row <- extract_heatmap_data(beh_corr_result_pearson_jove, "row")
beh_corr_result_pearson_jove$column <- extract_heatmap_data(beh_corr_result_pearson_jove, "column")
beh_asdAccSlopeCorr$row <- extract_heatmap_data(beh_asdAccSlopeCorr, "row")
beh_asdAccSlopeCorr$column <- extract_heatmap_data(beh_asdAccSlopeCorr, "column")
beh_bothAccSlopeCorr$row <- extract_heatmap_data(beh_bothAccSlopeCorr, "row")
beh_bothAccSlopeCorr$column <- extract_heatmap_data(beh_bothAccSlopeCorr, "column")
beh_adultAccSlopeCorr$row <- extract_heatmap_data(beh_adultAccSlopeCorr, "row")
beh_adultAccSlopeCorr$column <- extract_heatmap_data(beh_adultAccSlopeCorr, "column")


extract_heatmap_data_task <- 
function(df, column) {
revalue(df[[column]], c("age_at_web_year"="Age", 
                                        "kbit_matrices_std"="KBIT Standardized Score",
                                        "scq_web" = "SCQ Total",
                        "rsr_raw" = "Sentence Recall Raw Score",
                        "rsr_std" = "Sentence Recall Standardized Score",
                                        "accuracy_children_tsl_accuracies"="Tone Accuracy",
                                        "accuracy_children_ssl_accuracies"="Syllable Accuracy",
                                        "accuracy_children_vsl_accuracies"="Image Accuracy",
                                        "accuracy_children_lsl_accuracies"="Letter Accuracy",
                        "accuracy_adult_tsl_accuracies"="Tone Accuracy",
                                        "accuracy_adult_ssl_accuracies"="Syllable Accuracy",
                                        "accuracy_adult_vsl_accuracies"="Image Accuracy",
                                        "accuracy_adult_lsl_accuracies"="Letter Accuracy",
                                        "entropy_children_tsl_entropy"="Tone Entropy",
                                        "entropy_children_ssl_entropy"="Syllable Entropy",
                                        "entropy_children_vsl_entropy"="Image Entropy",
                                        "entropy_children_lsl_entropy"="Letter Entropy",
                                        "rt_children_tsl_indiv_rts"="Tone Mean RT",
                                        "rt_children_ssl_indiv_rts"="Syllable Mean RT",
                                        "rt_children_vsl_indiv_rts"="Image Mean RT",
                                        "rt_children_lsl_indiv_rts"="Letter Mean RT",
                                        "gjt_std_score_gjt_web"="GJT Standardized Score",
                                        "a_prime" = "GJT Raw Score",
                                        "slope_children_ssl_indiv_rts_slope"="Syllable RT Slope",
                                        "slope_children_tsl_indiv_rts_slope"="Tone RT Slope",
                                        "slope_children_vsl_indiv_rts_slope"="Image RT Slope",
                                        "slope_children_lsl_indiv_rts_slope"="Letter RT Slope",
                        "slope_adult_ssl_indiv_rts_slope"="Syllable RT Slope",
                                        "slope_adult_tsl_indiv_rts_slope"="Tone RT Slope",
                                        "slope_adult_vsl_indiv_rts_slope"="Image RT Slope",
                                        "slope_adult_lsl_indiv_rts_slope"="Letter RT Slope"
                                        ))}


beh_corr_result_pearson_task$column <- extract_heatmap_data_task(beh_corr_result_pearson_task, "column")
beh_corr_result_pearson_task$row <- extract_heatmap_data_task(beh_corr_result_pearson_task, "row")
beh_corr_result_pearson_task_td$column <- extract_heatmap_data_task(beh_corr_result_pearson_task_td, "column")
beh_corr_result_pearson_task_td$row <- extract_heatmap_data_task(beh_corr_result_pearson_task_td, "row")
beh_corr_result_pearson_task_asd$column <- extract_heatmap_data_task(beh_corr_result_pearson_task_asd, "column")
beh_corr_result_pearson_task_asd$row <- extract_heatmap_data_task(beh_corr_result_pearson_task_asd, "row")

beh_corr_result_pearson_task_jove$column <- extract_heatmap_data_task(beh_corr_result_pearson_task_jove, "column")
beh_corr_result_pearson_task_jove$row <- extract_heatmap_data_task(beh_corr_result_pearson_task_jove, "row")
beh_asdAccSlopeCorrTask$column <- extract_heatmap_data_task(beh_asdAccSlopeCorrTask, "column")
beh_asdAccSlopeCorrTask$row <- extract_heatmap_data_task(beh_asdAccSlopeCorrTask, "row")
beh_bothAccSlopeCorrTask$column <- extract_heatmap_data_task(beh_bothAccSlopeCorrTask, "column")
beh_bothAccSlopeCorrTask$row <- extract_heatmap_data_task(beh_bothAccSlopeCorrTask, "row")
beh_adultAccSlopeCorrTask$column <- extract_heatmap_data_task(beh_adultAccSlopeCorrTask, "column")
beh_adultAccSlopeCorrTask$row <- extract_heatmap_data_task(beh_adultAccSlopeCorrTask, "row")


reorder_heatmap_func <-
function(df, column) {
factor(
  df[[column]],
  levels =
    c("Age",
      "KBIT Standardized Score",
      "SCQ Total",
      "Sentence Recall Raw Score",
      "Sentence Recall Standardized Score",
      "GJT Standardized Score",
      "GJT Raw Score",
      "Image Accuracy",
      "Image Entropy",
      "Image Mean RT",
      "Image RT Slope",
       "Letter Accuracy",
      "Letter Entropy",
      "Letter Mean RT",
      "Letter RT Slope",
      "Tone Accuracy",
      "Tone Entropy",
      "Tone Mean RT",
      "Tone RT Slope",
      "Syllable Accuracy",
      "Syllable Entropy",
      "Syllable Mean RT",
      "Syllable RT Slope"
     )
)}

beh_corr_result_pearson$column <- reorder_heatmap_func(beh_corr_result_pearson, "column")
beh_corr_result_pearson$row <- reorder_heatmap_func(beh_corr_result_pearson, "row")
beh_corr_result_pearson_td$column <- reorder_heatmap_func(beh_corr_result_pearson_td, "column")
beh_corr_result_pearson_td$row <- reorder_heatmap_func(beh_corr_result_pearson_td, "row")
beh_corr_result_pearson_asd$column <- reorder_heatmap_func(beh_corr_result_pearson_asd, "column")
beh_corr_result_pearson_asd$row <- reorder_heatmap_func(beh_corr_result_pearson_asd, "row")

beh_corr_result_pearson_jove$column <- reorder_heatmap_func(beh_corr_result_pearson_jove, "column")
beh_corr_result_pearson_jove$row <- reorder_heatmap_func(beh_corr_result_pearson_jove, "row")
beh_asdAccSlopeCorr$column <- reorder_heatmap_func(beh_asdAccSlopeCorr, "column")
beh_asdAccSlopeCorr$row <- reorder_heatmap_func(beh_asdAccSlopeCorr, "row")
beh_bothAccSlopeCorr$column <- reorder_heatmap_func(beh_bothAccSlopeCorr, "column")
beh_bothAccSlopeCorr$row <- reorder_heatmap_func(beh_bothAccSlopeCorr, "row")
beh_adultAccSlopeCorr$column <- reorder_heatmap_func(beh_adultAccSlopeCorr, "column")
beh_adultAccSlopeCorr$row <- reorder_heatmap_func(beh_adultAccSlopeCorr, "row")

reorder_heatmap_task_func <- 
function(df, column){
factor(
  df[[column]],
  levels =
    c("Age",
      "KBIT Standardized Score",
      "SCQ Total",
      "Sentence Recall Raw Score",
      "Sentence Recall Standardized Score",
      "GJT Standardized Score",
      "GJT Raw Score",
      "Image Accuracy",
      "Letter Accuracy",
      "Tone Accuracy",
      "Syllable Accuracy",
       "Image Entropy",
       "Letter Entropy",
         "Tone Entropy",
      "Syllable Entropy",
      "Image Mean RT",
      "Letter Mean RT",
      "Tone Mean RT",
      "Syllable Mean RT",
       "Image RT Slope",
      "Letter RT Slope",
      "Tone RT Slope",
      "Syllable RT Slope"
    )
)}

beh_corr_result_pearson_task$column <- reorder_heatmap_task_func(beh_corr_result_pearson_task, "column")
beh_corr_result_pearson_task$row <- reorder_heatmap_task_func(beh_corr_result_pearson_task, "row")
beh_corr_result_pearson_task_td$column <- reorder_heatmap_task_func(beh_corr_result_pearson_task_td, "column")
beh_corr_result_pearson_task_td$row<-  reorder_heatmap_task_func(beh_corr_result_pearson_task_td, "row")
beh_corr_result_pearson_task_asd$column <- reorder_heatmap_task_func(beh_corr_result_pearson_task_asd, "column")
beh_corr_result_pearson_task_asd$row <- reorder_heatmap_task_func(beh_corr_result_pearson_task_asd, "row")

beh_corr_result_pearson_task_jove$column <- reorder_heatmap_task_func(beh_corr_result_pearson_task_jove, "column")
beh_corr_result_pearson_task_jove$row <- reorder_heatmap_task_func(beh_corr_result_pearson_task_jove, "row")
beh_asdAccSlopeCorrTask$column <- reorder_heatmap_task_func(beh_asdAccSlopeCorrTask, "column")
beh_asdAccSlopeCorrTask$row <- reorder_heatmap_task_func(beh_asdAccSlopeCorrTask, "row")
beh_bothAccSlopeCorrTask$column <- reorder_heatmap_task_func(beh_bothAccSlopeCorrTask, "column")
beh_bothAccSlopeCorrTask$row <- reorder_heatmap_task_func(beh_bothAccSlopeCorrTask, "row")
beh_adultAccSlopeCorrTask$column <- reorder_heatmap_task_func(beh_adultAccSlopeCorrTask, "column")
beh_adultAccSlopeCorrTask$row <- reorder_heatmap_task_func(beh_adultAccSlopeCorrTask, "row")

round_func <-
function(input_df) {
  input_df[order(input_df$row,
                 input_df$column), ]
}

heat_map_corr_data <- round_func(beh_corr_result_pearson)
heat_map_corr_data$cor <- round(heat_map_corr_data$cor, 2)
heat_map_corr_data$p <- round(heat_map_corr_data$p, 2)

heat_map_corr_data_td <- round_func(beh_corr_result_pearson_td)
heat_map_corr_data_td$cor <- round(heat_map_corr_data_td$cor, 2)
heat_map_corr_data_td$p <- round(heat_map_corr_data_td$p, 2)

heat_map_corr_data_asd <- round_func(beh_corr_result_pearson_asd)
heat_map_corr_data_asd$cor <- round(heat_map_corr_data_asd$cor, 2)
heat_map_corr_data_asd$p <- round(heat_map_corr_data_asd$p, 2)

heat_map_corr_data_jove <- round_func(beh_corr_result_pearson_jove)
heat_map_corr_data_jove$cor <- round(heat_map_corr_data_jove$cor, 2)
heat_map_corr_data_jove$p <- round(heat_map_corr_data_jove$p, 2)


heat_map_asdAccSlopeCorr <- round_func(beh_asdAccSlopeCorr)
heat_map_asdAccSlopeCorr$cor <- round(heat_map_asdAccSlopeCorr$cor, 2)
heat_map_asdAccSlopeCorr$p <- round(heat_map_asdAccSlopeCorr$p, 2)


heat_map_bothAccSlopeCorr <- round_func(beh_bothAccSlopeCorr)
heat_map_bothAccSlopeCorr$cor <- round(heat_map_bothAccSlopeCorr$cor, 2)
heat_map_bothAccSlopeCorr$p <- round(heat_map_bothAccSlopeCorr$p, 2)

heat_map_adultAccSlopeCorr <- round_func(beh_adultAccSlopeCorr)
heat_map_adultAccSlopeCorr$cor <- round(heat_map_adultAccSlopeCorr$cor, 2)
heat_map_adultAccSlopeCorr$p <- round(heat_map_adultAccSlopeCorr$p, 2)

```

```{r, include = F}
heat_map_corr_data_task <- round_func(beh_corr_result_pearson_task)
heat_map_corr_data_task$cor <- round(heat_map_corr_data_task$cor, 2)
heat_map_corr_data_task$p <- round(heat_map_corr_data_task$p, 2)

heat_map_corr_data_task_td <- round_func(beh_corr_result_pearson_task_td)
heat_map_corr_data_task_td$cor <- round(heat_map_corr_data_task_td$cor, 2)
heat_map_corr_data_task_td$p <- round(heat_map_corr_data_task_td$p, 2)

heat_map_corr_data_task_asd <- round_func(beh_corr_result_pearson_task_asd)
heat_map_corr_data_task_asd$cor <- round(heat_map_corr_data_task_asd$cor, 2)
heat_map_corr_data_task_asd$p <- round(heat_map_corr_data_task_asd$p, 2)

heat_map_corr_data_task_jove <- round_func(beh_corr_result_pearson_task_jove)
heat_map_corr_data_task_jove$cor <- round(heat_map_corr_data_task_jove$cor, 2)
heat_map_corr_data_task_jove$p <- round(heat_map_corr_data_task_jove$p, 2)

heat_map_asdAccSlopeCorrTask <- round_func(beh_asdAccSlopeCorrTask)
heat_map_asdAccSlopeCorrTask$cor <- round(heat_map_asdAccSlopeCorrTask$cor, 2)
heat_map_asdAccSlopeCorrTask$p <- round(heat_map_asdAccSlopeCorrTask$p, 2)

heat_map_bothAccSlopeCorrTask <- round_func(beh_bothAccSlopeCorrTask)
heat_map_bothAccSlopeCorrTask$cor <- round(heat_map_bothAccSlopeCorrTask$cor, 2)
heat_map_bothAccSlopeCorrTask$p <- round(heat_map_bothAccSlopeCorrTask$p, 2)

heat_map_adultAccSlopeCorrTask <- round_func(beh_adultAccSlopeCorrTask)
heat_map_adultAccSlopeCorrTask$cor <- round(beh_adultAccSlopeCorrTask$cor, 2)
heat_map_adultAccSlopeCorrTask$p <- round(beh_adultAccSlopeCorrTask$p, 2)
```


# Heat Map for R, P, N for behavioral correlations (TD + ASD)
# Within Task, Across Measures
```{r, include=F}

#GGplot the heat map----------------------------------------------------------------------------------------------

ggplot(data = heat_map_corr_data, aes(x = column, y = row, fill = cor)) +
  geom_tile(color = "white") +
  scale_fill_gradient2(
    low = "blue",
    high = "red",
    mid = "white",
    midpoint = 0,
    limit = c(-1, 1),
    space = "Lab",
    name = "pearson\nCorrelation r"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(
    angle = 90,
    vjust = 1,
    size = 10,
    hjust = 1
  )) +
  theme(axis.title.x = element_blank(),
        axis.text.y = element_text (size = 10),
        axis.title.y = element_blank()) +
  coord_fixed() +
  geom_text(aes(label = cor), color = "black", size = 2)


# ggsave("corr_all_within_task.png",
       # dpi = 150)

ggplot(data = heat_map_corr_data, aes(x = column, y = row, fill = p)) +
  geom_tile(color = "white") +
  scale_fill_gradient2(
    low = "blue",
    high = "red",
    mid = "white",
    midpoint = 0,
    limit = c(0, 1),
    space = "Lab",
    name = "p-value"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(
    angle = 90,
    vjust = 1,
    size = 10,
    hjust = 1
  )) +
  theme(axis.title.x = element_blank(),
        axis.text.y = element_text (size = 10),
        axis.title.y = element_blank()) +
  coord_fixed() +
  geom_text(aes(label = p), color = "black", size = 2)

# ggsave("corr_p_all_within_task.png",
       # dpi = 150)

ggplot(data = heat_map_corr_data, aes(x = column, y = row, fill = n)) +
  geom_tile(color = "white") +
  scale_fill_gradient2(
    low = "blue",
    high = "red",
    mid = "white",
    midpoint = 0,
    limit = c(0, 33),
    space = "Lab",
    name = "n"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(
    angle = 90,
    vjust = 1,
    size = 10,
    hjust = 1
  )) +
  theme(axis.title.x = element_blank(),
        axis.text.y = element_text (size = 10),
        axis.title.y = element_blank()) +
  coord_fixed() +
  geom_text(aes(label = n), color = "black", size = 3.5)

# ggsave("corr_n_all_within_task.png",
       # dpi = 150)
```


# Across Behavioral Tasks, Within Measure (TD + ASD)
```{r, include = F}

ggplot(data = heat_map_corr_data_task, aes(x = column, y = row, fill = cor)) +
  geom_tile(color = "white") +
  scale_fill_gradient2(
    low = "blue",
    high = "red",
    mid = "white",
    midpoint = 0,
    limit = c(-1, 1),
    space = "Lab",
    name = "pearson\nCorrelation r"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(
    angle = 90,
    vjust = 1,
    size = 10,
    hjust = 1
  )) +
  theme(axis.title.x = element_blank(),
        axis.text.y = element_text (size = 10),
        axis.title.y = element_blank()) +
  coord_fixed() +
  geom_text(aes(label = cor), color = "black", size = 2)

# ggsave("corr_all_within_measure.png",
       # dpi = 150)

ggplot(data = heat_map_corr_data_task, aes(x = column, y = row, fill = p)) +
  geom_tile(color = "white") +
  scale_fill_gradient2(
    low = "blue",
    high = "red",
    mid = "white",
    midpoint = 0,
    limit = c(0, 1),
    space = "Lab",
    name = "p-value"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(
    angle = 90,
    vjust = 1,
    size = 10,
    hjust = 1
  )) +
  theme(axis.title.x = element_blank(),
        axis.text.y = element_text (size = 10),
        axis.title.y = element_blank()) +
  coord_fixed() +
  geom_text(aes(label = p), color = "black", size = 2)

# ggsave("corr_p_all_within_measure.png",
       # dpi = 150)

```
# Across Behavioral Tasks, Within Measure (TD or ASD Only)
```{r}
library("ggplot2")

plot_heatmap_r_func <-
function(df) {
ggplot(data = df, aes(x = column, y = row, fill = cor)) +
  geom_tile(color = "white") +
  scale_fill_gradient2(
    low = "blue",
    high = "red",
    mid = "white",
    midpoint = 0,
    limit = c(-1, 1),
    space = "Lab",
    name = "pearson\nCorrelation r"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(
    angle = 90,
    vjust = 1,
    size = 10,
    hjust = 1
  )) +
  theme(axis.title.x = element_blank(),
        axis.text.y = element_text (size = 10),
        axis.title.y = element_blank()) +
  coord_fixed() +
  geom_text(aes(label = cor), color = "black", size = 2)
}

plot_heatmap_p_func <-
function(df) {
ggplot(data = heat_map_corr_data_task, aes(x = column, y = row, fill = p)) +
  geom_tile(color = "white") +
  scale_fill_gradient2(
    low = "blue",
    high = "red",
    mid = "white",
    midpoint = 0,
    limit = c(0, 1),
    space = "Lab",
    name = "p-value"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(
    angle = 90,
    vjust = 1,
    size = 10,
    hjust = 1
  )) +
  theme(axis.title.x = element_blank(),
        axis.text.y = element_text (size = 10),
        axis.title.y = element_blank()) +
  coord_fixed() +
  geom_text(aes(label = p), color = "black", size = 2)
}

# plot_heatmap_r_func(heat_map_corr_data_task_td)
# # ggsave(
#   "corr_within_measure_td.png", 
#   dpi = 150
# )
# 
# plot_heatmap_r_func(heat_map_corr_data_td)
# # ggsave(
#   "corr_within_task_td.png", 
#   dpi = 150)
# 
# plot_heatmap_r_func(heat_map_corr_data_asd)
# # ggsave(
#   "corr_within_task_asd.png", 
#   dpi = 150)
# 
# plot_heatmap_r_func(heat_map_corr_data_task_asd)
# # ggsave(
#   "corr_within_measure_asd.png", 
#   dpi = 150
# )
# 
# plot_heatmap_r_func(heat_map_corr_data_task_asd)
# # ggsave(
#   "corr_within_measure_asd.png", 
#   dpi = 150)
# 
# plot_heatmap_p_func(heat_map_corr_data_task_td)
# # ggsave(
#   "corr_p_within_measure_td.png", 
#   dpi = 150
# )
# 
# plot_heatmap_p_func(heat_map_corr_data_task_asd)
# # ggsave(
#   "corr_p_within_measure_asd.png", 
#   dpi = 150
# )
# 
# plot_heatmap_p_func(heat_map_corr_data_td)
# # ggsave(
#   "corr_p_within_task_td.png", 
#   dpi = 150
# )
# 
# plot_heatmap_p_func(heat_map_corr_data_asd)
# # ggsave(
#   "corr_p_within_task_asd.png", 
#   dpi = 150
# )
```

```{r}
library("ggplot2")

legend_name <- expression(paste("Pearson's ", italic("r")))

heat_map_corr_data_task_jove[which(heat_map_corr_data_task_jove$p < 0.06), "size"] <- 1
heat_map_corr_data_task_jove[-which(heat_map_corr_data_task_jove$p < 0.06), "size"] <- 0

heat_map_corr_data_task_jove[which(heat_map_corr_data_task_jove$column == "Image RT Slope" & heat_map_corr_data_task_jove$row == "Syllable Accuracy"), "size"] <- 0


ggplot(data = heat_map_corr_data_task_jove, aes(x = column, y = row, fill = cor)) +
  geom_tile(color = "white") +
  scale_fill_gradient2(
    low = "blue",
    high = "red",
    mid = "white",
    midpoint = 0,
    limit = c(-1, 1),
    space = "Lab",
    name = legend_name
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(
    angle = 90,
    vjust = 1,
    size = 10,
    hjust = 1
  )) +
  theme(axis.title.x = element_blank(),
        axis.text.x = element_text (size = 14, face="bold"),
        axis.text.y = element_text (size = 14, face="bold"),
        axis.title.y = element_blank()) +
  coord_fixed() +
  geom_text(aes(label = cor, size = size), color = "black") +
  scale_size(range = c(2.5, 4.7), guide = F) +
  theme(legend.text = element_text(size=12), legend.title = element_text(size=14))

# # ggsave(
# #   "paper_analysis_matched/corrR_TD.png",
#   dpi = 150)


ggplot(data = heat_map_corr_data_task_jove, aes(x = column, y = row, fill = n)) +
  geom_tile(color = "white") +
  scale_fill_gradient2(
    low = "blue",
    high = "red",
    mid = "white",
    midpoint = 0,
    limit = c(-1, 1),
    space = "Lab",
    name = legend_name
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(
    angle = 90,
    vjust = 1,
    size = 10,
    hjust = 1
  )) +
  theme(axis.title.x = element_blank(),
        axis.text.x = element_text (size = 14, face="bold"),
        axis.text.y = element_text (size = 14, face="bold"),
        axis.title.y = element_blank()) +
  coord_fixed() +
  geom_text(aes(label = n, size = size), color = "black") +
  scale_size(range = c(2.5, 4.7), guide = F) +
  theme(legend.text = element_text(size=12), legend.title = element_text(size=14))

# ggsave(
#   "paper_analysis_matched/corrN_TD.png",
#   dpi = 150)



ggplot(data = heat_map_corr_data_task_jove, aes(x = column, y = row, fill = p)) +
  geom_tile(color = "white") +
  scale_fill_gradient2(
    low = "blue",
    high = "red",
    mid = "white",
    midpoint = 0,
    limit = c(-1, 1),
    space = "Lab",
    name = legend_name
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(
    angle = 90,
    vjust = 1,
    size = 10,
    hjust = 1
  )) +
  theme(axis.title.x = element_blank(),
        axis.text.x = element_text (size = 14, face="bold"),
        axis.text.y = element_text (size = 14, face="bold"),
        axis.title.y = element_blank()) +
  coord_fixed() +
  geom_text(aes(label = p, size = size), color = "black") +
  scale_size(range = c(2.5, 4.7), guide = F) +
  theme(legend.text = element_text(size=12), legend.title = element_text(size=14))

# ggsave(
#   "paper_analysis_matched/corrP_TD.png",
#   dpi = 150)
```

```{r}

heat_map_asdAccSlopeCorrTask[which(heat_map_asdAccSlopeCorrTask$p < 0.06), "size"] <- 1
heat_map_asdAccSlopeCorrTask[-which(heat_map_asdAccSlopeCorrTask$p < 0.06), "size"] <- 0

heat_map_asdAccSlopeCorrTask[which(heat_map_asdAccSlopeCorrTask$column == "Image RT Slope" & heat_map_asdAccSlopeCorrTask$row == "Tone Accuracy"), "size"] <- 0


ggplot(data = heat_map_asdAccSlopeCorrTask, aes(x = column, y = row, fill = cor)) +
  geom_tile(color = "white") +
  scale_fill_gradient2(
    low = "blue",
    high = "red",
    mid = "white",
    midpoint = 0,
    limit = c(-1, 1),
    space = "Lab",
    name = legend_name
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(
    angle = 90,
    vjust = 1,
    size = 10,
    hjust = 1
  )) +
  theme(axis.title.x = element_blank(),
        axis.text.x = element_text (size = 14, face="bold"),
        axis.text.y = element_text (size = 14, face="bold"),
        axis.title.y = element_blank()) +
  coord_fixed() +
  geom_text(aes(label = cor, size = size), color = "black") +
  scale_size(range = c(2.5, 4.7), guide = F) +
  theme(legend.text = element_text(size=12), legend.title = element_text(size=14))


# ggsave(
#   "paper_analysis_matched/corrR_ASD.png",
#   dpi = 150)


ggplot(data = heat_map_asdAccSlopeCorrTask, aes(x = column, y = row, fill = n)) +
  geom_tile(color = "white") +
  scale_fill_gradient2(
    low = "blue",
    high = "red",
    mid = "white",
    midpoint = 0,
    limit = c(-1, 1),
    space = "Lab",
    name = legend_name
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(
    angle = 90,
    vjust = 1,
    size = 10,
    hjust = 1
  )) +
  theme(axis.title.x = element_blank(),
        axis.text.x = element_text (size = 14, face="bold"),
        axis.text.y = element_text (size = 14, face="bold"),
        axis.title.y = element_blank()) +
  coord_fixed() +
  geom_text(aes(label = n, size = size), color = "black") +
  scale_size(range = c(2.5, 4.7), guide = F) +
  theme(legend.text = element_text(size=12), legend.title = element_text(size=14))


# ggsave(
#   "paper_analysis_matched/corrN_ASD.png",
#   dpi = 150)

ggplot(data = heat_map_asdAccSlopeCorrTask, aes(x = column, y = row, fill = p)) +
  geom_tile(color = "white") +
  scale_fill_gradient2(
    low = "blue",
    high = "red",
    mid = "white",
    midpoint = 0,
    limit = c(-1, 1),
    space = "Lab",
    name = legend_name
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(
    angle = 90,
    vjust = 1,
    size = 10,
    hjust = 1
  )) +
  theme(axis.title.x = element_blank(),
        axis.text.x = element_text (size = 14, face="bold"),
        axis.text.y = element_text (size = 14, face="bold"),
        axis.title.y = element_blank()) +
  coord_fixed() +
  geom_text(aes(label = p, size = size), color = "black") +
  scale_size(range = c(2.5, 4.7), guide = F) +
  theme(legend.text = element_text(size=12), legend.title = element_text(size=14))


# ggsave(
#   "paper_analysis_matched/corrP_ASD.png",
#   dpi = 150)

```

```{r}

heat_map_adultAccSlopeCorrTask[which(heat_map_adultAccSlopeCorrTask$p < 0.06), "size"] <- 1
heat_map_adultAccSlopeCorrTask[-which(heat_map_adultAccSlopeCorrTask$p < 0.06), "size"] <- 0

# heat_map_adultAccSlopeCorrTask[which(heat_map_adultAccSlopeCorrTask$column == "Image RT Slope" & heat_map_adultAccSlopeCorrTask$row == "Tone Accuracy"), "size"] <- 0


ggplot(data = heat_map_adultAccSlopeCorrTask, aes(x = column, y = row, fill = cor)) +
  geom_tile(color = "white") +
  scale_fill_gradient2(
    low = "blue",
    high = "red",
    mid = "white",
    midpoint = 0,
    limit = c(-1, 1),
    space = "Lab",
    name = legend_name
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(
    angle = 90,
    vjust = 1,
    size = 10,
    hjust = 1
  )) +
  theme(axis.title.x = element_blank(),
        axis.text.x = element_text (size = 14, face="bold"),
        axis.text.y = element_text (size = 14, face="bold"),
        axis.title.y = element_blank()) +
  coord_fixed() +
  geom_text(aes(label = cor, size = size), color = "black") +
  scale_size(range = c(2.5, 4.7), guide = F) +
  theme(legend.text = element_text(size=12), legend.title = element_text(size=14))


# ggsave(
#   "paper_analysis_matched/corrR_Adult.png",
#   dpi = 150)


ggplot(data = heat_map_adultAccSlopeCorrTask, aes(x = column, y = row, fill = n)) +
  geom_tile(color = "white") +
  scale_fill_gradient2(
    low = "blue",
    high = "red",
    mid = "white",
    midpoint = 0,
    limit = c(-1, 1),
    space = "Lab",
    name = legend_name
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(
    angle = 90,
    vjust = 1,
    size = 10,
    hjust = 1
  )) +
  theme(axis.title.x = element_blank(),
        axis.text.x = element_text (size = 14, face="bold"),
        axis.text.y = element_text (size = 14, face="bold"),
        axis.title.y = element_blank()) +
  coord_fixed() +
  geom_text(aes(label = n, size = size), color = "black") +
  scale_size(range = c(2.5, 4.7), guide = F) +
  theme(legend.text = element_text(size=12), legend.title = element_text(size=14))


# ggsave(
#   "paper_analysis_matched/corrN_Adult.png",
#   dpi = 150)


ggplot(data = heat_map_adultAccSlopeCorrTask, aes(x = column, y = row, fill = p)) +
  geom_tile(color = "white") +
  scale_fill_gradient2(
    low = "blue",
    high = "red",
    mid = "white",
    midpoint = 0,
    limit = c(-1, 1),
    space = "Lab",
    name = legend_name
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(
    angle = 90,
    vjust = 1,
    size = 10,
    hjust = 1
  )) +
  theme(axis.title.x = element_blank(),
        axis.text.x = element_text (size = 14, face="bold"),
        axis.text.y = element_text (size = 14, face="bold"),
        axis.title.y = element_blank()) +
  coord_fixed() +
  geom_text(aes(label = p, size = size), color = "black") +
  scale_size(range = c(2.5, 4.7), guide = F) +
  theme(legend.text = element_text(size=12), legend.title = element_text(size=14))


# ggsave(
#   "paper_analysis_matched/corrP_Adult.png",
#   dpi = 150)

```

```{r}
heat_map_bothAccSlopeCorrTask[which(heat_map_bothAccSlopeCorrTask$p < 0.06), "size"] <- 1
heat_map_bothAccSlopeCorrTask[-which(heat_map_bothAccSlopeCorrTask$p < 0.06), "size"] <- 0

heat_map_bothAccSlopeCorrTask[which(heat_map_bothAccSlopeCorrTask$column == "Letter RT Slope" & heat_map_bothAccSlopeCorrTask$row == "Syllable Accuracy"), "size"] <- 0
heat_map_bothAccSlopeCorrTask[which(heat_map_bothAccSlopeCorrTask$column == "Letter RT Slope" & heat_map_bothAccSlopeCorrTask$row == "Image Accuracy"), "size"] <- 0


ggplot(data = heat_map_bothAccSlopeCorrTask, aes(x = column, y = row, fill = cor)) +
  geom_tile(color = "white") +
  scale_fill_gradient2(
    low = "blue",
    high = "red",
    mid = "white",
    midpoint = 0,
    limit = c(-1, 1),
    space = "Lab",
    name = legend_name
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(
    angle = 90,
    vjust = 1,
    size = 10,
    hjust = 1
  )) +
  theme(axis.title.x = element_blank(),
        axis.text.x = element_text (size = 14, face="bold"),
        axis.text.y = element_text (size = 14, face="bold"),
        axis.title.y = element_blank()) +
  coord_fixed() +
  geom_text(aes(label = cor, size = size), color = "black") +
  scale_size(range = c(2.5, 4.7), guide = F) +
  theme(legend.text = element_text(size=12), legend.title = element_text(size=14))

ggplot(data = heat_map_bothAccSlopeCorrTask, aes(x = column, y = row, fill = n)) +
  geom_tile(color = "white") +
  scale_fill_gradient2(
    low = "blue",
    high = "red",
    mid = "white",
    midpoint = 0,
    limit = c(-1, 1),
    space = "Lab",
    name = legend_name
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(
    angle = 90,
    vjust = 1,
    size = 10,
    hjust = 1
  )) +
  theme(axis.title.x = element_blank(),
        axis.text.x = element_text (size = 14, face="bold"),
        axis.text.y = element_text (size = 14, face="bold"),
        axis.title.y = element_blank()) +
  coord_fixed() +
  geom_text(aes(label = n, size = size), color = "black") +
  scale_size(range = c(2.5, 4.7), guide = F) +
  theme(legend.text = element_text(size=12), legend.title = element_text(size=14))


# ggsave(
  # "AccSlopeCorrAll_heatmap.png",
  # dpi = 150)

# # ggsave(
#   "corrR_ALLast.png", 
#   dpi = 150)
```




```{r}
library("ggplot2")

ggplot(data = heat_map_corr_data_task_jove, aes(x = column, y = row, fill = p)) +
  geom_tile(color = "white") +
  scale_fill_gradient2(
    low = "blue",
    high = "red",
    mid = "white",
    midpoint = 0,
    limit = c(-1, 1),
    space = "Lab",
    name = "Pearson\nCorrelation p"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(
    angle = 90,
    vjust = 1,
    size = 10,
    hjust = 1
  )) +
  theme(axis.title.x = element_blank(),
        axis.text.x = element_text (size = 14),
        axis.text.y = element_text (size = 14),
        axis.title.y = element_blank()) +
  coord_fixed() +
  geom_text(aes(label = p, size = p), color = "black") +
   scale_size(range = c(6, 2), guide = F)

# ggsave(
  # "corrP_within_measure_jove.png", 
  # dpi = 150)

ggplot(data = heat_map_asdAccSlopeCorrTask, aes(x = column, y = row, fill = p)) +
  geom_tile(color = "white") +
  scale_fill_gradient2(
    low = "blue",
    high = "red",
    mid = "white",
    midpoint = 0,
    limit = c(-1, 1),
    space = "Lab",
    name = "Pearson\nCorrelation p"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(
    angle = 90,
    vjust = 1,
    size = 10,
    hjust = 1
  )) +
  theme(axis.title.x = element_blank(),
        axis.text.x = element_text (size = 14),
        axis.text.y = element_text (size = 14),
        axis.title.y = element_blank()) +
  coord_fixed() +
  geom_text(aes(label = p, size = p), color = "black") +
   scale_size(range = c(6, 2), guide = F)

# ggsave(
  # "corrP_AccSlope_asd.png", 
  # dpi = 150)


ggplot(data = heat_map_bothAccSlopeCorrTask, aes(x = column, y = row, fill = p)) +
  geom_tile(color = "white") +
  scale_fill_gradient2(
    low = "blue",
    high = "red",
    mid = "white",
    midpoint = 0,
    limit = c(-1, 1),
    space = "Lab",
    name = "Pearson\nCorrelation p"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(
    angle = 90,
    vjust = 1,
    size = 10,
    hjust = 1
  )) +
  theme(axis.title.x = element_blank(),
        axis.text.x = element_text (size = 14),
        axis.text.y = element_text (size = 14),
        axis.title.y = element_blank()) +
  coord_fixed() +
  geom_text(aes(label = p, size = p), color = "black") +
   scale_size(range = c(6, 2), guide = F)

```


# PCA for SL



```{r, include = F}
# Double check if NA Omit works above

# normedAccSlope <- 
#   cbind(crossed_random_effect, 
#          bucld_all_completed[,c("rt_children_vsl_indiv_rts","rt_children_lsl_indiv_rts","rt_children_tsl_indiv_rts","rt_children_ssl_indiv_rts")])
  
testd <- bucld_all_completed[which(
  bucld_all_completed$accuracy_children_tsl_accuracies != "" &
    bucld_all_completed$accuracy_children_ssl_accuracies != "" &
    bucld_all_completed$accuracy_children_vsl_accuracies != "" &
    bucld_all_completed$accuracy_children_lsl_accuracies != "" &
    bucld_all_completed$slope_children_tsl_indiv_rts_slope != "" &
     bucld_all_completed$slope_children_ssl_indiv_rts_slope != "" &
     bucld_all_completed$slope_children_vsl_indiv_rts_slope != "" &
   bucld_all_completed$slope_children_lsl_indiv_rts_slope != ""
), ]


testd[, c(
  "accuracy_children_lsl_accuracies",
  "accuracy_children_ssl_accuracies",
  "accuracy_children_vsl_accuracies",
  "accuracy_children_tsl_accuracies",
   "slope_children_lsl_indiv_rts_slope",
                                              "slope_children_ssl_indiv_rts_slope",
                                              "slope_children_vsl_indiv_rts_slope",
                                              "slope_children_tsl_indiv_rts_slope"
)] <-
  lapply(testd[, c(
    "accuracy_children_lsl_accuracies",
    "accuracy_children_ssl_accuracies",
    "accuracy_children_vsl_accuracies",
    "accuracy_children_tsl_accuracies",
     "slope_children_lsl_indiv_rts_slope",
                                              "slope_children_ssl_indiv_rts_slope",
                                              "slope_children_vsl_indiv_rts_slope",
                                              "slope_children_tsl_indiv_rts_slope"
  )], function(x) {
    if (is.factor(x))
      as.numeric(as.character(x))
    else
      x
  })


# pcacomp <- prcomp(testd[, c(
#   "accuracy_children_lsl_accuracies",
#   "accuracy_children_ssl_accuracies",
#   "accuracy_children_vsl_accuracies",
#   "accuracy_children_tsl_accuracies"
# )], center = TRUE, scale. = TRUE)

```

```{r}
pcacomp <- prcomp(~ ., bucld_all_completed[, c(
  "accuracy_children_lsl_accuracies",
  "accuracy_children_ssl_accuracies",
  "accuracy_children_vsl_accuracies",
  "accuracy_children_tsl_accuracies",
   "slope_children_lsl_indiv_rts_slope",
                                              "slope_children_ssl_indiv_rts_slope",
                                              "slope_children_vsl_indiv_rts_slope",
                                              "slope_children_tsl_indiv_rts_slope"
)], center = TRUE,scale. = TRUE, na.action=na.omit)

summary(pcacomp)
```


# PCA with accuracy and slope

**TD + ASD**
```{r}

pca_test <- prcomp(~ ., bucld_all_completed[,c("accuracy_children_lsl_accuracies", 
                                              "accuracy_children_ssl_accuracies", 
                                              "accuracy_children_vsl_accuracies", 
                                              "accuracy_children_tsl_accuracies",
                                              "slope_children_lsl_indiv_rts_slope",
                                              "slope_children_ssl_indiv_rts_slope",
                                              "slope_children_vsl_indiv_rts_slope",
                                              "slope_children_tsl_indiv_rts_slope")], center = TRUE,scale. = TRUE, na.action=na.omit)

print(pca_test)

pcare <- summary(pca_test)

# Only works when there is no missing data in the dataframe.
library(ggbiplot)
ggbiplot(pca_test, labels=pcare$part_id, ellipse=TRUE,  groups=pcare$group)

```

**TD only**
```{r}

pca_testTD <- prcomp(~ ., bucld_all_completed[which(bucld_all_completed$group == "TD"),
                                            c("accuracy_children_lsl_accuracies", 
                                              "accuracy_children_ssl_accuracies", 
                                              "accuracy_children_vsl_accuracies", 
                                              "accuracy_children_tsl_accuracies",
                                              "slope_children_lsl_indiv_rts_slope",
                                              "slope_children_ssl_indiv_rts_slope",
                                              "slope_children_vsl_indiv_rts_slope",
                                              "slope_children_tsl_indiv_rts_slope")], center = TRUE,scale. = TRUE, na.action=na.omit)

print(pca_testTD)

pcareTD <- summary(pca_testTD)

# Only works when there is no missing data in the dataframe.
library(ggbiplot)
ggbiplot(pca_testTD, labels=pcareTD$part_id, ellipse=TRUE,  groups=pcareTD$group)

```

**ASD only**
```{r}

pca_testASD <- prcomp(~ ., bucld_all_completed[which(bucld_all_completed$group == "ASD"),
                                            c("accuracy_children_lsl_accuracies", 
                                              "accuracy_children_ssl_accuracies", 
                                              "accuracy_children_vsl_accuracies", 
                                              "accuracy_children_tsl_accuracies",
                                              "slope_children_lsl_indiv_rts_slope",
                                              "slope_children_ssl_indiv_rts_slope",
                                              "slope_children_vsl_indiv_rts_slope",
                                              "slope_children_tsl_indiv_rts_slope")], center = TRUE,scale. = TRUE, na.action=na.omit)

print(pca_testASD)

pcareASD <- summary(pca_testASD)

# Only works when there is no missing data in the dataframe.
library(ggbiplot)
ggbiplot(pca_testASD, labels=pcareTD$part_id, ellipse=TRUE,  groups=pcareTD$group)
```

# PCA with only accuracy
```{r}
pca_acc <- prcomp(~ ., bucld_all_completed[,c("accuracy_children_lsl_accuracies", 
                                              "accuracy_children_ssl_accuracies", 
                                              "accuracy_children_vsl_accuracies", 
                                              "accuracy_children_tsl_accuracies"
                                             )], center = TRUE,scale. = TRUE, na.action=na.omit)


summary(pca_acc)

pcaccPl <- summary(pca_acc)

# Only works when there is no missing data in the dataframe.
library(ggbiplot)
ggbiplot(pca_acc, labels=pcaccPl$part_id, ellipse=TRUE,  groups=pcaccPl$group)
```

# K-means of SL accuracy (TD + ASD, TD vs. ASD did not differ that much overall in optimal clusters)
```{r}
complete_acc <- 
  bucld_all_completed[,
                      c("part_id", 
                        "group",
                        "accuracy_children_lsl_accuracies", 
                         "accuracy_children_ssl_accuracies", 
                         "accuracy_children_vsl_accuracies", 
                         "accuracy_children_tsl_accuracies")]

completeRow <- complete.cases(complete_acc)

completeSL <- complete_acc[completeRow,]

# completeSL <- completeSL[which(completeSL$group == "TD"),]
# completeSL <- completeSL[which(completeSL$group == "ASD"),]
completeSL <- completeSL



# completeSL[,3:6] <- scale(completeSL[,3:6])

# determine the optimal number of clusters
## Elbow method for k-means clustering - optimal number of cluster is ?
set.seed(123)
### Compute and plot wss for k = 2 to k = 8
k.max <- 8 # Maximal number of clusters
data <- completeSL[,3:6]
wss <- sapply(1:k.max, 
              function(k){kmeans(data, k, nstart=10)$tot.withinss})

plot(1:k.max, wss,
     type="b", pch = 19, frame = FALSE, 
     xlab="Number of clusters K",
     ylab="Total within-clusters sum of squares") 

### alternatively,
library(factoextra)
fviz_nbclust(completeSL[,3:6], kmeans, method = "wss") 
```

# K-means with 5 clusters based on Elbow method
```{r}
set.seed(123)
kcluster <- kmeans(completeSL[, 3:6], 5, nstart = 10)
str(kcluster)
print(kcluster)
# Plotting the Elbow method in clusters
```

Notes:
K = 5
Cluster 1 (n = 12): better Letter(mean = 0.6016667) and Syllable SL (mean = 0.65625)
Cluster 2 (n = 6): Good? SL learning across tasks or poor Speech SL learner 
                    (Letter: 0.7758333, Syllable: 0.6146667, Image: 0.8906667, Tone SL: 0.7865)
Cluster 3 (n = 16): Poor SL learner
                    (Letter: 0.498, Syllable: 0.496125, Image: 0.5351875, Tone SL: 0.5116875)
Cluster 4 (n = 7): better Image (mean = 0.5981429) and Tone SL (mean = 0.683) 
Cluster 5 (n = 6): very good Image (mean =  0.9115) and Letter SL (mean = 0.8648333)

**The order of the clusters may be different when the script is run. However, the cluster sizes are replicable.**



# Plot K-means 5 clusters
```{r, include = F}
clusterP <- completeSL
clusterP$cluster <- kcluster$cluster
clusterP$cluster <- as.factor(clusterP$cluster)

colorTemp <- c("#999999", "#E69F00", "#56B4E9", "#009E73", 
               "#CC79A7")

library(plotly)
f1 <- list(
  size = 18,
  color = "black")

f2 <- list(
  size = 12,
  color = "black")

p <-
  plot_ly(clusterP, 
             x = ~accuracy_children_lsl_accuracies, 
             y = ~accuracy_children_vsl_accuracies, 
             z = ~accuracy_children_tsl_accuracies, 
             mode = "markers", 
             color = ~cluster, 
             size = ~accuracy_children_ssl_accuracies, 
             marker = list(symbol = 'circle', sizemode = 'diameter'),
  colors = colorTemp,
  sizes = c(5, 70)) %>%
  layout(scene = list(xaxis = list(title = "<b>Letter</b>",
                                    titlefont = f1,
                                   tickfont = f2,
                                   tickangle = 360,
                                   autorange = "reversed"),
                      yaxis = list(title = "<b>Image</b>",
                                   titlefont = f1,
                                   tickfont = f2,
                                   autorange = "reversed",
                                   tickangle = 360),
                      zaxis = list(title = "<b>Tone</b>",
                                   titlefont = f1,
                                   tickfont = f2,
                                   tickangle = 360))) 
```


```{r}
legend.sizes = seq(80, 160, 20)
ax = list(zeroline = FALSE, showline = FALSE, showticklabels = FALSE, showgrid = FALSE)
mk = list(sizeref=0.1, sizemode="area", opacity=1, color = "black", line = list(color = "rgb(0, 0, 0, 1)"))

p.legend = plot_ly() %>%
  add_markers(x = 1, y = legend.sizes, size = legend.sizes, showlegend = F, marker = mk) %>%
  layout(xaxis = ax, yaxis = list(showgrid = FALSE, showticklabels = FALSE))



# p.legend <- p.legend %>% add_text(textfont =  list(family = "times",sizeref = 2,color = toRGB("black")), 
p.legend <-
p.legend %>% add_annotations(
  x = 1,
  y = 185,
  xref = "x",
  yref = "y",
  text = "<b>Speech</b>",
  showarrow = FALSE,
  font = list(color = toRGB("black"),
              # family = "Times",
              
              size = 14)
) %>% add_annotations(
  x = 1,
  y = 175,
  xref = "x",
  yref = "y",
  text = max(clusterP$accuracy_children_ssl_accuracies),
  showarrow = FALSE,
  font = list(color = toRGB("black"),
              # family = "Times",
              size = 14)
) %>% add_annotations(
  x = 1,
  y = 70,
  xref = "x",
  yref = "y",
  text = min(clusterP$accuracy_children_ssl_accuracies),
  showarrow = FALSE,
  font = list(color = toRGB("black"),
              # family = "Times",
              size = 14)
)


# subplot(p, p.legend, widths = c(0.9, 0.1), heights = 0.6, shareY = F)
```


Cluster means:
  accuracy_children_lsl_accuracies accuracy_children_ssl_accuracies accuracy_children_vsl_accuracies
1                        0.6016667                        0.6562500                        0.4453333
2                        0.7758333                        0.6146667                        0.8906667
3                        0.4980000                        0.4961250                        0.5351875
4                        0.3928571                        0.4865714                        0.5981429
5                        0.8648333                        0.5210000                        0.9115000
  accuracy_children_tsl_accuracies
1                        0.5104167
2                        0.7865000
3                        0.5116875
4                        0.6830000
5                        0.5208333

# Plot K-means and GJT raw or standard scores
```{r}
clusterGJT <- 
  merge(clusterP[,c("part_id", "group", "cluster")], 
      bucld_all_completed[c("part_id", "a_prime", "gjt_std_score_gjt_web")], all.x = T)

clusterGJT$cluster <- as.factor(clusterGJT$cluster)

## Reordered the clusters to replicate the bar graph submitted to the SRCD 2020 abstract
clusterGJT$cluster <- 
  factor(clusterGJT$cluster,levels = c(4, 5, 1, 3, 2))

library(dplyr)



aprimeK_five <-
ggplot(data=clusterGJT, aes(x=cluster, y= a_prime,fill=cluster)) +
  geom_bar(stat= "summary", fun.y = "mean", color ="black")+
  coord_cartesian(ylim = c(0.5, 1.0))  +
  theme_minimal(base_size = 20) + 
  scale_fill_manual(values= colorTemp) +
   labs(
         y = "Grammaticality Judgment (A')"  # Change axis label
        ) 


# gjtK_five <-
ggplot(data=clusterGJT, aes(x=cluster, y= gjt_std_score_gjt_web,fill=cluster)) +
  geom_bar(stat= "summary", fun.y = "mean", color ="black")+
  coord_cartesian(ylim = c(0, 120))  +
  guides(fill=guide_legend(title="Cluster based on \n SL accuracy")) +
  scale_fill_manual(values= colorTemp, 
                    labels = c("Low Accuracy in Lingusitic SL", 
                                 "High Accuracy in Visual SL", 
                                 "High Accuracy in  Syllable SL", 
                                 "Low Accuracy in all SL", 
                                 "High Accuracy in all SL")) +
  # scale_fill_discrete(name = "Cluster") +
   labs(
         y = "Grammaticality Judgment Standard Score",  # Change axis label
         x = "Cluster"
        ) + 
  theme(
        axis.title.x = element_text(size=14, face="bold"),
        axis.title.y = element_text(size=14, face="bold"),
        axis.text=element_text(size=12, face = "bold")
        ) +
  theme(legend.text=element_text(size=14, face="bold"),
        legend.title=element_text(size=15, face="bold")) +
  theme(legend.text=element_text(size=14, face="bold"),
        legend.title=element_text(size=15, face="bold")) +
  theme(
    panel.background = element_rect(fill = "white"),         # Set plot background to white
    legend.key  = element_rect(fill = "white"),              # Set legend item backgrounds to white
    axis.line.x = element_line(colour = "black", size = 1),  # Add line to x axis
    axis.line.y = element_line(colour = "black", size = 1),   # Add line to y axis
    panel.grid.minor = element_line(colour = "grey", size = 0.3),
    panel.grid.major = element_line(colour = "grey", size = 0.3)
  ) 

# ggsave("srcd_figure/k_means_five_clusters_gjt.png",
       # bg="transparent",
       # width = 20, height = 15, units = "cm")
```

# Plot K-means and GJT raw or standard scores by TD and ASD groups
```{r}
library(dplyr)
library("ggpattern")

clusterGJTMean <- 
clusterGJT %>%
  filter(!is.na(gjt_std_score_gjt_web)) %>%
  group_by(cluster, group) %>%
  dplyr::summarise(n = n(), mean_gjtStd = mean(gjt_std_score_gjt_web))

clusterGJTMean <- data.frame(clusterGJTMean)
colnames(clusterGJTMean)[which(colnames(clusterGJTMean) %in% "group")] <- "Group"

clusterGJTMean$cluster <- as.factor(clusterGJTMean$cluster)

clusterGJTMean$cluster <- 
  factor(clusterGJTMean$cluster,levels = c(4, 5, 1, 3, 2))

clusterGJTMean$cluster <-
plyr::revalue(clusterGJTMean$cluster, c("4" = "1",
                                    "5" = "2",
                                    "1" = "3", 
                                    "3" = "4",
                                    "2" = "5"))



ggplot(data=clusterGJTMean, aes(x=cluster, y= mean_gjtStd, fill = cluster, color = Group)) +
   geom_bar(stat= "identity", position = "identity", alpha = 0.5, size = 1) +
  # coord_cartesian(ylim = c(0, 120))  +
  scale_fill_manual(values= colorTemp,
                    labels = c("Low Accuracy in Lingusitic SL",
                                 "High Accuracy in Visual SL",
                                 "High Accuracy in  Syllable SL",
                                 "Low Accuracy in all SL",
                                 "High Accuracy in all SL"),
                    guide = guide_legend(title="Cluster based on \n SL accuracy",
                                        override.aes = list(pattern = NA)
                                        )) +
  scale_color_manual(values= c("black", "grey")) +
  # geom_col_pattern(aes(x=cluster, y= mean_gjtStd,
  #                      # pattern = Group,
  #                    pattern_angle = Group,
  #                    pattern_spacing = Group),
  #                colour = 'black',
  #                # fill = "white",
  #               pattern_fill    = 'white',
  #                pattern_spacing = 0.025) +
 labs(
       y = "Grammaticality Judgment Standard Score",  # Change axis label
       x = "Cluster"
      ) +
theme(
      axis.title.x = element_text(size=14, face="bold"),
      axis.title.y = element_text(size=14, face="bold"),
      axis.text=element_text(size=12, face = "bold")
      ) +
theme(legend.text=element_text(size=14, face="bold"),
      legend.title=element_text(size=15, face="bold")) +
theme(legend.text=element_text(size=14, face="bold"),
      legend.title=element_text(size=15, face="bold")) +
theme(
  panel.background = element_rect(fill = "white"),         # Set plot background to white
  legend.key  = element_rect(fill = "white"),              # Set legend item backgrounds to white
  axis.line.x = element_line(colour = "black", size = 1),  # Add line to x axis
  axis.line.y = element_line(colour = "black", size = 1),   # Add line to y axis
  panel.grid.minor = element_line(colour = "grey", size = 0.3),
  panel.grid.major = element_line(colour = "grey", size = 0.3)
)

library(ggbeeswarm)

clusterGJT$cluster <-
plyr::revalue(clusterGJT$cluster, c("4" = "1",
                                    "5" = "2",
                                    "1" = "3", 
                                    "3" = "4",
                                    "2" = "5"))

ggplot(data=clusterGJT, aes(x=cluster, y= gjt_std_score_gjt_web, fill = cluster)) +
  geom_bar(stat= "summary", fun.y = "mean", color ="black", width = 0.83)+
  # geom_beeswarm(
  #   aes(color = group),
  #   dodge.width = 1,
  #   cex = 2.5,
  #   size = 3,
  #   show.legend = FALSE
  # ) +
  geom_point(aes(color = group),
             position = position_dodge(1),
             size = 2.5) +
  scale_color_manual(values = c("#F8766d", "#00BFC4"),
                     guide = guide_legend(title="Group")) +
  scale_fill_manual(values= colorTemp,
                    labels = c("Low Accuracy in Lingusitic SL",
                                 "High Accuracy in Visual SL",
                                 "High Accuracy in  Syllable SL",
                                 "Low Accuracy in all SL",
                                 "High Accuracy in all SL"),
                    guide = guide_legend(title="Cluster based on \n SL accuracy",
                                        override.aes = list(shape = NA)
                                        )) +
  labs(
         y = "Grammaticality Judgment Standard Score",  # Change axis label
         x = "Cluster"
        ) + 
  theme(
        axis.title.x = element_text(size=14, face="bold"),
        axis.title.y = element_text(size=14, face="bold"),
        axis.text=element_text(size=12, face = "bold")
        ) +
  theme(legend.text=element_text(size=14, face="bold"),
        legend.title=element_text(size=15, face="bold")) +
  theme(legend.text=element_text(size=14, face="bold"),
        legend.title=element_text(size=15, face="bold")) +
  theme(
    panel.background = element_rect(fill = "white"),         # Set plot background to white
    legend.key  = element_rect(fill = "white"),              # Set legend item backgrounds to white
    axis.line.x = element_line(colour = "black", size = 1),  # Add line to x axis
    axis.line.y = element_line(colour = "black", size = 1),   # Add line to y axis
    panel.grid.minor = element_line(colour = "grey", size = 0.3),
    panel.grid.major = element_line(colour = "grey", size = 0.3)
  ) 

# ggsave("srcd_figure/k_means_five_clusters_gjt_across_groups.png",
       # bg="transparent",
       # width = 25, height = 20, units = "cm")
```

```{r, message = FALSE, eval = F}
subplot(p, p.legend, widths = c(0.9, 0.1), heights = 0.7, shareY = F)



# n in each cluster
clusterGJT[which(complete.cases(clusterGJT[,"a_prime"])),] %>%
  group_by(cluster) %>%
  summarise(n = n())

print(aprimeK_five)


# n in each cluster
clusterGJT[which(complete.cases(clusterGJT[,"gjt_std_score_gjt_web"])),] %>%
  group_by(cluster) %>%
  summarise(n = n())

print(gjtK_five)
```

# K-means with 4 clusters
```{r}
set.seed(321)
kclusterFour <- kmeans(completeSL[, 3:6], 4, nstart = 10)
print(kclusterFour)
# Plotting the Elbow method in clusters
```

K = 4
Cluster 1 (n = 13): better Letter(mean = 0.5914615) and Syllable SL (mean = 0.6418462)
Cluster 2 (n = 6): very good Image (mean =  0.9115) and Letter SL (mean = 0.8648333)
Cluster 3 (n = 6): Good? SL learning across tasks or poor Speech SL learner 
                    (Letter: 0.78, Syllable: 0.62, Image: 0.89, Tone SL: 0.79)
Cluster 4 (n = 22): Poor SL learners


**The order of the clusters may be different when the script is run. However, the cluster sizes are replicable.**

                    


# Plot K-means 4 clusters
```{r, include = F}
clusterPFour <- completeSL
clusterPFour$cluster <- kclusterFour$cluster
clusterPFour$cluster <- as.factor(clusterPFour$cluster)

colorTemp <- c("#999999", "#E69F00", "#56B4E9", "#009E73")

library(plotly)
p_four <-
  plot_ly(clusterPFour, 
             x = ~accuracy_children_lsl_accuracies, 
             y = ~accuracy_children_vsl_accuracies, 
             z = ~accuracy_children_tsl_accuracies, 
             mode = "markers", 
             color = ~cluster, 
             size = ~accuracy_children_ssl_accuracies, 
             marker = list(symbol = 'circle', sizemode = 'diameter'),
  colors = colorTemp,
  sizes = c(5, 100)) %>%
  layout(scene = list(xaxis = list(title = 'Letter'),
                      yaxis = list(title = 'Image'),
                      zaxis = list(title = 'Tone')))

legend.sizes = seq(5, 1, -1)

ax = list(zeroline = FALSE, showline = FALSE, showticklabels = FALSE, showgrid = FALSE, range = c(0,1))
mk = list(sizes= 1, sizemode="area", opacity=1, color = "black", line = list(color = "rgb(0, 0, 0, 1)"))

p.legend <- 
  plot_ly(x = 0.5, y = legend.sizes) %>%
  add_markers(size = legend.sizes, showlegend = F, marker = mk) %>%
  layout(xaxis = ax, yaxis = list(showgrid = FALSE, showticklabels = F))


# subplot(p, p.legend, widths = c(0.9, 0.1), heights = 0.6, shareY = F)

clusterGJTfour <- 
  merge(clusterPFour[,c("part_id", "group", "cluster")], 
      bucld_all_completed[c("part_id", "a_prime", "gjt_std_score_gjt_web")], all.x = T)

library(dplyr)



aprimeK_four <-
ggplot(data=clusterGJTfour, aes(x=cluster, y= a_prime,fill=cluster)) +
  geom_bar(stat= "summary", fun.y = "mean", color ="black")+
  coord_cartesian(ylim = c(0.5, 1.0))  +
  theme_minimal(base_size = 20) + 
  scale_fill_manual(values= colorTemp) +
   labs(
         y = "Grammaticality Judgment (A')"  # Change axis label
        ) 


gjtK_four <-
ggplot(data=clusterGJTfour, aes(x=cluster, y= gjt_std_score_gjt_web, fill=cluster)) +
  geom_bar(stat= "summary", fun.y = "mean", color ="black")+
  coord_cartesian(ylim = c(0, 120))  +
  theme_minimal(base_size = 20) + 
  scale_fill_manual(values= colorTemp) +
   labs(
         y = "Grammaticality Standard Score"  # Change axis label
        ) 
```


```{r, message = FALSE}
subplot(p_four, p.legend, widths = c(0.9, 0.1), heights = 0.6, shareY = F)

# n in each cluster
clusterGJTfour[which(complete.cases(clusterGJTfour[,"a_prime"])),] %>%
  group_by(cluster) %>%
  summarise(n = n())

print(aprimeK_four)


# n in each cluster
clusterGJTfour[which(complete.cases(clusterGJTfour[,"gjt_std_score_gjt_web"])),] %>%
  group_by(cluster) %>%
  summarise(n = n())

print(gjtK_four)
```

# Other methods to find optimal K in K-means
```{r}
## Average silhouette method
library(cluster)
k.max <- 8
data <- completeSL[,3:6]
sil <- rep(0, k.max)

### Compute the average silhouette width for 
### k = 2 to k = 8
for(i in 2:k.max){
  km.res <- kmeans(data, centers = i, nstart = 25)
  ss <- silhouette(km.res$cluster, dist(data))
  sil[i] <- mean(ss[, 3])
}

# Plot the  average silhouette width
plot(1:k.max, sil, type = "b", pch = 19, 
     frame = FALSE, xlab = "Number of clusters k")



fviz_nbclust(completeSL[,3:6], hcut, method = "silhouette",
             hc_method = "complete")

# Use NbClust Package
library("NbClust")
set.seed(123)
res.nb <- NbClust(completeSL[,3:6], distance = "euclidean",
                  min.nc = 2, max.nc = 10, 
                  method = "complete", index ="all") 

fviz_nbclust(res.nb) + theme_minimal()
```


# K-means of SL slope (TD + ASD, TD vs. ASD had different optimal clusters(TD: 2, 4, 10; ASD: 4, 10))
```{r}
complete_slope <- 
  bucld_all_completed[,
                      c(
                        "part_id",
                        "group",
                        "slope_children_lsl_indiv_rts_slope",
                        "slope_children_ssl_indiv_rts_slope",
                        "slope_children_vsl_indiv_rts_slope",
                        "slope_children_tsl_indiv_rts_slope"
                      )]

completeRow <- complete.cases(complete_slope)

completeSL <- complete_slope[completeRow,]

completeSL <- completeSL[which(completeSL$group == "TD"),]
# completeSL <- completeSL[which(completeSL$group == "ASD"),]
# completeSL <- completeSL



completeSL[,3:6] <- scale(completeSL[,3:6])

# determine the optimal number of clusters
## Elbow method for k-means clustering - optimal number of cluster is ?
set.seed(123)
### Compute and plot wss for k = 2 to k = 8
k.max <- 8 # Maximal number of clusters
data <- completeSL[,3:6]
wss <- sapply(1:k.max, 
              function(k){kmeans(data, k, nstart=10)$tot.withinss})

plot(1:k.max, wss,
     type="b", pch = 19, frame = FALSE, 
     xlab="Number of clusters K",
     ylab="Total within-clusters sum of squares") 

### alternatively,
library(factoextra)
fviz_nbclust(completeSL[,3:6], kmeans, method = "wss") 


## Average silhouette method
library(cluster)
k.max <- 8
data <- completeSL[,3:6]
sil <- rep(0, k.max)

### Compute the average silhouette width for 
### k = 2 to k = 8
for(i in 2:k.max){
  km.res <- kmeans(data, centers = i, nstart = 25)
  ss <- silhouette(km.res$cluster, dist(data))
  sil[i] <- mean(ss[, 3])
}

# Plot the  average silhouette width
plot(1:k.max, sil, type = "b", pch = 19, 
     frame = FALSE, xlab = "Number of clusters k")



fviz_nbclust(completeSL[,3:6], hcut, method = "silhouette",
             hc_method = "complete")

# Use NbClust Package
library("NbClust")
set.seed(123)
res.nb <- NbClust(completeSL[,3:6], distance = "euclidean",
                  min.nc = 2, max.nc = 10, 
                  method = "complete", index ="all") 

fviz_nbclust(res.nb) + theme_minimal()
```


